<dom-module id="platform-connect">
    <template>
        <style>
            :host {
                display: block;
            }

            h1.title {
                @apply(--header);
            }
            h2.subtitle {
                @apply(--subtitle);
            }

            .import {
                margin-top: 2vw;
            }
            .export {
                margin-top: 2vw;
            }
            .authenticate {
                @apply(--layout-horizontal);
                @apply(--layout-center);
                @apply(--layout-justified);
            }
            .authenticate div a img {
                width: 12vw;
                height: 3.2vw;
            }
            .authenticate div button {
                margin: 2vw auto;
            }

            [data-toggle="on"] .disconnected {
                display: none;
            }

            [data-toggle="off"] .connected {
                display: none;
            }
            .clickable {
                cursor: pointer;
            }
        </style>
        <h1 class="title">Stryd Connect</h1>
        <div class="import">
            <h2 class="subtitle">Imports From</h2>
            <div class="authenticate">
                <div>
                    <a href="https://www.garmin.com">
                        <img class="logo" src="/profile/images/logo_garmin.png"/>
                    </a>
                    <button is="stryd-button" class="clickable" connect="garmin" on-click="oauthConnect">Connect?</button>
                </div>
            </div>
        </div>
        <div class="export">
            <h2 class="subtitle">Exports To</h2>
            <div class="authenticate">
                <div>
                    <a href="https://www.strava.com">
                        <img class="logo" src="/profile/images/logo_strava.png"/>
                    </a>
                    <button is="stryd-button" class="clickable" connect="strava" on-click="oauthConnect">Connect?</button>
                </div>
                <div>
                    <a href="https://www.trainingpeaks.com">
                        <img class="logo" src="/profile/images/logo_tp.png"/>
                    </a>
                    <button is="stryd-button" class="clickable" connect="trainingpeaks" on-click="oauthConnect">Connect?</button>
                </div>
                <div>
                    <a href="https://www.2peak.com">
                        <img class="logo" src="/profile/images/logo_2peak.png"/>
                    </a>
                    <button is="stryd-button" class="clickable" connect="2peak" on-click="oauthConnect">Connect?</button>
                </div>
            </div>
        </div>
    </template>
    <script>
        /*global superagent */
        /*global jwt */
        /*jshint unused: false*/
        /*jshint camelcase: false */
        (function () {
            Polymer({
                is: 'platform-connect',
                properties: {
                },
                ready: function() {
                    this.update();
                },
                oauthConnect: function (e) {
                    var platform = e.target.getAttribute('connect');
                    superagent
                            .get('/b/platform/oauth/' + platform)
                            .send()
                            .set('Accept', 'application/json')
                            .set('Authorization', 'Bearer: ' + jwt.token)
                            .end(function (err, res) {
                                if (res.ok) {
                                    window.location = res.body.redirect_url;
                                }
                            });
                },
                update: function () {
                    if (jwt.data.id) {
                        superagent
                                .get('/b/internal/platforms')
                                .send()
                                .set('Accept', 'application/json')
                                .set('Authorization', 'Bearer: ' + jwt.token)
                                .end(function(err, res) {
                                    if (res.ok) {
                                        this.updateView(res.body);
                                    }
                                }.bind(this));
                    }
                },
                updateView: function (platforms) {
                    var platform, i;
                    for (i = 0; i < platforms.length; i++) {
                        platform = platforms[i];
                        if (platform.status && platform.platform in this.$) {
                            this.$[platform.platform].dataset.toggle = 'on';
                        }
                    }
                }
            });
        })();
    </script>

</dom-module>
