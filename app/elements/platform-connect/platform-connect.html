<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">

<dom-module id="platform-connect">
  <style>
    :host {
      display: block;
    }

    .panel {
      overflow: auto;
    }

    .authenticate {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      padding: 2%;
    }

    .authenticate .status {
      @apply(--layout-flex-1);
      font-size: 24px;
    }

    .authenticate .action {
      @apply(--layout-flex-1);
    }

    paper-button.connect {
      color: #fff;
      background-color: var(--paper-green-500);
      --paper-button-flat-focus-color: var(--paper-green-50);
    }

    paper-button.disconnect {
      color: var(--paper-red-500);
      --paper-button-flat-focus-color: var(--paper-red-50);
    }

    [data-toggle="on"] .disconnected {
      display: none;
    }

    .hidden {
      display: none;
    }

    [data-toggle="off"] .connected {
      display: none;
    }
  </style>
  <template>
    <section class="panel paper-font-body1">
      <div class="authenticate" data-platform="garmin" data-toggle="off">
        <div class="status">
          <div class="connected">Connected with Garmin</div>
          <div class="disconnected">Not connected with Garmin</div>
        </div>
        <div class="action">
          <paper-button raised class="connect" connect="garmin" on-click="oauthConnect">Connect</paper-button>
          <a href="/b/platform/oauth/garmin/disconnect" class="btn btn-danger connected hidden">Disconnect</a>
        </div>
      </div>
      <!--<div class="authenticate" data-platform="strava" data-toggle="off">-->
        <!--<div class="status">-->
          <!--<div class="connected">Connected with Strava</div>-->
          <!--<div class="disconnected">Not connected with Strava</div>-->
        <!--</div>-->
        <!--<div class="action">-->
          <!--<a href="/b/platform/oauth/strava" class="btn btn-success disconnected">Connect</a>-->
          <!--<a href="/b/platform/oauth/strava/disconnect" class="btn btn-danger connected hidden">Disconnect</a>-->
        <!--</div>-->
      <!--</div>-->
      <div class="authenticate" id="trainingpeaks" data-toggle="off">
        <div class="status">
          <div class="connected">Connected with Training Peaks</div>
          <div class="disconnected">Not connected with Training Peaks</div>
        </div>
        <div class="action">
          <paper-button raised class="connect" connect="trainingpeaks" on-click="oauthConnect">Connect</paper-button>
          <a href="/b/platform/oauth/trainingpeaks/disconnect" class="connected hidden">
            <paper-button class="disconnect">Disconnect</paper-button>
          </a>
        </div>
      </div>
    </section>
  </template>
  <script src="//cdnjs.cloudflare.com/ajax/libs/superagent/0.15.7/superagent.min.js"></script>
  <script src="../../scripts/jwt.js"></script>
  <script>
    /*global superagent */
    /*global jwt */
    /*jshint unused: false*/
    /*jshint camelcase: false */
    (function () {
      Polymer({
        is: 'platform-connect',
        properties: {
        },
        ready: function() {
          this.update();
        },
        oauthConnect: function (e) {
          var platform = e.target.dataHost.getAttribute('connect');
          superagent
            .get('/b/platform/oauth/' + platform)
            .send()
            .set('Accept', 'application/json')
            .set('Authorization', 'Bearer: ' + jwt.token)
            .end(function (err, res) {
              if (res.ok) {
                window.location = res.body.redirect_url;
              }
            });
        },
        update: function () {
          superagent
            .get('/b/v1/users/' + jwt.data.id + '/platforms')
            .send()
            .set('Accept', 'application/json')
            .set('Authorization', 'Bearer: ' + jwt.token)
            .end(function(err, res) {
              if (res.ok) {
                this.updateView(res.body);
              }
            }.bind(this));
        },
        updateView: function (platforms) {
          var platform;
          console.log(this.$);
          for (var i = 0; i < platforms.length; i++) {
            platform = platforms[i];

            if (!platform.status && platform.platform in this.$) {
              this.$[platform.platform].dataset.toggle = 'off';
            } 
          }
        }
      });
    })();
  </script>

</dom-module>
