<dom-module id="platform-connect">
    <template>
        <style>
            :host {
                display: block;
            }

            h1.title {
                @apply(--header);
            }
            h2.subtitle {
                @apply(--subtitle);
            }

            .import {
                margin-top: 2vw;
            }
            .export {
                margin-top: 2vw;
            }
            .authenticate {
                @apply(--layout-horizontal);
                @apply(--layout-center);
                @apply(--layout-justified);
            }
            .authenticate div button {
                margin: 2vw auto;
                font-weight: 700;
                text-transform: uppercase;
            }

            .authenticate div button[data-toggle="on"] {
                border-color: var(--warning-color);
                color: var(--warning-color);
            }
            .authenticate div button[data-toggle="off"] {
            }

        </style>
        <h1 class="title">Stryd Connect</h1>
        <div class="import">
            <h2 class="subtitle">Imports From</h2>
            <div class="authenticate">
                <div>
                    <a href="https://www.garmin.com">
                        <img class="logo" src="/profile/images/logo_garmin.png" width="180px" height="42px"/>
                    </a>
                    <button is="stryd-button" data-toggle="off" id="garmin" on-click="oauthConnect">Connect</button>
                </div>
            </div>
        </div>
        <div class="export">
            <h2 class="subtitle">Exports To</h2>
            <div class="authenticate">
                <div>
                    <a href="https://www.trainingpeaks.com">
                        <img class="logo" src="/profile/images/logo_tp.png" width="180px" height="42px"/>
                    </a>
                    <button is="stryd-button" data-toggle="off" id="trainingpeaks" on-click="oauthConnect">Connect</button>
                </div>
                <div>
                    <a href="https://www.strava.com">
                        <img class="logo" src="/profile/images/logo_strava.png" width="180px" height="42px"/>
                    </a>
                    <button is="stryd-button" data-toggle="off" id="strava" on-click="oauthConnect">Connect</button>
                </div>
                <div>
                    <a href="https://www.2peak.com">
                        <img class="logo" src="/profile/images/logo_2peak.png" width="180px" height="42px"/>
                    </a>
                    <button is="stryd-button" data-toggle="off" id="2peak" on-click="oauthConnect">Connect</button>
                </div>
            </div>
        </div>
    </template>
    <script>
        /*global superagent */
        /*global jwt */
        /*jshint unused: false*/
        /*jshint camelcase: false */
        (function () {
            Polymer({
                is: 'platform-connect',
                properties: {
                },
                ready: function() {
                    this.update();
                },
                oauthConnect: function (e) {
                    var platform = e.target.getAttribute('id');
                    if (this.$[platform].dataset.toggle === 'on') {
                        var ele = this.$[platform];
                        superagent
                                .del('/b/platform/oauth/' + platform)
                                .send()
                                .set('Accept', 'application/json')
                                .set('Authorization', 'Bearer: ' + jwt.token)
                                .end(function (err, res) {
                                    console.log(res);
                                    if (res.ok) {
                                        ele.dataset.toggle = 'off';
                                        ele.firstChild.textContent = 'Connect';
                                    }
                                });

                    } else {
                        superagent
                                .get('/b/platform/oauth/' + platform)
                                .send()
                                .set('Accept', 'application/json')
                                .set('Authorization', 'Bearer: ' + jwt.token)
                                .end(function (err, res) {
                                    if (res.ok) {
                                        window.location = res.body.redirect_url;
                                    }
                                });
                    }
                },
                update: function () {
                    if (jwt.data.id) {
                        superagent
                                .get('/b/internal/platforms')
                                .send()
                                .set('Accept', 'application/json')
                                .set('Authorization', 'Bearer: ' + jwt.token)
                                .end(function(err, res) {
                                    if (res.ok) {
                                        this.updateView(res.body);
                                    }
                                }.bind(this));
                    }
                },
                updateView: function (platforms) {
                    var platform, i;
                    for (i = 0; i < platforms.length; i++) {
                        platform = platforms[i];
                        if (platform.status && platform.platform in this.$) {
                            this.$[platform.platform].dataset.toggle = 'on';
                            this.$[platform.platform].textContent = 'Disconnect';
                        } else {
                            this.$[platform.platform].dataset.toggle = 'off';
                            this.$[platform.platform].textContent = 'Connect';
                        }
                    }
                }
            });
        })();
    </script>

</dom-module>
