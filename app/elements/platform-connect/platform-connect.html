<dom-module id="platform-connect">
  <link rel="import" href="../../bower_components/paper-button/paper-button.html">
  <link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
  <link rel="import" href="../../styles/app-theme.html">
  <style>
    :host {
      display: block;
    }

    h1.title {
      @apply(--header);
    }

    .authenticate {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      padding: 2%;
    }

    .authenticate .status {
      @apply(--layout-flex-1);
      font-size: 24px;
    }

    .authenticate .action {
      @apply(--layout-flex-1);
    }

    [data-toggle="on"] .disconnected {
      display: none;
    }

    .hidden {
      display: none;
    }

    [data-toggle="off"] .connected {
      display: none;
    }

    .table {
      @apply(--layout-vertical);
      text-transform: uppercase;
      font-weight: 700;
    }
    .table a {
      text-decoration: none;
      color: white;
    }
    .table .td {
      @apply(--layout-flex);
    }
    .thead {
      color: var(--primary-header-color);
      font-size: 10px;
      @apply(--layout-horizontal);
      padding: 20px 0;
    }
    .tbody {
      color: white;
      font-size: 12px;
      @apply(--layout-horizontal);
      border-top: 1px solid rgba(255, 255, 255, 0.5);
      padding: 20px 0;
    }
    .table .connected {
      color: #57EC48;
    }
    .table .disconnected {
      color: #C34838;
    }
    .clickable {
      cursor: pointer;
    }
  </style>
  <template>
    <h1 class="title">Applications</h1>
    <div class="table">
      <div class="thead">
        <div class="td">Application</div>
        <div class="td">Link</div>
        <div class="td">Status</div>
        <div class="td"></div>
      </div>
      <div class="tbody" data-toggle="off" id="garmin">
        <div class="td">Garmin</div>
        <div class="td">
          <a href="https://www.garmin.com">www.garmin.com</a>
        </div>
        <div class="td connected">
          Connected
        </div>
        <div class="td disconnected">
          Disconnected
        </div>
        <div class="td disonnected clickable" connect="garmin" on-click="oauthConnect">Connect?</div>
        <div class="td connected clickable">Disconnect?</div>
      </div>
      <div class="tbody" data-toggle="off" id="strava">
        <div class="td">Strava</div>
        <div class="td">
          <a href="https://www.strava.com">www.strava.com</a>
        </div>
        <div class="td connected">
          Connected
        </div>
        <div class="td disconnected">
          Disconnected
        </div>
        <div class="td disonnected clickable" connect="strava" on-click="oauthConnect">Connect?</div>
        <div class="td connected clickable">Disconnect?</div>
      </div>
      <div class="tbody" data-toggle="off" id="trainingpeaks">
        <div class="td">Training Peaks</div>
        <div class="td">
          <a href="https://www.trainingpeaks.com">www.trainingpeaks.com</a>
        </div>
        <div class="connected td">
          Connected
        </div>
        <div class="disconnected td">
          Disconnected
        </div>
        <div class="disonnected td clickable" connect="trainingpeaks" on-click="oauthConnect">Connect?</div>
        <div class="td connected clickable">Disconnect?</div>
      </div>
    </div>
  </template>
  <script>
    /*global superagent */
    /*global jwt */
    /*jshint unused: false*/
    /*jshint camelcase: false */
    (function () {
      Polymer({
        is: 'platform-connect',
        properties: {
        },
        ready: function() {
          this.update();
        },
        oauthConnect: function (e) {
          var platform = e.target.getAttribute('connect');
          superagent
            .get('/b/platform/oauth/' + platform)
            .send()
            .set('Accept', 'application/json')
            .set('Authorization', 'Bearer: ' + jwt.token)
            .end(function (err, res) {
              if (res.ok) {
                window.location = res.body.redirect_url;
              }
            });
        },
        update: function () {
          if (jwt.data.id) {
            superagent
              .get('/b/internal/platforms')
              .send()
              .set('Accept', 'application/json')
              .set('Authorization', 'Bearer: ' + jwt.token)
              .end(function(err, res) {
                if (res.ok) {
                  this.updateView(res.body);
                }
              }.bind(this));
            }
        },
        updateView: function (platforms) {
          var platform, i;
          for (i = 0; i < platforms.length; i++) {
            platform = platforms[i];
            if (platform.status && platform.platform in this.$) {
              this.$[platform.platform].dataset.toggle = 'on';
            } 
          }
        }
      });
    })();
  </script>

</dom-module>
