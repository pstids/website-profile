<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../stryd-button/stryd-button.html">

<dom-module id="training-plan-info">
	<template>
		<style include="iron-flex">
			:host {
				@apply --layout-vertical;
				padding-bottom: 15%;
			}
			h1.title {
				color: white;
				margin-left: 0;
				font-size: 32px;
			}
			p {
				color: white;
			}
			button {
				margin-right: 15px;
			}
		</style>
		<template is="dom-if" if="{{plan_available}}">
			<h1 class="title">{{plan_title}}</h1>
			<p><b>Starts on:</b> <span>{{plan_start}}</span></p>
			<p><b>Ends on:</b> <span>{{plan_end}}</span></p>
			<p>{{plan_description}}</p>
			<div class="layout horizontal">
				<stryd-button on-click="viewPlan">View Plan</stryd-button>
				<stryd-button on-click="leavePlan">Leave Plan</stryd-button>
				<stryd-button on-click="viewPlans">Change Plan</stryd-button>
			</div>
		</template>
		<template is="dom-if" if="{{!plan_available}}">
			<h1 class="title">Get a Stryd Training Plan</h1>
			<div class="layout horizontal">
				<stryd-button on-click="viewPlans">View Plans</stryd-button>
			</div>
		</template>
		<paper-dialog id="leavePlanDialog">
			<h1>Are you sure you want to leave this plan? Your completed workouts will be unaffected.</h1>
			<div class="buttons">
				<paper-button dialog-dismiss>No</paper-button>
				<paper-button autofocus on-click="leavePlanConfirm">Yes</paper-button>
			</div>
		</paper-dialog>
	</template>
	<script>
	class TrainingPlanInfo extends Polymer.Element {
		static get is() { return 'training-plan-info'; }

		static get properties() {
			return {
				plan_available: Boolean,
				plan_description: String,
				plan_end: String,
				plan_start: String,
				plan_title: String,
			};
		}

		ready() {
			super.ready();
			this.plan_available = false;
			this.getPlan();
			window.setTimeout(this.getPlan.bind(this), 3000);
		}
		getPlan() {
			if (trainingPlan && trainingPlan.hasPlan) {
				this.plan_available = true;
				this.plan_title = trainingPlan.plan.name;
				this.plan_start = trainingPlan.targetDate.format('MMMM Do YYYY');
				this.plan_end = trainingPlan.targetDate.clone().add(trainingPlan.plan.week_duration, 'weeks').format('MMMM Do YYYY');
				this.plan_description = trainingPlan.plan.description;
			}
		}
		viewPlan() {
			page.redirect('/analysis');
		}
		leavePlan() {
			this.$.leavePlanDialog.open();
		}
		leavePlanConfirm() {
			superagent
				.del(`/b/api/v1/users/plan`)
				.set('Accept', 'application/json')
				.set('Authorization', `Bearer: ${jwt.token}`)
				.end((err, res) => {
					if (res !== undefined && res.ok && res.body !== null) {
						this.plan_available = false;
						window.location.reload();
					} else {
						console.log('Error: failure to set training plan', err);
					}
				});
		}
		viewPlans() {
			document.location = 'https://www.stryd.com#section-coaching';
		}
	}
	window.customElements.define(TrainingPlanInfo.is, TrainingPlanInfo);
	</script>
</dom-module>