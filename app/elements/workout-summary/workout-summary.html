<dom-module id="workout-summary">
	<style>
		:host {
			@apply(--layout-vertical);
			border: 1px solid #4D4D4D;
			flex: 3;
			margin: 20px;
		}
		.rss-container {
			margin: 0 50px;
			display: flex;
			justify-content: center;
			align-items: center;
			flex-direction: row;
		}
		.rss {
			width: 160px;
			height: 160px;
			border-radius: 50%;
			border: 1px solid orange;
			display: flex;
			justify-content: center;
			align-items: center;
			flex-direction: row;
		}
		.rss h1 {
			font-size: 32px;
			margin-right: 5px;
		}
		.rss span {
			color: white;
		}
		.top {
			background-color: #222222;
			border-bottom: 1px solid #4D4D4D;
			height: 70px;
		}
		.title {
			@apply(--layout-horizontal);
			@apply(--layout-flex);
		}
		.accent {
			font-weight: 100;
		}
		.raindrop {
			flex: 0 1;
			border-left: 1px solid #4D4D4D;
			@apply(--layout);
			@apply(--layout-end-justified);
			align-items: center;
			justify-content: center;
			cursor: pointer;
		}
		.raindrop iron-icon {
			width: 34px;
			height: 34px;
			fill: orange;
			padding: 0 20px;
		}
		.stats {
			padding: 20px;
		}
		.stats h2 {
			margin: 0;
			color: white;
			font-size: 30px;
		}
		.stats h2 .unit {
			margin-top: 10px;
			font-size: 16px;
		}
		.stats .sub {
			color: #A4A4A4;
		}
		.stats .stat {
			@apply(--layout-flex);
		}
		.values {
			@apply(--layout-flex);
		}
		.values .value {
			@apply(--layout-flex);
			justify-content: center;
			align-items: center;
		}
		.tiz-container {
			margin: 0 50px;
		}
	</style>
	<template>
		<div class="layout horizontal top">
			<div class="title">
				<h1 class="bold">{{data.date}}</h1>
				<h1 class="accent hidden">{{data.type}}</h1>
			</div>
			<div class="raindrop hidden">
				<iron-icon icon="icons:arrow-drop-down-circle"></iron-icon>
			</div>
		</div>
		<div class="layout horizontal stats">
			<div class="layout horizontal stat">
				<div class="layout vertical values">
					<div class="layout vertical value">
						<h2><span class="value">{{data.rss}}</span></h2>
						<span class="sub">RSS</span>
					</div>
					<div class="layout vertical value">
						<h2><span class="value">{{data.duration}}</span> <span class="unit"></span></h2>
						<span class="sub">Time</span>
					</div>
				</div>
				<div class="layout vertical values">
					<div class="layout vertical value">
						<h2><span class="value">{{data.pace}}</span><span class="unit">{{data.pace_unit}}</span></h2>
						<span class="sub">Pace</span>
					</div>
					<div class="layout vertical value">
						<h2><span class="value">{{data.distance}}</span> <span class="unit">{{data.distance_unit}}</span></h2>
						<span class="sub">Distance</span>
					</div>
				</div>
			</div>
			<div class="layout tiz-container">
				<svg id="tiz232"></svg>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'workout-summary',
			properties: {
				data: Object
			},
			attached: function () {
				this.data = {
					type: 'Interval Run',
					date: 'Jan 1st, 2017',
					rss: '--',
					duration: '--:--:--',
					pace: '--:--',
					distance: '--',
					distance_unit: 'mi',
					pace_unit: '/mi'
				};
			},
			setData: function (activity) {
				this.data.date = moment(activity.start_time*1000).format('MMM Do, YYYY');
				this.notifyPath('data.date');
				this.data.rss = activity.stress.toFixed(0);
				this.notifyPath('data.rss');
				this.data.duration = secToDurationFull(activity.elapsed_time);
				this.notifyPath('data.duration');
				this.data.pace = speedToPace(activity.average_speed, user.data.units);
				this.notifyPath('data.pace');
				this.data.distance = meterToMile(activity.distance, 0);
				this.notifyPath('data.distance');
				this.tiz(activity.seconds_in_zones);
			},
			tiz: function (zones) {
				var data = [];
				var total = zones.reduce((a, b) => {
					return a + b;
				}, 0);
				for (var i = 0; i < zones.length; i++) {
					var tiz = zones[i];
					data.push({
						zone: i+1,
						tiz: tiz,
						percentage: tiz/total
					});
				}
				var width = 230, height = 230, radius = 110;
				var color = d3.scale.ordinal().range(['#fce9d2', '#fad3a5', '#f8be78', '#f6a84b', '#f4931f']);
				var arc = d3.svg.arc()
					.outerRadius(radius-40)
					.innerRadius(0);
				var labelArc = d3.svg.arc()
					.outerRadius(radius-20)
					.innerRadius(radius-20);
				var pie = d3.layout.pie()
					.sort(null)
					.value((d) => {
						return d.tiz;
					});
				d3.select('#tiz232')
					.selectAll('*')
					.remove();
				var svg = d3.select('#tiz232')
					.attr('width', width)
					.attr('height', height)
					.append('g')
						.attr('transform', `translate(${radius}, ${radius})`);
				var g = svg.selectAll('.arc')
					.data(pie(data))
					.enter()
					.append('g')
						.attr('class', 'arc');
				g.append('path')
					.attr('d', arc)
					.style('fill', (d) => {
						return color(d.data.zone);
					});
				g.append('text')
					.attr('transform', (d) => {
						return `translate(${labelArc.centroid(d)})`;
					})
					.attr('dy', '.35em')
					.text((d) => {
						if (d.data.percentage * 100 < 1) {
							return '';
						}
						return `Zone ${d.data.zone}`;
					});
				g.append('text')
					.attr('transform', (d) => {
						return `translate(${labelArc.centroid(d)})`;
					})
					.attr('dy', '1.35em')
					.text((d) => {
						if (d.data.percentage * 100 < 1) {
							return '';
						}
						var percentage = (d.data.percentage * 100).toFixed(2);
						return `(${percentage}%)`;
					});
			}
		});
	</script>
</dom-module>