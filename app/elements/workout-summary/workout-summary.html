<dom-module id="workout-summary">
	<style>
		:host {
			@apply(--layout-vertical);
			border: 1px solid #4D4D4D;
			flex: 3;
			margin: 20px;
		}
		.rss-container {
			margin: 0 50px;
			display: flex;
			justify-content: center;
			align-items: center;
			flex-direction: row;
		}
		.rss {
			width: 160px;
			height: 160px;
			border-radius: 50%;
			border: 1px solid orange;
			display: flex;
			justify-content: center;
			align-items: center;
			flex-direction: row;
		}
		.rss h1 {
			font-size: 32px;
			margin-right: 5px;
		}
		.rss span {
			color: white;
		}
		.top {
			background-color: #222222;
			border-bottom: 1px solid #4D4D4D;
			height: 70px;
		}
		.title {
			@apply(--layout-horizontal);
			@apply(--layout-flex);
		}
		.accent {
			font-weight: 100;
		}
		.raindrop {
			flex: 0 1;
			border-left: 1px solid #4D4D4D;
			@apply(--layout);
			@apply(--layout-end-justified);
			align-items: center;
			justify-content: center;
			cursor: pointer;
		}
		.raindrop iron-icon {
			width: 34px;
			height: 34px;
			fill: orange;
			padding: 0 20px;
		}
		.stats {
			padding: 20px;
		}
		.stats h2 {
			margin: 0;
			color: white;
			font-size: 30px;
		}
		.stats h2 .unit {
			margin-top: 10px;
			font-size: 16px;
		}
		.stats .sub {
			color: #A4A4A4;
		}
		.stats .stat {
			@apply(--layout-flex);
		}
		.values {
			@apply(--layout-flex);
		}
		.values .value {
			@apply(--layout-flex);
			justify-content: center;
			align-items: center;
		}
		.tiz-container {
			width: 330px;
			margin: 0 50px;
		}
		#messageContainer {
			width: 230px;
		}

		paper-input input {
			text-align: center !important;
		}

		paper-dropdown-menu.test-selector {
			--paper-input-container-label: {
				color: white;
				font-weight: bold;
			};
			--paper-input-container-input: {
				color: white;
				font-style: normal;
			};
			/* no underline */
			--paper-input-container-underline: {
				color: white;
			};
		}

		paper-icon-button {
			color: white;
		}
	</style>
	<template>
		<div class="layout horizontal top">
			<div class="title">
				<h1 class="bold">{{data.date}}</h1>
				<h1 class="accent hidden">{{data.type}}</h1>
			</div>
			<div class="raindrop hidden" on-click="recalculate">
				<iron-icon icon="icons:autorenew"></iron-icon>
			</div>
		</div>
		<div class="layout horizontal stats">
			<div class="layout horizontal stat">
				<div class="layout vertical values">
					<div class="layout vertical value">
						<h2><span class="value">{{data.rss}}</span></h2>
						<span class="sub">{{data.rss_message}}</span>
					</div>
					<div class="layout vertical value">
						<h2><span class="value">{{data.duration}}</span> <span class="unit"></span></h2>
						<span class="sub">Time</span>
					</div>
				</div>
				<div class="layout vertical values">
					<div class="layout vertical value">
						<h2><span class="value">{{data.pace}}</span><span class="unit">{{data.pace_unit}}</span></h2>
						<span class="sub">Pace</span>
					</div>
					<div class="layout vertical value">
						<h2><span class="value">{{data.distance}}</span> <span class="unit">{{data.distance_unit}}</span></h2>
						<span class="sub">Distance</span>
					</div>
				</div>
			</div>
			<div class="layout tiz-container" id="tizContainer">
				<svg id="tiz232"></svg>
			</div>
			<div class="flex layout vertical center center-justified">
				<paper-dropdown-menu class="test-selector" label="Workout Type" style="margin-bottom: 50px;">
					<paper-menu class="dropdown-content" selected="{{selected_type}}" id="workoutType">
						<paper-item>None</paper-item>
						<paper-item>Easy Run</paper-item>
						<paper-item>Long Run</paper-item>
						<paper-item>Fartlek Run</paper-item>
						<paper-item>Threshold Run</paper-item>
						<paper-item>Cruise Interval</paper-item>
						<paper-item>Interval</paper-item>
						<paper-item>Tempo Run</paper-item>
						<paper-item>Repetion Run</paper-item>
						<paper-item>Race Pace Training</paper-item>
						<paper-item>Race</paper-item>
						<paper-item>Critical Test Run</paper-item>
					</paper-menu>
				</paper-dropdown-menu>
				<paper-dropdown-menu class="test-selector" label="Post Run RPE">
					<paper-menu class="dropdown-content" selected="{{selected_rpe}}" id="workoutRPE">
						<paper-item>None</paper-item>
						<paper-item>RPE 1</paper-item>
						<paper-item>RPE 2</paper-item>
						<paper-item>RPE 3</paper-item>
						<paper-item>RPE 4</paper-item>
						<paper-item>RPE 5</paper-item>
						<paper-item>RPE 6</paper-item>
						<paper-item>RPE 7</paper-item>
						<paper-item>RPE 8</paper-item>
						<paper-item>RPE 9</paper-item>
						<paper-item>RPE 10</paper-item>
					</paper-menu>
				</paper-dropdown-menu>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'workout-summary',
			properties: {
				data: Object
			},
			recalculate: function () {
                if ('id' in this.activity) {
                    app.logOption.callRecalculate(this.activity.id);
                }
			},
			ready: function () {
				this.selected_rpe = 0;
				this.selected_type = 0;
				this.hasWorkout = false;
				this.rpes = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
				this.types = ['', 'easy', 'long', 'fartlek', 'threshold', 'cruise interval', 'interval', 'tempo', 'repetition', 'pace', 'race', 'critical test'];
			},
			attached: function () {
				this.data = {
					type: 'Interval Run',
					date: 'Jan 1st, 2017',
					rss: '--',
					duration: '--:--:--',
					pace: '--:--',
					distance: '--',
					distance_unit: 'mi',
					pace_unit: '/mi',
					rss_message: 'RSS'
				};

				this.$.workoutRPE.addEventListener('iron-select', () => {
					var item = this.rpes[this.$.workoutRPE.selected];
					if ('activity' in this) {
						app.updateWorkout(
							this.activity.id,
							{
								rpe: item
							},
							null
						);
					}
				});
				this.$.workoutType.addEventListener('iron-select', () => {
					var item = this.types[this.$.workoutType.selected];
					if ('activity' in this) {
						app.updateWorkout(
							this.activity.id,
							{
								type: item
							},
							null
						);
					}
				});
			},
			setData: function (activity) {
				this.hasWorkout = true;
				this.activity = activity;
				this.data.date = moment(activity.start_time*1000).format('MMM Do, YYYY');
				this.notifyPath('data.date');

				this.data.rss = activity.average_power.toFixed(0);
				this.data.rss_message = 'Avg Power';
				this.notifyPath('data.rss');
				this.notifyPath('data.rss_message');

				this.data.duration = secToDurationFull(activity.elapsed_time);
				this.notifyPath('data.duration');

				this.data.pace = speedToPace(activity.average_speed, user.data.units);
				this.notifyPath('data.pace');

				this.data.distance = meterToMile(activity.distance, 0);
				this.notifyPath('data.distance');

				this.tiz(activity.seconds_in_zones, activity.stress);

				this.selected_rpe = this.rpes.indexOf(activity.rpe);
				this.selected_type = this.types.indexOf(activity.type);
			},
			tiz: function (zones, rss) {
				var data = [];
				var total = 0;
				if (zones !== null) {
					total = zones.reduce((a, b) => {
						return a + b;
					}, 0);
				}
				if (total === 0) {
					this.$.tizContainer.classList.add('hidden');
					return;
				} else {
					this.$.tizContainer.classList.remove('hidden');
				}
				for (var i = 0; i < zones.length; i++) {
					var tiz = zones[i];
					data.push({
						zone: i+1,
						tiz: tiz,
						percentage: tiz/total
					});
				}
				var width = 330, height = 230, radius = 110;
				var color = d3.scale.ordinal().range(['#fce9d2', '#fad3a5', '#f8be78', '#f6a84b', '#f4931f']);
				var arc = d3.svg.arc()
					.outerRadius(radius-40)
					.innerRadius(radius-60);
				var pie = d3.layout.pie()
					.sort(null)
					.value((d) => {
						return d.tiz;
					});
				d3.select('#tiz232')
					.selectAll('*')
					.remove();
				var svg = d3.select('#tiz232')
					.attr('width', width)
					.attr('height', height)
					.append('g')
						.attr('transform', `translate(${radius}, ${radius})`);
				var g = svg.selectAll('.arc')
					.data(pie(data))
					.enter()
					.append('g')
						.attr('class', 'arc');
				g.append('path')
					.attr('d', arc)
					.style('fill', (d) => {
						return color(d.data.zone);
					});
				g.append('rect')
					.attr('width', 20)
					.attr('height', 20)
					.attr('transform', (d) => {
						return `translate(${radius}, ${d.data.zone*25-radius+15})`;
					})
					.attr('fill', (d) => {
						return color(d.data.zone);
					});
				g.append('text')
					.attr('transform', (d) => {
						return `translate(${radius+25}, ${d.data.zone*25-radius+30})`;
					})
					.style('text-anchor', 'start')
					.attr('font-size', 16)
					.text((d) => {
						var percentage = (d.data.percentage * 100).toFixed(0);
						return `Z${d.data.zone} ${percentage}%`;
					});
				svg.append('text')
					.attr('x', 0)
					.attr('y', 0)
					.attr('font-size', 25)
					.attr('font-weight', '400')
					.attr('fill', '#FFFFFF')
					.style('text-anchor', 'middle')
					.text('RSS');
				svg.append('text')
					.attr('x', 0)
					.attr('y', 25)
					.attr('font-size', 25)
					.attr('font-weight', 'bolder')
					.attr('fill', '#FFFFFF')
					.style('text-anchor', 'middle')
					.text(rss.toFixed(0));
			}
		});
	</script>
</dom-module>