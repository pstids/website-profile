<dom-module id="user-info">
    <style>
        section {
            @apply(--layout-horizontal);
            @apply(--layout-justified);
        }
        h1.title {
            @apply(--header);
        }
        h2.subtitle {
            @apply(--subtitle);
        }
        .edit {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            @apply(--subtitle);
            -webkit-user-select: none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -ms-user-select: none;
        }
        iron-icon {
            width: 1.2vw;
            height: 1.2vw;
            padding-right: 0.5vw;
        }
        .icon-tag {
            width: 1.2vw;
            height: 1.3vw;
        }
        [option="display"] .editable {
            display: none;
        }
        [option="editable"] .display {
            display: none;
        }

        .image {
            @apply(--layout-vertical);
            @apply(--layout-center);
            @apply(--layout-center-justified);
            text-align: center;
            color: white;
            width: 12vw;
        }
        .image img {
            max-width: 100%;
            width: 100%;
            height: auto;
            border-radius: 50%;
            border: 6px solid #484846;
        }
        .image h1 {
            font-size: 26px;
            color: white;
            text-transform: uppercase;
            line-height: 48px;
            margin: 0;
            padding: 0;
        }

        .details {
            @apply(--layout-vertical);
            font-size: 1vw;
            width: 21vw;
        }
        .information {
            @apply(--layout-horizontal);
            padding: 0.6vw 0;
        }
        .information .info {
            text-transform: uppercase;
        }
        .information .info.big {
            @apply(--layout-flex-10);
        }
        .information .info.small {
            @apply(--layout-flex-5);
        }
        .information .info h1 {
            font-size: 0.67vw;
            color: var(--primary-header-color);
            margin: 0;
            padding: 0;
        }
        .information .info p {
            font-size: 1.67vw;
            margin: 0;
            padding: 0.5vw 0;
            color: white;
            font-weight: 700;
        }
        input[type=text] {
            background: transparent;
            border: none;
            border-bottom: 1px solid white;
            outline: none;
            padding: 0.5vw 0;
            color: white;
            width: 70%;
            font-size: 1.67vw;
        }
        input[type=text]:focus {
            border-bottom: 1px solid var(--primary-header-color);
        }
        .information #birthday-input input[type=text] {
            width: 25%;
        }
        .information #birthday-input .slash {
            font-size: 1.67vw;
            color: var(--primary-header-color);
        }
        select {
            border-radius: 10px;
            text-transform: uppercase;
            font-size: 1vw;
            color: white;
            background-color: rgba(0, 0, 0, 0);
            border: 1px solid white;
            padding: 1vw;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        *::-webkit-input-placeholder {
            color: grey;
            font-weight: 300;
        }
        *:-moz-placeholder {
            color: grey;
            font-weight: 300;
        }
        *::-moz-placeholder {
            color: grey;
            font-weight: 300;
        }
        *:-ms-input-placeholder {
            color: grey;
            font-weight: 300;
        }

        .about-me {
            width: 20vw;
        }
        .about-me p {
            font-weight: 300;
            font-size: 1vw;
            color: white;
            line-height: 1.8;
        }
        .about-me paper-textarea {
            font-weight: 300;
            font-size: 1vw;
            color: white;
            line-height: 1.8;
            min-height: 100%;
        }
        .prefs {
            margin-top: 40px;
        }
        .pref {
            @apply(--layout-vertical);
            margin-top: 2vw;
        }
        .prefs select {
            border-radius: 10px;
            text-transform: uppercase;
            font-size: 1vw;
            color: white;
            background-color: rgba(0, 0, 0, 0);
            border: 1px solid white;
            padding: 1vw;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .prefs button#save-pref {
            min-width: 20vw;
            margin: 2vw auto;
        }
    </style>
    <template>
        <section>
            <div class="image">
                <img src="{{userLocal.profileImg}}">
                <h1>{{userLocal.name}}</h1>
            </div>
           
            <div class="details" option="editable" id="details">
                <form id="information" is="iron-form">
                <h1 class="title">Details</h1>
                <div class="information">
                    <div class="info big">
                        <h1>Date of Birth (MM/DD/YY)</h1>
                        <div id="birthday-input">
                            <input type="text" placeholder="MM" class="editable" name="birth_month" value="{{userLocal.birth_month::input}}">
                            <span class="slash">/</span>
                            <input type="text" placeholder="DD" class="editable" name="birth_day" value="{{userLocal.birth_day::input}}">
                            <span class="slash">/</span>
                            <input type="text" placeholder="YY" class="editable" name="birth_year" value="{{userLocal.birth_year::input}}">
                        </div>
                    </div>
                    <div class="info small">
                        <h1>Age</h1>
                        <p>{{getAge(userLocal.birth_year, userLocal.birth_month, userLocal.birth_day)}}</p>
                    </div>
                </div>
                <div class="information">
                    <div class="info big">
                        <h1>Gender</h1>
                        <paper-radio-group 
                            selected="{{userLocal.gender}}"
                            attr-for-selected="name"
                            class="editable">
                            <paper-radio-button name="male">Male</paper-radio-button>
                            <paper-radio-button name="female">Female</paper-radio-button>
                            <paper-radio-button name="other">Other</paper-radio-button>
                        </paper-radio-group>
                    </div>
                    <div class="info small">
                        <h1>Height (<span>{{heightUnit(userLocal.units)}}</span>)</h1>
                        <input type="text"
                            placeholder="Height"
                            class="editable"
                            name="height"
                            id="height"
                            label="Height"
                            value="{{userLocal.height::input}}">
                    </div>
                </div>
                <div class="information">
                    <div class="info big">
                        <h1>Location</h1>
                        <input
                            type="text"
                            placeholder="City"
                            class="editable"
                            name="city"
                            value="{{userLocal.city::input}}"
                            label="City">
                        <input
                            type="text"
                            placeholder="State"
                            class="editable"
                            name="state"
                            value="{{userLocal.state::input}}"
                            label="State">
                    </div>
                    <div class="info small">
                        <h1>Weight (<span>{{weightUnit(userLocal.units)}}</span>)</h1>
                        <input type="text"
                            placeholder="Weight"
                            class="editable"
                            name="weight"
                            id="weight"
                            value="{{userLocal.weight::input}}"
                            >
                    </div>
                </div>
                </form>
            </div>
            
            <div class="about-me" option="editable" id="about">
                <h1 class="title">About Me</h1>
                <paper-textarea
                    class="editable"
                    label="Introduce yourself to the world"
                    char-counter
                    maxlength="200"
                    max-rows="5"
                    value="{{userLocal.about_me::change}}">
                </paper-textarea>
            </div>
        </section>
        <div class="prefs">
            <h1 class="title">Preferences</h1>
            <div class="pref">
                <h2 class="subtitle">Display</h2>
                <paper-radio-group
                    selected="{{userLocal.units}}"
                    attr-for-selected="name"
                    id="radio">
                    <paper-radio-button name="feet">Miles and Pounds</paper-radio-button>
                    <paper-radio-button name="meters">Kilometers and Kilograms</paper-radio-button>
                </paper-radio-group>
            </div>
            <button is="stryd-button" id="save-pref" on-click="saveDetails">Save</button>
        </div>
        <paper-toast duration="1300" text="" id="toast"></paper-toast>
    </template>
    <script src="//crypto-js.googlecode.com/svn/tags/3.0.2/build/rollups/md5.js"></script>
    <script>
        /*global CryptoJS*/
        Polymer({
            is: 'user-info',
            properties: {
                userLocal: {
                    type: Object,
                    notify: true
                }
            },
            jsonToQueryString: function (json) {
                return '?' + 
                    Object.keys(json).map(function(key) {
                        return encodeURIComponent(key) + '=' +
                            encodeURIComponent(json[key]);
                    }).join('&');
            },
            attached: function () {
                var aboutStr = user.data.about_me;
                if (!aboutStr) {
                    aboutStr = 'Running doesn’t require a gym, a playing field, an arena, or a court. It can be done pretty much anywhere in the world at any time.';
                }
                this.userLocal = {
                    birth_day: user.data.birth.day,
                    birth_month: user.data.birth.month,
                    birth_year: user.data.birth.year,
                    gender: user.data.gender,
                    height: user.data.height,
                    city: user.data.city,
                    state: user.data.state,
                    weight: user.data.weight,
                    name: user.data.user_name,
                    profileImg: this.setProfileIMG(),
                    about_me: aboutStr,
                    units: user.data.units,
                    age: this.getAge(
                        user.data.birth.year,
                        user.data.birth.month,
                        user.data.birth.day
                    )
                };
            },
            saveDetails: function () {
                var queryString = this.jsonToQueryString(this.userLocal);
                superagent
                    .put('/b/api/v1/users/' + jwt.data.id + queryString)
                    .send('{"empty":"empty"}')
                    .set('Accept', 'application/json')
                    .set('Authorization', 'Bearer: ' + jwt.token)
                    .end(function(err, res) {
                        if (res.ok) {
                            this.$.toast.text = 'Your information is updated!';
                            user.updateData(res.body);
                            this.attached();
                        } else {
                            this.$.toast.text = 'Your information is not updated. Please try again.';
                        }
                        this.$.toast.show();
                    }.bind(this));
            },
            setProfileIMG: function () {
                this.defaultURL = 'https://www.stryd.com/powercenter/images/leopard.png';
                if (user.data.profile !== '') {
                    return decodeURIComponent(user.data.profile.replace('+', ' '));
                } else {
                    var gravHash = CryptoJS.MD5(user.data.email.toLowerCase());
                    return 'http://www.gravatar.com/avatar/' + gravHash + '?d=' + this.defaultURL;
                }
            },
            weightUnit: function (unit) {
                if (unit === 'feet') {
                    return 'lbs';
                } else {
                    return 'kg';
                }
            },
            weightValue: function (value, unit) {
                if (unit === 'feet') {
                    var pounds = this.KGToPound(value);
                    return parseInt(pounds);
                } else {
                    return parseInt(value);
                }
            },
            heightUnit: function (unit) {
                if (unit === 'feet') {
                    return 'inches';
                } else {
                    return 'cm';
                }
            },
            heightValue: function (value, unit) {
                if (unit === 'feet') {
                    var totalInches = this.CMToInch(value);
                    var feet = totalInches / 12;
                    var fraction = feet - Math.floor(feet);
                    var inches = (12 * fraction).toFixed(0);
                    return parseInt(feet) + '\'' + parseInt(inches) + '"';
                } else {
                    return parseInt(value);
                }
            },
            getAge: function (year, month, day) {
                if (year === 0 && month === 0 && day === 0) {
                    return 0;
                }
                var today = new Date();
                var birth = new Date(
                    parseInt(year) + 1,
                    parseInt(month) - 1,
                    parseInt(day)
                );
                return today.getFullYear() - birth.getFullYear();
            },
            KGToPound: function (kg) {
                return Math.round(kg * 2.20462);
            },
            PoundToKG: function (pound) {
                return Math.round(pound / 2.20462);
            },
            CMToInch: function (cm) {
                return Math.round(cm / 2.54);
            },
            InchToCM: function (inch) {
                return Math.round(inch * 2.54);
            }
        });
    </script>
</dom-module>