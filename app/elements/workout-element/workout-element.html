<dom-module id="workout-element">
  <link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
  <link rel="import" href="../../styles/app-theme.html">
  <link rel="import" href="../bubble-stat/bubble-stat.html">
  <link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
  <style>
    section {
        @apply(--layout);
        @apply(--layout-vertical);
        background-color: var(--primary-background-color);
    }
    h2.subheader {
        text-transform: uppercase;
        color: #FFFFFF;
        font-size: 12px;
        margin: 0;
    }
    h1.header {
        @apply(--header);
    }
    .seperator {
        display: block;
        margin: 5px 0;
        height: 1px;
        border-top: 1px solid #5B5B5B;
    }
    .toggles {
        @apply(--layout-flex);
    }
    .chart {
        display: block;
        width: 100%;
        @apply(--layout-flex);
    }
    .summary {
        background-color: rgba(41, 41, 39, 0.9); 
        padding: 30px;
        border-top-left-radius: 30px;
        border-bottom-left-radius: 30px;
        height: 500px;
    }
    .insights {
        list-style: none;
        margin: 0;
        padding: 0;
        @apply(--layout);
        @apply(--layout-vertical);
        color: #FFFFFF;
    }
    .insight {
        @apply(--layout-flex);
        @apply(--layout);
        @apply(--layout-horizontal);
        margin: 10px 0;
    }
    .insight .info {
        @apply(--layout-flex-9);
        @apply(--layout-horizontal);
    }
    .insight .cell {
        display: block;
        font-size: 24px;
        @apply(--layout);
        @apply(--layout-start-justified);
        @apply(--layout-vertical);
    }
    .insight .icon {
        @apply(--layout-flex);
        @apply(--layout);
        @apply(--layout-horizontal);
        @apply(--layout-self-end);
        padding-right: 30px;
        color: var(--primary-icon-color);
        fill: var(--primary-icon-color);
    }
    .insight .icon iron-icon {
        height: 50px;
        width: 50px;
    }
    .insight .info .title {
        font-size: 12px;
        text-transform: uppercase;
    }
    .insight .info .field {
        font-size: 24px;
    }
    #chartdiv {
        /*background: #3f3f4f;*/
        color: #ffffff;       
        min-width: 100%;
        height: 450px;
    }
    button {
        padding: 12px 17px;
        border: 2px solid #FFFFFF;
        border-radius: 6px;
        margin: 0px 8px;
        cursor: pointer;
        background-color: var(--primary-background-color);
        text-transform: uppercase;
        color: #FFFFFF;
        font-size: 16px;
        font-weight: 500;
        overflow: auto;
    }
    .toggle {
        @apply(--layout);
        @apply(--layout-horizontal);
        flex-wrap: no-wrap;
        padding: 12px 17px;
        border: 2px solid #FFFFFF;
        border-radius: 6px;
        margin: 0px 8px;
        cursor: pointer;
        background-color: var(--primary-background-color);
        text-transform: uppercase;
        color: #FFFFFF;
        font-size: 16px;
        font-weight: 500;
        overflow: auto;
        @apply(--layout-center);
        z-index: 5;

    }
    .toggle .circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px #FFFFFF solid;
        margin-left: 15px;
        @apply(--layout-flex-auto);
        z-index: 2;
    }
    .toggle .type {
        @apply(--layout-flex-auto);
        z-index: 2;
    }
    .options {
        @apply(--layout);
        @apply(--layout-horizontal);
        padding: 0 50px;
    }
    .options h1 {
        @apply(--layout-flex-1);
    }
    .toggles {
        @apply(--layout);
        @apply(--layout-center);
        @apply(--layout-horizontal);

        @apply(--layout-flex-1);
        @apply(--layout-end-justified);

    }
    .toggles .hr[data-toggle="on"] {
        border-color: #683a78;
    }
    .toggles .hr[data-toggle="on"] .circle {
        border-color: #683a78;
        box-shadow: 0px 0px 5px #683a78;
        background-color: #683a78;
    }
    .toggles .pc[data-toggle="on"] {
        border-color: #f7a017;
    }
    .toggles .pc[data-toggle="on"] .circle {
        border-color: #f7a017;
        box-shadow: 0px 0px 5px #f7a017;
        background-color: #f7a017;
    }
    .toggles .cd[data-toggle="on"] {
        border-color: #5ea7a1;
    }
    .toggles .cd[data-toggle="on"] .circle {
        border-color: #5ea7a1;
        box-shadow: 0px 0px 5px #5ea7a1;
        background-color: #5ea7a1;
    }
    .toggles .pw[data-toggle="on"] {
        border-color: #074a8c;
    }
    .toggles .pw[data-toggle="on"] .circle {
        border-color: #074a8c;
        box-shadow: 0px 0px 5px #074a8c;
        background-color: #074a8c;
    }
    .bubbles {
        @apply(--layout);
        @apply(--layout-horizontal);
        padding: 50px 0;
    }
    bubble-stat {
        @apply(--layout-flex);
    }
  </style>
  <template>
    <section>
        <div class="bubbles">
            <bubble-stat data-type="avg_power"></bubble-stat>
            <bubble-stat data-type="avg_pace"></bubble-stat>
            <bubble-stat data-type="avg_hr"></bubble-stat>
            <bubble-stat data-type="max_hr"></bubble-stat>
            <bubble-stat data-type="time"></bubble-stat>
        </div>
        <div class="options">
            <h1 class="header">Overview & Statistics</h1>
            <div class="toggles">
                <div class="hr toggle" data-toggle="on" on-click="toggle" data-graph="hr">
                    <div class="type">Heart Rate</div>
                    <div class="circle"></div>
                </div>
                <div class="pw toggle" data-toggle="on" on-click="toggle" data-graph="pw">
                    <div class="type">Power</div>
                    <div class="circle"></div>
                </div>
                <div class="pc toggle" data-toggle="off" on-click="toggle" data-graph="pc">
                    <div class="type">Pace</div>
                    <div class="circle"></div>
                </div>
                <div class="cd toggle" data-toggle="off" on-click="toggle" data-graph="cd">
                    <div class="type">Cadence</div>
                    <div class="circle"></div>
                </div>
            </div>
        </div>
        <div class="chart">
            <div id="chartdiv"></div>
        </div>
    </section>
  </template>
  <script src="../../scripts/amcharts/amcharts.js"></script>
  <script src="../../scripts/amcharts/serial.js"></script>
  <script src="../../scripts/amcharts/themes/stryd.js"></script>
  <script>
    /*global AmCharts*/
    /*global jwt*/
    /*global superagent*/
    /*jshint camelcase: false */
  	Polymer({
        is: 'workout-element',
        truncate: function (n) {
            var parts = String(n).split('.');
            var shortened = '';
            if (parts.length > 1) {
                shortened =  parts[0] + '.' + parts[1].substring(0, 2);
            } else {
                shortened =  parts[0];
            }
            
            return shortened;
        },
        ready: function () {
            AmCharts.handleLoad();
            this.style.display = 'hidden';
        },
        show: function () { 
            this.style.display = 'block';
        },
        change: function (id) {
            this.show();
            this.grabData(id);
        },
        grabData: function (id) {
            superagent
                .get('/b/api/v1/activities/' + id)
                .send()
                .set('Accept', 'application/json')
                .set('Authorization', 'Bearer: ' + jwt.token)
                .end(function(err, res) {
                    if (res.ok) {
                        this.assembleData(res.body);
                    } else {
                        console.log('failure');
                    }
                }.bind(this));
        },
        minutesPerMile: function (mps) {
            if (mps === 0) {
                return 0;
            }
            return (1/(mps * (60/1609.34))).toPrecision(4);
        },
        assembleData: function (data) {
            this.data = data;
            this.chartData = [];
            this.startTime = new Date(data.timestamp_list[0] * 1000);
            var avg_power_total = 0,
                avg_power_count = 0,
                i = 0;
            for (i = 0; i < data.total_power_list.length; i=i+1) {
                var entry = {};
                entry.date = new Date(data.timestamp_list[i]*1000);
                if ('heart_rate_list' in data) {
                    entry.heart_rate = data.heart_rate_list[i];
                }
                if ('speed_list' in data) {
                    entry.speed = this.minutesPerMile(data.speed_list[i]);
                }
                entry.power = data.total_power_list[i];
                if (entry.power > 10) {
                    avg_power_count += 1;
                    avg_power_total += entry.power;
                }
                if ('cadence_list' in data) {
                   entry.cadence = data.cadence_list[i];
                }
                this.chartData.push(entry);
            }
            var avg_power = avg_power_total / avg_power_count;
            var miles = data.distance / 1600;
            var minutes = data.moving_time / 60;
            this.notifyPath('display.distance', this.truncate(miles));
            this.notifyPath('display.time', this.truncate(minutes));
            this.notifyPath('display.pace', this.truncate(minutes/miles));
            this.notifyPath('display.max_hr', this.truncate(data.max_heart_rate));
            this.notifyPath('display.avg_hr', this.truncate(data.average_heart_rate));
            this.notifyPath('display.avg_watts', this.truncate(avg_power));
            this.fillChart();
        },
        fillZero: function (n) {
            n = String(n);
            if (n.length === 1) {
                return '0' + n;
            } else {
                return n;
            }
        },
        bindToggles: function () {
            this.graphs = {
                hr: this.chart.getGraphById('v1'),
                pc: this.chart.getGraphById('v2'),
                cd: this.chart.getGraphById('v3'),
                pw: this.chart.getGraphById('v4')
            };
            this.querySelector('[data-graph="hr"]').dataset.toggle = 'on';
            this.querySelector('[data-graph="pw"]').dataset.toggle = 'on';
            this.querySelector('[data-graph="pc"]').dataset.toggle = 'off';
            this.querySelector('[data-graph="cd"]').dataset.toggle = 'off';
            this.chart.hideGraph(this.graphs.pc);
            this.chart.hideGraph(this.graphs.cd);
        },
        toggle: function (e) {
            var target = e.target;
            while (!('graph' in target.dataset)) {
                target = target.parentElement;
            }
            var graph = target.dataset.graph;
            if (target.dataset.toggle === 'on') {
                target.dataset.toggle = 'off';
                this.chart.hideGraph(this.graphs[graph]);
            } else {
                target.dataset.toggle = 'on';
                this.chart.showGraph(this.graphs[graph]);
            }
        },
        calcAvgs: function (begin, end) {
            var i;
            var total = end - begin + 1;
            var avg_power = 0,
                avg_power_count = 0,
                avg_pace = 0,
                avg_hr = 0,
                max_hr = 0,
                time = 0;
            time = total;
            for (i = begin; i < end; i=i+1) {
                if (this.data.total_power_list[i] > 10) {
                    avg_power_count += 1;
                    avg_power += this.data.total_power_list[i];
                }
                avg_pace += this.data.speed_list[i];
                avg_hr += this.data.heart_rate_list[i];
                if (this.data.heart_rate_list[i] > max_hr) {
                    max_hr = this.data.heart_rate_list[i];
                }
            }
            avg_power = this.truncate(avg_power/avg_power_count);
            avg_pace = this.truncate(this.minutesPerMile(avg_pace/total));
            avg_hr = this.truncate(avg_hr/total);
            this.querySelector('[data-type="avg_power"]').setVal(avg_power);
            this.querySelector('[data-type="avg_pace"]').setVal(avg_pace);
            this.querySelector('[data-type="avg_hr"]').setVal(avg_hr);
            this.querySelector('[data-type="max_hr"]').setVal(max_hr);
            this.querySelector('[data-type="time"]').setVal(time);
        },
        fillChart: function () {
            this.chart = AmCharts.makeChart(this.$.chartdiv, {
                'type': 'serial',
                'theme': 'stryd',
                'dataDateFormat': 'YY:MM:DD',
                'autoMarginOffset': 20,
                'valueAxes': [{
                    'id': 'v1',
                    'axisAlpha': 1,
                    'position': 'left',
                    'axisThickness': 2,
                    'gridAlpha': 0,
                    'axisColor': '#683a78'
                }, {
                    'id': 'v2',
                    'axisAlpha': 1,
                    'position': 'right',
                    'axisThickness': 2,
                    'gridAlpha': 0,
                    'axisColor': '#f7a017'
                }, {
                    'id': 'v3',
                    'axisAlpha': 1,
                    'position': 'left',
                    'offset': 50,
                    'axisThickness': 2,
                    'gridAlpha': 0,
                    'axisColor': '#5ea7a1'
                }, {
                    'id': 'v4',
                    'axisAlpha': 1,
                    'position': 'right',
                    'offset': 50,
                    'axisThickness': 2,
                    'gridAlpha': 0,
                    'axisColor': '#074a8c'
                }],
                'balloon': {
                    'borderThickness': 1,
                    'shadowAlpha': 0
                },
                'graphs': [{
                    'id': 'v1',
                    'valueAxis': 'v1',
                    'bullet': 'round',
                    'bulletBorderAlpha': 1,
                    'bulletColor': '#FFFFFF',
                    'bulletSize': 5,
                    'hideBulletsCount': 50,
                    'lineThickness': 2,
                    'title': 'heart rate',
                    'useLineColorForBulletBorder': true,
                    'valueField': 'heart_rate',
                    'type': 'smoothedLine',
                    'balloonText': '<div style="margin:5px; font-size:19px;">[[value]] BPM</div>'
                }, {
                    'id': 'v2',
                    'valueAxis': 'v2',
                    'bullet': 'round',
                    'bulletBorderAlpha': 1,
                    'bulletColor': '#FFFFFF',
                    'bulletSize': 5,
                    'hideBulletsCount': 50,
                    'lineThickness': 2,
                    'title': 'speed',
                    'useLineColorForBulletBorder': true,
                    'valueField': 'speed',
                    'type': 'smoothedLine',
                    'balloonText': '<div style="margin:5px; font-size:19px;">[[value]] Min/Mile</div>'
                }, {
                    'id': 'v3',
                    'valueAxis': 'v3',
                    'bullet': 'round',
                    'bulletBorderAlpha': 1,
                    'bulletColor': '#FFFFFF',
                    'bulletSize': 5,
                    'hideBulletsCount': 50,
                    'lineThickness': 2,
                    'title': 'cadence',
                    'useLineColorForBulletBorder': true,
                    'valueField': 'cadence',
                    'type': 'smoothedLine',
                    'balloonText': '<div style="margin:5px; font-size:19px;">[[value]] SPM</div>'
                }, {
                    'id': 'v4',
                    'valueAxis': 'v4',
                    'bullet': 'round',
                    'bulletBorderAlpha': 1,
                    'bulletColor': '#FFFFFF',
                    'bulletSize': 5,
                    'hideBulletsCount': 50,
                    'lineThickness': 2,
                    'title': 'power',
                    'useLineColorForBulletBorder': true,
                    'valueField': 'power',
                    'type': 'smoothedLine',
                    'balloonText': '<div style="margin:5px; font-size:19px;">[[value]] Watts</div>'
                }],
                'chartCursor': {
                    'valueLineEnabled': true,
                    'valueLineBalloonEnabled': true,
                    'cursorAlpha': 0,
                    'valueLineAlpha': 0.2
                },
                'categoryField': 'date',
                'categoryAxis': {
                    'parseDates': false,
                    'dashLength': 5,
                    'minorGridEnabled': true,
                    'dateFormats': [{
                        'period': 'mm',
                        'format': 'mm:ss'
                    }],
                    /*jshint unused: false */
                    categoryFunction: function (a, d, b) {
                        var timeDiff = a.getTime() - this.startTime.getTime();
                        var time = new Date(timeDiff);
                        return this.fillZero(time.getUTCHours()) + ':' + this.fillZero(time.getMinutes()) + '.' + this.fillZero(time.getSeconds());
                    }.bind(this)
                },
                'export': {
                    'enabled': true
                },
                'dataProvider': this.chartData
            });
            function zoomChart(){
                this.chart.zoomToIndexes(this.chart.dataProvider.length - 20, this.chart.dataProvider.length - 1);
            }
            this.bindToggles();
            this.calcAvgs(0, this.chartData.length);
            this.chart.addListener('zoomed', function (e) {
                this.calcAvgs(e.startIndex, e.endIndex + 1);
            }.bind(this));
            // zoomChart();
        }
    });
  </script>
</dom-module>
