<dom-module id="workout-element">
    <link rel="import" href="../bubble-stat/bubble-stat.html">
    <style>
        .sample {
            display: none;
        }
        :host.sample .sample {
            display: block;
        }
        section {
            @apply(--layout);
            @apply(--layout-vertical);
            background-color: var(--primary-background-color);
        }
        h1.header {
            @apply(--header);
        }
        h2.subtitle {
            @apply(--subtitle);
        }
        .chart {
            display: block;
            width: 100%;
            height: 60vh;
            padding-bottom: 5vh;
        }
        #chartdiv {
            color: #ffffff;
            min-width: 100%;
            height: 60vh;
        }
        .toggle {
            @apply(--layout-horizontal);
            padding: 0.8vw 1.1vw;
            border: 2px solid #FFFFFF;
            border-radius: 6px;
            margin: 0 0.5vw;
            cursor: pointer;
            background-color: var(--primary-background-color);
            text-transform: uppercase;
            color: #FFFFFF;
            font-size: 1vw;
            font-weight: 500;
            @apply(--layout-center);
            z-index: 5;
            position: relative;
        }
        .options {
            @apply(--layout-horizontal);
            @apply(--layout-justified);
            padding: 1vw 3.3vw;
        }
        .toggles {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            @apply(--layout-flex);
            @apply(--layout-end-justified);
        }
        .toggles .heartRate[data-toggle="on"] {
            border-color: #683a78;
        }
        .toggles .heartRate[data-toggle="on"] .circle {
            border-color: #683a78;
            box-shadow: 0px 0px 5px #683a78;
            background-color: #683a78;
        }
        .toggles .power[data-toggle="on"] {
            border-color: #f7a017;
        }
        .toggles .power[data-toggle="on"] .circle {
            border-color: #f7a017;
            box-shadow: 0px 0px 5px #f7a017;
            background-color: #f7a017;
        }
        .toggles .cadence[data-toggle="on"] {
            border-color: #5ea7a1;
        }
        .toggles .cadence[data-toggle="on"] .circle {
            border-color: #5ea7a1;
            box-shadow: 0px 0px 5px #5ea7a1;
            background-color: #5ea7a1;
        }
        .toggles .pace[data-toggle="on"] {
            border-color: #074a8c;
        }
        .toggles .pace[data-toggle="on"] .circle {
            border-color: #074a8c;
            box-shadow: 0px 0px 5px #074a8c;
            background-color: #074a8c;
        }
        .toggles .elevation[data-toggle="on"] {
            border-color: #a06a81;
        }
        .toggles .elevation[data-toggle="on"] .circle {
            border-color: #a06a81;
            box-shadow: 0px 0px 5px #a06a81;
            background-color: #a06a81;
        }
        .toggles .groundTime[data-toggle="on"] {
            border-color: #00ACEE;
        }
        .toggles .groundTime[data-toggle="on"] .circle {
            border-color: #00ACEE;
            box-shadow: 0px 0px 5px #00ACEE;
            background-color: #00ACEE;
        }
        .toggles .vertOsc[data-toggle="on"] {
            border-color: #2BAF2B;
        }
        .toggles .vertOsc[data-toggle="on"] .circle {
            border-color: #2BAF2B;
            box-shadow: 0px 0px 5px #2BAF2B;
            background-color: #2BAF2B;
        }
        .toggles .stat[data-toggle="on"] {
            border-color: #F7A016;
        }
        .toggles .stat[data-toggle="on"] .circle {
            border-color: #F7A016;
            box-shadow: 0px 0px 5px #F7A016;
            background-color: #F7A016;
        }

        [data-graph="cadence"] {
            --paper-radio-button-checked-color: #5ea7a1;
            --paper-radio-button-checked-ink-color: #5ea7a1;
        }
        [data-graph="groundTime"] {
            --paper-radio-button-checked-color: #00ACEE;
            --paper-radio-button-checked-ink-color: #00ACEE;
        }
        [data-graph="vertOsc"] {
            --paper-radio-button-checked-color: #2BAF2B;
            --paper-radio-button-checked-ink-color: #2BAF2B;
        }

        .toggle .circle {
            width: 1.3vw;
            height: 1.3vw;
            border-radius: 50%;
            border: 3px #FFFFFF solid;
            margin-left: 1vw;
            @apply(--layout-flex-auto);
            z-index: 2;
        }
        .toggle .type {
            @apply(--layout-flex-auto);
            z-index: 2;
        }
        div.bubbles {
            @apply(--layout-horizontal);
            @apply(--layout-around-justified);
            padding: 4vw 4vw;
        }

        bubble-stat {
            width: 12vw;
            height: 12vw;
        }

        .outer-spinner {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 110%;
            position: absolute;
            background-color: var(--primary-background-color);
            z-index: 10;
            display: flex;
            display: -webkit-flex;
            -ms-flex-align: center;
            -webkit-align-items: center;
            align-items: center;
            -ms-flex-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            transition: opacity 2s;
            opacity: 1;
        }
        .outer-spinner.fade {
            opacity: 0;
            z-index: 0;
            height: 0px !important;
        }

        .spinner {
            margin: 100px auto;
            width: 40px;
            height: 40px;
            position: relative;
            text-align: center;
            -webkit-animation: sk-rotate 2.0s infinite linear;
            animation: sk-rotate 2.0s infinite linear;
        }
        .spinner .dot1, .spinner .dot2 {
            width: 60%;
            height: 60%;
            display: inline-block;
            position: absolute;
            top: 0;
            background-color: var(--primary-icon-color);
            border-radius: 100%;

            -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
            animation: sk-bounce 2.0s infinite ease-in-out;
        }

        .spinner .dot2 {
            top: auto;
            bottom: 0;
            -webkit-animation-delay: -1.0s;
            animation-delay: -1.0s;
        }

        @-webkit-keyframes sk-rotate { 100% { -webkit-transform: rotate(360deg) }}
        @keyframes sk-rotate { 100% { transform: rotate(360deg); -webkit-transform: rotate(360deg) }}

        @-webkit-keyframes sk-bounce {
            0%, 100% { -webkit-transform: scale(0.0) }
            50% { -webkit-transform: scale(1.0) }
        }

        @keyframes sk-bounce {
            0%, 100% { 
                transform: scale(0.0);
                -webkit-transform: scale(0.0);
            } 50% { 
                transform: scale(1.0);
                -webkit-transform: scale(1.0);
            }
        }

        .dynamics {
            border-radius: 6px;
        }
        .dynamics:hover {
            border-bottom: none;
            border-radius: 6px 6px 0 0;
        }
        .dynamics .radios {
            visibility: hidden;
            transition: visibility 0.1s;
            position: absolute;
            @apply(--layout-vertical);
            width: 103%;
            left: -2px;
            top: 34px;
            padding: 0.8vw 1.1vw;
            border: 2px solid #FFFFFF;
            border-top: none;
            border-radius: 0 0 6px 6px;
            margin: 0;
            cursor: pointer;
            background-color: var(--primary-background-color);
            box-sizing: border-box;
        }
        .dynamics .radios paper-radio-button {
            padding-bottom: 15px;
        }
        .dynamics .radios paper-radio-button:last-child {
            padding-bottom: 0px;
        }
        .dynamics:hover .radios {
            visibility: visible;
            animation-delay: 2s;
            -webkit-animation-delay: 2s;
        }
    </style>
    <template>
        <div class="outer-spinner" id="spinner">
            <div class="spinner">
                <div class="dot1"></div>
                <div class="dot2"></div>
            </div>
        </div>
        <section>
            <div class="layout horizontal end" style="margin: 20px 50px 0 50px;">
                <h1 class="header">Statistics</h1>
                <div class="toggles">
                    <div class="stat toggle" data-toggle="on" on-click="toggleMetrics" data-stat="elapsed">
                        <div class="type">Show Elapsed Statistics</div>
                        <div class="circle"></div>
                    </div>
                    <div class="stat toggle" data-toggle="off" on-click="toggleMetrics" data-stat="moving">
                        <div class="type">Show Moving Statistics</div>
                        <div class="circle"></div>
                    </div>
                </div>
            </div>

            <h2 class="subtitle sample" style="padding: 0px 0px 0px 50px;">Sample Data</h2>
            <div class="bubbles"
                data-step="7"
                data-intro="When you select a different portion of your run, your averages will update.">
                <bubble-stat type="pace"></bubble-stat>
                <bubble-stat type="time"></bubble-stat>
                <bubble-stat type="power"></bubble-stat>
                <bubble-stat type="heartRate"></bubble-stat>
                <bubble-stat type="cadence"></bubble-stat>
                <bubble-stat type="misc"></bubble-stat>
            </div>
            <div class="options">
                <div>
                    <h1 class="header">Chart</h1>
                    <h2 class="subtitle sample">Sample Data</h2>
                </div>
                <div class="toggles">
                    <div class="heartRate toggle" data-toggle="on" on-click="toggle" data-graph="heartRate">
                        <div class="type">Heart Rate</div>
                        <div class="circle"></div>
                    </div>
                    <div class="power toggle" data-toggle="on" on-click="toggle" data-graph="power">
                        <div class="type">Power</div>
                        <div class="circle"></div>
                    </div>
                    <div class="pace toggle" data-toggle="off" on-click="toggle" data-graph="pace">
                        <div class="type">Pace</div>
                        <div class="circle"></div>
                    </div>
                    <div class="elevation toggle" data-toggle="off" on-click="toggle" data-graph="elevation">
                        <div class="type">Elevation</div>
                        <div class="circle"></div>
                    </div>
                    <div class="toggle dynamics">
                        <div class="type">Run Form</div>
                        <iron-icon icon="icons:arrow-drop-down"></iron-icon>
                        <div class="radios">
                            <paper-radio-button on-click="toggle" data-graph="cadence">Cadence</paper-radio-button>
                            <paper-radio-button on-click="toggle" data-graph="groundTime">Ground Time</paper-radio-button>
                            <paper-radio-button on-click="toggle" data-graph="vertOsc">Vertical Oscillation</paper-radio-button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart">
                <div id="chartdiv"
                    data-step="6"
                    data-intro="See how your run came together. See how power, cadence, heart rate, and more influenced your run. You can focus on certain section by clicking & dragging over an area.">
                </div>
            </div>
        </section>
    </template>
    <script src="../../scripts/amcharts/amcharts.js"></script>
    <script src="../../scripts/amcharts/serial.js"></script>
    <script src="../../scripts/amcharts/themes/stryd.js"></script>
    <script>
        /*global AmCharts*/
        /*jshint camelcase: false */

        var mapReadyTrigger = false;
        var mapReadyEvent = new CustomEvent('MapReady');
        window.mapReady = function () {
            mapReadyTrigger = true;
            window.dispatchEvent(mapReadyEvent);
        };

        Polymer({
            is: 'workout-element',
            ready: function () {
                AmCharts.handleLoad();
                this.metrics = {
                    heartRate: {
                        toggle: this.querySelector('[data-graph="heartRate"]'),
                        graph: function () {
                            return this.chart.getGraphById('heartRate');
                        }.bind(this),
                        axis: {
                            'id': 'heartRate',
                            'axisAlpha': 1,
                            'position': 'left',
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#683a78',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'heartRate',
                            'valueAxis': 'heartRate',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'heartRate',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'heartRate',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] BPM',
                            'lineColor': '#683a78'
                        },
                        switch: function (state) {
                            if (
                                state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.heartRate.toggle.dataset.toggle === 'on')
                            ) {
                                this.metrics.heartRate.toggle.dataset.toggle = 'off';
                                this.chart.hideGraph(this.metrics.heartRate.graph());
                            } else {
                                this.metrics.heartRate.toggle.dataset.toggle = 'on';
                                this.chart.showGraph(this.metrics.heartRate.graph());
                            }
                        }.bind(this)
                    },
                    power: {
                        toggle: this.querySelector('[data-graph="power"]'),
                        graph: function () {
                            return this.chart.getGraphById('power');
                        }.bind(this),
                        axis: {
                            'id': 'power',
                            'axisAlpha': 1,
                            'position': 'right',
                            'offset': 0,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#f7a017',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'power',
                            'valueAxis': 'power',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'power',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'power',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] Watts',
                            'lineColor': '#f7a017'
                        },
                        switch: function (state) {
                            if (
                                state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.power.toggle.dataset.toggle === 'on')
                            ) {
                                this.metrics.power.toggle.dataset.toggle = 'off';
                                this.chart.hideGraph(this.metrics.power.graph());
                            } else {
                                this.metrics.power.toggle.dataset.toggle = 'on';
                                this.chart.showGraph(this.metrics.power.graph());
                            }
                        }.bind(this)
                    },
                    pace: {
                        toggle: this.querySelector('[data-graph="pace"]'),
                        graph: function () {
                            return this.chart.getGraphById('pace');
                        }.bind(this),
                        axis: {
                            'id': 'pace',
                            'axisAlpha': 1,
                            'position': 'right',
                            'offset': 50,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#074a8c',
                            'dashLength': 1,
                            'labelFunction': speedToPaceForValueAxis
                        },
                        info: {
                            'id': 'pace',
                            'valueAxis': 'pace',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'pace',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'pace',
                            'type': 'smoothedLine',
                            'balloonFunction': speedToPaceForBalloon,
                            'balloonText': '[[value]] Min/Mile',
                            'lineColor': '#074a8c',
                        },
                        switch: function (state) {
                            if (
                                state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.pace.toggle.dataset.toggle === 'on')
                            ) {
                                this.metrics.pace.toggle.dataset.toggle = 'off';
                                this.chart.hideGraph(this.metrics.pace.graph());
                            } else {
                                this.metrics.pace.toggle.dataset.toggle = 'on';
                                this.chart.showGraph(this.metrics.pace.graph());
                            }
                        }.bind(this)
                    },
                    cadence : {
                        toggle: this.querySelector('[data-graph="cadence"]'),
                        graph: function () {
                            return this.chart.getGraphById('cadence');
                        }.bind(this),
                        axis: {
                            'id': 'cadence',
                            'axisAlpha': 1,
                            'position': 'left',
                            'offset': 50,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#5ea7a1',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'cadence',
                            'valueAxis': 'cadence',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'cadence',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'cadence',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] SPM',
                            'lineColor': '#5ea7a1'
                        },
                        switch: function (state) {
                            if (
                                state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.cadence.toggle.checked === false)
                            ) {
                                this.metrics.cadence.toggle.checked = false;
                                this.chart.hideGraph(this.metrics.cadence.graph());
                            } else {
                                this.metrics.cadence.toggle.checked = true;
                                this.chart.showGraph(this.metrics.cadence.graph());
                            }
                        }.bind(this)
                    },
                    elevation: {
                        toggle: this.querySelector('[data-graph="elevation"]'),
                        graph: function () {
                            return this.chart.getGraphById('elevation');
                        }.bind(this),
                        axis: {
                            'id': 'elevation',
                            'axisAlpha': 1,
                            'position': 'right',
                            'offset': 120,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#a06a81',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'elevation',
                            'valueAxis': 'elevation',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'elevation',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'elevation',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] Meters',
                            'lineColor': '#a06a81',
                        },
                        switch: function (state) {
                            if (
                                state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.elevation.toggle.dataset.toggle === 'on')
                            ) {
                                this.metrics.elevation.toggle.dataset.toggle = 'off';
                                this.chart.hideGraph(this.metrics.elevation.graph());
                            } else {
                                this.metrics.elevation.toggle.dataset.toggle = 'on';
                                this.chart.showGraph(this.metrics.elevation.graph());
                            }
                        }.bind(this)
                    },
                    groundTime: {
                        toggle: this.querySelector('[data-graph="groundTime"]'),
                        graph: function () {
                            return this.chart.getGraphById('groundTime');
                        }.bind(this),
                        axis: {
                            'id': 'groundTime',
                            'axisAlpha': 1,
                            'position': 'left',
                            'offset': 100,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#00ACEE',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'groundTime',
                            'valueAxis': 'groundTime',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'groundTime',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'groundTime',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] MS',
                            'lineColor': '#00ACEE',
                        },
                        switch: function (state) {
                            if (
                                state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.groundTime.toggle.checked === false)
                            ) {
                                this.metrics.groundTime.toggle.checked = false;
                                this.chart.hideGraph(this.metrics.groundTime.graph());
                            } else {
                                this.metrics.groundTime.toggle.checked = true;
                                this.chart.showGraph(this.metrics.groundTime.graph());
                            }
                        }.bind(this)
                    },
                    vertOsc: {
                        toggle: this.querySelector('[data-graph="vertOsc"]'),
                        graph: function () {
                            return this.chart.getGraphById('vertOsc');
                        }.bind(this),
                        axis: {
                            'id': 'vertOsc',
                            'axisAlpha': 1,
                            'position': 'right',
                            'offset': 100,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#2BAF2B',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'vertOsc',
                            'valueAxis': 'vertOsc',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'vertOsc',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'vertOsc',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] CM',
                            'lineColor': '#2BAF2B'
                        },
                        switch: function (state) {
                            if (
                                state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.vertOsc.toggle.checked === false)
                            ) {
                                this.metrics.vertOsc.toggle.checked = false;
                                this.chart.hideGraph(this.metrics.vertOsc.graph());
                            } else {
                                this.metrics.vertOsc.toggle.checked = true;
                                this.chart.showGraph(this.metrics.vertOsc.graph());
                            }
                        }.bind(this)
                    }
                };
            },
            setChartData: function (data, steps) {
                this.setLoading();

                this.data = data;
                this.steps = steps;
                this.chartData = this.data;
                this.startTime = this.data[0].date;
                this.availableMetrics = [];
                var valueAxes = [], graphs = [];
                for (var key in this.data[0]) {
                    if (key in this.metrics) {
                        this.availableMetrics.push(key);
                        valueAxes.push(this.metrics[key].axis);
                        graphs.push(this.metrics[key].info);
                    }
                }
                this.fillChart(valueAxes, graphs);
                if ('chart' in this) {
                    this.bindToggles();
                }
            },
            removeLoading: function () {
                this.$.spinner.classList.remove('show');
                this.$.spinner.classList.add('hide');
                this.$.spinner.classList.add('fade');
            },
            setLoading: function () {
                this.$.spinner.classList.add('show');
                this.$.spinner.classList.remove('hide');
                this.$.spinner.classList.remove('fade');
            },
            toggleMetrics: function (e) {
                var target = e.target;
                while (!('stat' in target.dataset)) {
                    target = target.parentElement;
                }
                var opt = target.dataset.stat;

                /* Change visual state */
                var active = this.querySelector('[data-toggle="on"].stat');
                active.dataset.toggle = 'off';
                target.dataset.toggle = 'on';
                
                var bubbles = this.querySelectorAll('bubble-stat');
                for (var i = 0; i < bubbles.length; i++) {
                    var bubble = bubbles[i];
                    bubble.setMode(opt);
                }
            },
            bindToggles: function () {
                for (var key in this.metrics) {
                    if (this.availableMetrics.indexOf(key) === -1) {
                        this.metrics[key].toggle.classList.add('hidden');
                    } else {
                        this.metrics[key].toggle.classList.remove('hidden');
                    }
                }
                this.metrics.power.switch('on');
                this.metrics.heartRate.switch('on');
                var hiddenMetrics = ['pace', 'elevation', 'cadence', 'groundTime', 'vertOsc'];
                for (key of this.availableMetrics) {
                    if (hiddenMetrics.indexOf(key) > -1) {
                        this.metrics[key].switch('off');
                    }
                }
            },
            toggle: function (e) {
                var target = e.target;
                while (!('graph' in target.dataset)) {
                    target = target.parentElement;
                }
                var graph = target.dataset.graph;
                this.metrics[graph].switch('flip');
            },
            calcAvgs: function (begin, end) {
                var total = end - begin;

                var exactDistance = meterToMile(this.data[end-1].distance - this.data[begin].distance, 8);
                var distance = meterToMile(this.data[end-1].distance - this.data[begin].distance, 1);

                var paceUnit, distanceUnit;
                if (user.data.units === 'feet') {
                    paceUnit = 'Min/Mi';
                    distanceUnit = 'Mi';
                } else {
                    paceUnit = 'Min/KM';
                    distanceUnit = 'KM';
                }
                var pace = {
                    active: ['pace'],
                    pace: {
                        icon: 'maps:directions-run',
                        title: 'Pace',
                        moving: 0,
                        elapsed: 0,
                        unit: paceUnit
                    },
                    maxPace: {
                        icon: 'maps:directions-run',
                        title: 'Max Pace',
                        value: 0,
                        unit: paceUnit
                    }
                };
                var time = {
                    active: ['time'],
                    time: {
                        icon: 'image:timer',
                        title: 'Time',
                        value: 0,
                        moving: 0,
                        elapsed: 0,
                        mseconds: 0,
                        unit: 'HH:MM:SS'
                    },
                    totalTime: {
                        icon: 'image:timer',
                        title: 'Total Time',
                        value: 0,
                        unit: 'HH:MM:SS'
                    }
                };
                var power = {
                    active: ['power'],
                    power: {
                        icon: 'image:flash-on',
                        title: 'Power',
                        moving: 0,
                        elapsed: 0,
                        mTotal: 0,
                        unit: 'Watts'
                    },
                    maxPower: {
                        icon: 'image:flash-on',
                        title: 'Max Power',
                        value: 0,
                        unit: 'Watts'
                    },
                    timeInMaxZone: {
                        icon: 'image:flash-on',
                        title: 'Time in Max Zone',
                        value: 0,
                        unit: 'Watts'
                    }
                };
                var heartRate = {
                    active: ['heartRate'],
                    heartRate: {
                        icon: 'favorite',
                        title: 'HR',
                        moving: 0,
                        elapsed: 0,
                        mTotal: 0,
                        value: 0,
                        sum: 0,
                        total: 0,
                        unit: 'BPM'
                    },
                    maxHR: {
                        icon: 'favorite',
                        title: 'Max Heart Rate',
                        value: 0,
                        unit: 'BPM'
                    }
                };
                var cadence = {
                    active: ['cadence'],
                    cadence: {
                        icon: 'maps:directions-walk',
                        title: 'Cadence',
                        elapsed: 0,
                        moving: 0,
                        mTotal: 0,
                        unit: 'SPM'
                    }
                };
                var misc = {
                    active: [],
                    distance: {
                        icon: 'communication:swap-calls',
                        title: 'Distance',
                        value: 0,
                        unit: distanceUnit
                    }
                };

                var milliseconds = this.data[end-1].date - this.data[begin].date;
                var elapsedHMS = hmsTime(milliseconds);
                var seconds = milliseconds / 1000;
                time.totalTime.value = elapsedHMS;

                for (var i = begin; i < end; i++) {
                    var data = this.data[i];

                    var timeSectionMSeconds = 1000;
                    if (i !== end - 1) {
                        timeSectionMSeconds = this.data[i+1].date - this.data[i].date;
                    }

                    /* Pace */
                    if (data.pace > pace.maxPace.value) {
                        pace.maxPace.value = data.pace;
                    }

                    /* Power */
                    if (data.power > power.maxPower.value) {
                        power.maxPower.value = data.power;
                    }

                    if (data.power > 0) {
                        time.time.moving += timeSectionMSeconds;
                    }
                    time.time.elapsed += timeSectionMSeconds;

                    // power.movingPower.sum += data.power;

                    power.power.elapsed += data.power;

                    if (data.power > 10) {
                        power.power.moving += data.power;
                        power.power.mTotal += 1;
                    }

                    if (data.power > 300) {
                        power.timeInMaxZone.value += timeSectionMSeconds;
                    }

                    /* Heart rate */
                    if (data.heartRate > heartRate.maxHR.value) {
                        heartRate.maxHR.value = data.heartRate;
                    }

                    heartRate.heartRate.elapsed += data.heartRate;

                    if (data.power > 10) {
                        heartRate.heartRate.moving += data.heartRate;
                        heartRate.heartRate.mTotal += 1;
                    }

                    cadence.cadence.elapsed += data.cadence;
                    if (data.power > 10) {
                        cadence.cadence.moving += data.cadence;
                        cadence.cadence.mTotal += 1;
                    }
                }

                var elapsedMinutes = seconds / 60;
                var movingMinutes = time.time.moving / 1000 / 60;
                var elapsedDec, movingDec, maxPace;
                if (user.data.units === 'feet') {
                    elapsedDec = elapsedMinutes / exactDistance;
                    movingDec = movingMinutes / exactDistance;
                    maxPace = minutesPerMile(pace.maxPace.value, 'minutes');
                } else {
                    elapsedDec = elapsedMinutes / exactDistance * 0.621371;
                    movingDec = movingMinutes / exactDistance * 0.621371;
                    maxPace = minutesPerKM(pace.maxPace.value);
                }
                pace.pace.elapsed = formatPace(elapsedDec.toFixed(2));
                pace.pace.moving = formatPace(movingDec.toFixed(2));
                pace.maxPace.value = maxPace;

                power.power.moving = (power.power.moving / power.power.mTotal).toFixed(1);
                power.power.elapsed = (power.power.elapsed / total).toFixed(1);

                heartRate.heartRate.moving = (heartRate.heartRate.moving / heartRate.heartRate.mTotal).toFixed(1);
                heartRate.heartRate.elapsed = (heartRate.heartRate.elapsed / total).toFixed(1);

                time.time.elapsed = hmsTime(time.time.elapsed);
                time.time.moving = hmsTime(time.time.moving);

                misc.distance.value = distance;
                if (user.data.units !== 'feet') {
                    misc.distance.value = (distance / 0.621371).toFixed(1);
                }

                cadence.cadence.moving = (cadence.cadence.moving / cadence.cadence.mTotal).toFixed(1);
                cadence.cadence.elapsed = (cadence.cadence.elapsed / total).toFixed(1);

                delete heartRate.movingHR;
                delete power.timeInMaxZone;
                this.querySelector('[type="pace"]').setData(pace);
                this.querySelector('[type="time"]').setData(time);
                this.querySelector('[type="power"]').setData(power);
                this.querySelector('[type="heartRate"]').setData(heartRate);
                this.querySelector('[type="cadence"]').setData(cadence);
                this.querySelector('[type="misc"]').setData(misc);
            },
            addPoint: function (pt) {
                this.chart.dataProvider.push(pt);
            },
            refreshData: function () {
                this.calcAvgs(0, this.chart.dataProvider.length - 1);
                this.chart.validateData();
            },
            fillChart: function (valueAxes, graphs) {
                this.chart = AmCharts.makeChart(this.$.chartdiv, {
                    'type': 'serial',
                    'theme': 'stryd',
                    'autoMarginOffset': 20,
                    'valueAxes': valueAxes,
                    'graphs': graphs,
                    'chartScrollbar': {
                        'graph': 'power',
                        'autoGridCount': false,
                        'scrollbarHeight': 50,
                        'offset':30,
                        'backgroundAlpha': 0,
                        'selectedBackgroundAlpha': 0.2,
                        'selectedBackgroundColor': '#ababab',
                        'graphFillAlpha': 0,
                        'graphLineAlpha': 0.2,
                        'selectedGraphFillAlpha': 0,
                        'selectedGraphLineAlpha': 0.5,
                        'oppositeAxis': false,
                    },
                    'chartCursor': {},
                    'categoryField': 'date',
                    'categoryAxis': {
                        'parseDates': false,
                        'minorGridEnabled': true,
                        'axisAlpha': 0,
                        'gridAlpha': 0,
                        'gridCount': 0,
                        'gridThickness': 0,
                        /*jshint unused: false */
                        categoryFunction: function (a, d, b) {
                            var timeDiff = a.getTime() - this.startTime.getTime();
                            return hmsTime(timeDiff);
                        }.bind(this)
                    },
                    'export': {
                        'enabled': true
                    },
                    'balloon': {
                        'adjustBorderColor': true,
                        'color': '#1e1e1e',
                        'cornerRadius': 5,
                        'borderThickness': 2,
                        'fillColor': '#FFFFFF',
                        'shadowAlpha': 0,
                        'fontSize': 16,
                        'verticalPadding': 4,
                        'horizontalPadding': 8
                    },
                    'dataProvider': this.chartData,
                    'pathToImages': 'https://www.stryd.com/powercenter/scripts/amcharts/images/'
                }, 0);

                this.chart.addListener('init', function (e) {
                    this.removeLoading();
                    this.bindToggles();
                    this.calcAvgs(0, this.chartData.length);
                }.bind(this));

                this.chart.addListener('zoomed', function (e) {
                    this.calcAvgs(e.startIndex, e.endIndex + 1);
                }.bind(this));
            }
        });
    </script>
</dom-module>
