<dom-module id="workout-element">
    <link rel="import" href="../bubble-stat/bubble-stat.html">
    <link rel="import" href="../workout-element/workout-segment.html">
    <style>
        :host {
            position: relative;
            display: block;
        }
        section {
            @apply(--layout);
            @apply(--layout-vertical);
            background-color: var(--primary-background-color);
        }
        h1.header {
            @apply(--header);
        }
        h2.subtitle {
            @apply(--subtitle);
        }

        .chart {
            flex: none;
            width: 100%;
            position: relative;
        }
        #chartdiv {
            color: #ffffff;
            height: 60vh;
            width: 100%;
        }
        .toggle {
            @apply(--layout-center);
            @apply(--layout-horizontal);
            @apply(--layout-justified);
            background-color: var(--primary-background-color);
            border: 2px solid #FFFFFF;
            border-right: 0;
            border-radius: 6px 0 0 6px;
            color: #FFFFFF;
            cursor: pointer;
            font-size: 1vw;
            font-weight: 500;
            margin: 0.5vw 0 0 0;
            padding: 0.8vw 1.1vw;
            position: relative;
            text-transform: uppercase;
            width: 104px;
            z-index: 5;
        }
        .options {
            @apply(--layout-horizontal);
            padding: 1vw 3.3vw;
            flex: none;
        }
        .toggles {
            @apply(--layout-vertical);
            @apply(--layout-end);
            @apply(--layout-flex);
            width: 200px;
            position: absolute;
            right: 0;
        }
        .toggles .toggle {
            display: none;
        }
        .toggles iron-icon {
            top: 13px;
            right: 13px;
            padding: 10px;
            border: 1px solid;
            background-color: #1C1C1C;
            border-radius: 6px;
            color: white;
        }
        .toggles:hover .toggle {
            display: block;
        }
        .toggles:hover iron-icon {
            display: none;
        }
        [data-graph="power"] {
            --paper-radio-button-checked-color: #f7a017;
            --paper-radio-button-checked-ink-color: #f7a017;
        }
        [data-graph="heartRate"] {
            --paper-radio-button-checked-color: #683a78;
            --paper-radio-button-checked-ink-color: #683a78;
        }
        [data-graph="pace"] {
            --paper-radio-button-checked-color: #074a8c;
            --paper-radio-button-checked-ink-color: #074a8c;
        }
        [data-graph="elevation"] {
            --paper-radio-button-checked-color: #a06a81;
            --paper-radio-button-checked-ink-color: #a06a81;
        }
        [data-graph="cadence"] {
            --paper-radio-button-checked-color: #5ea7a1;
            --paper-radio-button-checked-ink-color: #5ea7a1;
        }
        [data-graph="groundTime"] {
            --paper-radio-button-checked-color: #00ACEE;
            --paper-radio-button-checked-ink-color: #00ACEE;
        }
        [data-graph="vertOsc"] {
            --paper-radio-button-checked-color: #2BAF2B;
            --paper-radio-button-checked-ink-color: #2BAF2B;
        }
        .toggle .circle {
            width: 1.3vw;
            height: 1.3vw;
            border-radius: 50%;
            border: 3px #FFFFFF solid;
            z-index: 2;
        }
        .toggle .type {
            z-index: 2;
        }
        .toggle paper-radio-button {
            padding-bottom: 15px;
            padding-left: 10px;
        }
        .toggle paper-radio-button:first-child {
            padding-top: 15px;
        }

        .bubbles {
            @apply(--layout-horizontal);
            @apply(--layout-around-justified);
            @apply(--layout-wrap);
            padding: 1vw 1vw;
        }
        bubble-stat {
            width: 11vw;
            height: 11vw;
            margin: 1vw;
            --bubble-stat-wrap: {
                width: 11vw;
                height: 11vw;
            };
            --bubble-stat-border: {
                width: 11vw;
                height: 11vw;
            };
        }

        .outer-spinner {
            margin: 0;
            padding: 0;
            position: absolute;
            background-color: var(--primary-background-color);
            z-index: 10;
            @apply(--layout-horizontal);
            @apply(--layout-center)
            @apply(--layout-center-justified)
            transition: opacity 2s;
            opacity: 1;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            z-index: 12;
        }
        .outer-spinner.fade {
            opacity: 0;
            z-index: 0;
        }

        .spinner {
            margin: 100px auto;
            width: 40px;
            height: 40px;
            -webkit-animation: sk-rotate 2.0s infinite linear;
            animation: sk-rotate 2.0s infinite linear;
        }
        .spinner .dot1, .spinner .dot2 {
            width: 60%;
            height: 60%;
            display: inline-block;
            position: absolute;
            top: 0;
            background-color: var(--primary-icon-color);
            border-radius: 100%;
            -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
            animation: sk-bounce 2.0s infinite ease-in-out;
        }
        .spinner .dot2 {
            top: auto;
            bottom: 0;
            -webkit-animation-delay: -1.0s;
            animation-delay: -1.0s;
        }

        @-webkit-keyframes sk-rotate { 100% { -webkit-transform: rotate(360deg) }}
        @keyframes sk-rotate { 100% { transform: rotate(360deg); -webkit-transform: rotate(360deg) }}

        @-webkit-keyframes sk-bounce {
            0%, 100% { -webkit-transform: scale(0.0) }
            50% { -webkit-transform: scale(1.0) }
        }

        @keyframes sk-bounce {
            0%, 100% { 
                transform: scale(0.0);
                -webkit-transform: scale(0.0);
            } 50% { 
                transform: scale(1.0);
                -webkit-transform: scale(1.0);
            }
        }

        .tp {
            border: 1px solid #4D4D4D;
            border-bottom: 0;
            background-color: #262626;
            margin: 10px 10px 0 0;
            color: white;
            overflow-y: auto;
            overflow-x: hidden;
            height: 28vw;
        }
        .tp .title {
            border-bottom: 1px solid #F7A017;
            margin: 0;
            padding: 15px;
        }
        .tp p {
            font-size: 16px;
            line-height: 22px;
            padding: 16px;
            margin: 0;
        }

        .pt-page-moveToLeft {
            -webkit-animation: moveToLeft .6s ease both;
            animation: moveToLeft .6s ease both;
        }

        .pt-page-moveFromLeft {
            -webkit-animation: moveFromLeft .6s ease both;
            animation: moveFromLeft .6s ease both;
        }

        .pt-page-moveToRight {
            -webkit-animation: moveToRight .6s ease both;
            animation: moveToRight .6s ease both;
        }

        .pt-page-moveFromRight {
            -webkit-animation: moveFromRight .6s ease both;
            animation: moveFromRight .6s ease both;
        }
        @-webkit-keyframes moveToLeft {
            from { }
            to { -webkit-transform: translateX(-100%); }
        }
        @keyframes moveToLeft {
            from { }
            to { -webkit-transform: translateX(-100%); transform: translateX(-100%); }
        }

        @-webkit-keyframes moveFromLeft {
            from { -webkit-transform: translateX(-100%); }
        }
        @keyframes moveFromLeft {
            from { -webkit-transform: translateX(-100%); transform: translateX(-100%); }
        }

        @-webkit-keyframes moveToRight { 
            from { }
            to { -webkit-transform: translateX(100%); }
        }
        @keyframes moveToRight { 
            from { }
            to { -webkit-transform: translateX(100%); transform: translateX(100%); }
        }

        @-webkit-keyframes moveFromRight {
            from { -webkit-transform: translateX(100%); }
        }
        @keyframes moveFromRight {
            from { -webkit-transform: translateX(100%); transform: translateX(100%); }
        }

        .plan-toggle {
            position: relative;
        }
        .plan-toggle iron-icon {
            position: absolute;
            top: 0;
            right: 0;
            color: white;
            z-index: 50;
        }

        }
    </style>
    <template>
        <section>
            <div class="outer-spinner" id="spinner">
                <div class="spinner">
                    <div class="dot1"></div>
                    <div class="dot2"></div>
                </div>
            </div>
            <div class="layout horizontal end options" style="display: none;">
                <h1 class="header">Statistics</h1>
                <div class="toggles">
                    <div class="stat toggle"
                    data-toggle="on"
                    on-click="toggleMetrics"
                    data-stat="elapsed">
                        <div class="type">Show Elapsed Statistics</div>
                        <div class="circle"></div>
                    </div>
                    <div class="stat toggle"
                    data-toggle="off"
                    on-click="toggleMetrics"
                    data-stat="moving">
                        <div class="type">Show Moving Statistics</div>
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
            <div class="layout horizontal">
                <div class="layout vertical flex">
                    <div class="bubbles">
                        <bubble-stat type="pace"></bubble-stat>
                        <bubble-stat type="time"></bubble-stat>
                        <bubble-stat type="power"></bubble-stat>
                        <bubble-stat type="heartRate"></bubble-stat>
                        <bubble-stat type="dynamics"></bubble-stat>
                        <bubble-stat type="misc"></bubble-stat>
                    </div>
                </div>
                <div class="flex layout vertical">
                    <div class="tp flex plan-toggle" data-tp="plan">
                        <iron-icon on-click="toggleTP" icon="icons:picture-in-picture-alt"></iron-icon>
                        <p>{{day_title}}</p>
                        <p>{{day_description}}</p>
                        <div id="segments"></div>
                    </div>
                    <div class="tp graph flex vertical plan-toggle" data-tp="graph">
                        <iron-icon on-click="toggleTP" icon="icons:picture-in-picture-alt"></iron-icon>
                        <div id="circlechart"></div>
                    </div>
                </div>
            </div>
            <div class="layout horizontal">
                <div id="chartdiv"></div>
                <div class="toggles">
                    <iron-icon icon="icons:menu"></iron-icon>
                    <div class="toggle">
                        <paper-radio-button on-click="toggle" data-graph="power" checked="true">Power</paper-radio-button>
                        <paper-radio-button on-click="toggle" data-graph="heartRate" checked="true">Heart Rate</paper-radio-button>
                        <paper-radio-button on-click="toggle" data-graph="pace">Pace</paper-radio-button>
                        <paper-radio-button on-click="toggle" data-graph="elevation">Elevation</paper-radio-button>
                        <paper-radio-button on-click="toggle" data-graph="cadence">Cadence</paper-radio-button>
                        <paper-radio-button on-click="toggle" data-graph="groundTime">Ground Time</paper-radio-button>
                        <paper-radio-button on-click="toggle" data-graph="vertOsc">Vertical Oscillation</paper-radio-button>
                        <paper-radio-button on-click="toggle" data-graph="training">Training</paper-radio-button>
                    </div>
                </div>
            </div>
            <div class="layout vertical" style="padding-bottom: 5vh;">
                <div class="layout horizontal center center-justified">
                    <paper-textarea
                        class="editable"
                        label="Description"
                        rows="1"
                        max-rows="3"
                        value="{{descriptionText}}"
                        id="descriptionInput"
                        style="flex: 0 70%;">
                    </paper-textarea>
                    <button is="stryd-button" id="descriptionButton" on-click="" style="margin-left: 10px;">Save</button> 
                </div>
                <p id="descriptionDisplay" style="color: white;">{{descriptionText}}</p>
            </div>
        </section>
    </template>

    <script src="../../scripts/amcharts/amcharts.js"></script>
    <script src="../../scripts/amcharts/serial.js"></script>
    <script src="../../scripts/amcharts/themes/stryd.js"></script>
    <script>
        /*global AmCharts*/
        /*jshint camelcase: false */
        /*global updateWorkout*/

        var mapReadyTrigger = false;
        var mapReadyEvent = new CustomEvent('MapReady');
        window.mapReady = function () {
            mapReadyTrigger = true;
            window.dispatchEvent(mapReadyEvent);
        };

        Polymer({
            is: 'workout-element',
            ready: function () {
                this.activity = null;
                this.descriptionText = '';
                this.$.descriptionInput.addEventListener(
                    'blur',
                    () => {
                        if (this.activity !== null) {
                            updateWorkout(
                                this.activity.id,
                                {
                                    description: this.descriptionText
                                },
                                null
                            );
                        }
                    }
                );

                AmCharts.handleLoad();
                this.metrics = {
                    heartRate: {
                        toggle: this.querySelector('[data-graph="heartRate"]'),
                        graph: () => {
                            return this.chart.getGraphById('heartRate');
                        },
                        axis: {
                            'id': 'heartRate',
                            'axisAlpha': 1,
                            'position': 'left',
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#683a78',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'heartRate',
                            'valueAxis': 'heartRate',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'heartRate',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'heartRate',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] BPM',
                            'lineColor': '#683a78'
                        },
                        switch: (state) => {
                            if (state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.heartRate.toggle.checked === false)
                            ) {
                                this.metrics.heartRate.toggle.checked = false;
                                this.chart.hideGraph(this.metrics.heartRate.graph());
                            } else {
                                this.metrics.heartRate.toggle.checked = true;
                                this.chart.showGraph(this.metrics.heartRate.graph());
                            }
                        }
                    },
                    power: {
                        toggle: this.querySelector('[data-graph="power"]'),
                        graph: () => {
                            return this.chart.getGraphById('power');
                        },
                        axis: {
                            'id': 'power',
                            'axisAlpha': 1,
                            'position': 'right',
                            'offset': 0,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#f7a017',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'power',
                            'valueAxis': 'power',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'power',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'power',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] Watts',
                            'lineColor': '#f7a017'
                        },
                        switch: (state) => {
                            if (state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.power.toggle.checked === false)
                            ) {
                                this.metrics.power.toggle.checked = false;
                                this.chart.hideGraph(this.metrics.power.graph());
                            } else {
                                this.metrics.power.checked = true;
                                this.chart.showGraph(this.metrics.power.graph());
                            }
                        }
                    },
                    pace: {
                        toggle: this.querySelector('[data-graph="pace"]'),
                        graph: () => {
                            return this.chart.getGraphById('pace');
                        },
                        axis: {
                            'id': 'pace',
                            'axisAlpha': 1,
                            'position': 'right',
                            'offset': 40,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#074a8c',
                            'dashLength': 1,
                            'labelFunction': speedToPaceForValueAxis
                        },
                        info: {
                            'id': 'pace',
                            'valueAxis': 'pace',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'pace',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'pace',
                            'type': 'smoothedLine',
                            'balloonFunction': speedToPaceForBalloon,
                            'balloonText': '[[value]] Min/Mile',
                            'lineColor': '#074a8c',
                        },
                        switch: (state) => {
                            if (state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.pace.toggle.checked === false)
                            ) {
                                this.metrics.pace.toggle.checked = false;
                                this.chart.hideGraph(this.metrics.pace.graph());
                            } else {
                                this.metrics.pace.toggle.checked = true;
                                this.chart.showGraph(this.metrics.pace.graph());
                            }
                        }
                    },
                    cadence : {
                        toggle: this.querySelector('[data-graph="cadence"]'),
                        graph: () => {
                            return this.chart.getGraphById('cadence');
                        },
                        axis: {
                            'id': 'cadence',
                            'axisAlpha': 1,
                            'position': 'left',
                            'offset': 40,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#5ea7a1',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'cadence',
                            'valueAxis': 'cadence',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'cadence',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'cadence',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] SPM',
                            'lineColor': '#5ea7a1'
                        },
                        switch: (state) => {
                            if (state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.cadence.toggle.checked === false)
                            ) {
                                this.metrics.cadence.toggle.checked = false;
                                this.chart.hideGraph(this.metrics.cadence.graph());
                            } else {
                                this.metrics.cadence.toggle.checked = true;
                                this.chart.showGraph(this.metrics.cadence.graph());
                            }
                        }
                    },
                    elevation: {
                        toggle: this.querySelector('[data-graph="elevation"]'),
                        graph: () => {
                            return this.chart.getGraphById('elevation');
                        },
                        axis: {
                            'id': 'elevation',
                            'axisAlpha': 1,
                            'position': 'right',
                            'offset': 80,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#a06a81',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'elevation',
                            'valueAxis': 'elevation',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'elevation',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'elevation',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] Meters',
                            'lineColor': '#a06a81',
                        },
                        switch: (state) => {
                            if (state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.elevation.toggle.checked === false)
                            ) {
                                this.metrics.elevation.toggle.dataset.checked = false;
                                this.chart.hideGraph(this.metrics.elevation.graph());
                            } else {
                                this.metrics.elevation.toggle.checked = true;
                                this.chart.showGraph(this.metrics.elevation.graph());
                            }
                        }
                    },
                    groundTime: {
                        toggle: this.querySelector('[data-graph="groundTime"]'),
                        graph: () => {
                            return this.chart.getGraphById('groundTime');
                        },
                        axis: {
                            'id': 'groundTime',
                            'axisAlpha': 1,
                            'position': 'left',
                            'offset': 80,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#00ACEE',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'groundTime',
                            'valueAxis': 'groundTime',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'groundTime',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'groundTime',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] MS',
                            'lineColor': '#00ACEE',
                        },
                        switch: (state) => {
                            if (state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.groundTime.toggle.checked === false)
                            ) {
                                this.metrics.groundTime.toggle.checked = false;
                                this.chart.hideGraph(this.metrics.groundTime.graph());
                            } else {
                                this.metrics.groundTime.toggle.checked = true;
                                this.chart.showGraph(this.metrics.groundTime.graph());
                            }
                        }
                    },
                    vertOsc: {
                        toggle: this.querySelector('[data-graph="vertOsc"]'),
                        graph: () => {
                            return this.chart.getGraphById('vertOsc');
                        },
                        axis: {
                            'id': 'vertOsc',
                            'axisAlpha': 1,
                            'position': 'right',
                            'offset': 40,
                            'axisThickness': 2,
                            'gridAlpha': 0.2,
                            'axisColor': '#2BAF2B',
                            'dashLength': 1
                        },
                        info: {
                            'id': 'vertOsc',
                            'valueAxis': 'vertOsc',
                            'bullet': 'round',
                            'bulletBorderAlpha': 1,
                            'bulletColor': '#FFFFFF',
                            'bulletSize': 5,
                            'hideBulletsCount': 50,
                            'lineThickness': 2,
                            'title': 'vertOsc',
                            'useLineColorForBulletBorder': true,
                            'valueField': 'vertOsc',
                            'type': 'smoothedLine',
                            'balloonText': '[[value]] CM',
                            'lineColor': '#2BAF2B'
                        },
                        switch: (state) => {
                            if (state === 'off' ||
                                (state === 'flip' &&
                                this.metrics.vertOsc.toggle.checked === false)
                            ) {
                                this.metrics.vertOsc.toggle.checked = false;
                                this.chart.hideGraph(this.metrics.vertOsc.graph());
                            } else {
                                this.metrics.vertOsc.toggle.checked = true;
                                this.chart.showGraph(this.metrics.vertOsc.graph());
                            }
                        }.bind(this)
                    }
                };
            },
            setChartData: function (data, steps, activity) {
                this.setLoading();

                this.activity = activity;
                this.descriptionText = activity.description;
                if (jwt.hasToken &&
                    'user_id' in this.activity &&
                    jwt.data.id === this.activity.user_id) {
                    this.$.descriptionInput.classList.remove('hidden');
                    this.$.descriptionButton.classList.remove('hidden');
                    this.$.descriptionDisplay.classList.add('hidden');
                } else {
                    this.$.descriptionInput.classList.add('hidden');
                    this.$.descriptionButton.classList.add('hidden');
                    this.$.descriptionDisplay.classList.remove('hidden');
                }

                this.data = data;
                this.steps = steps;
                this.chartData = this.data;
                this.startTime = this.data[0].date;
                this.availableMetrics = [];
                var valueAxes = [], graphs = [];
                for (var key in this.data[0]) {
                    if (key in this.metrics) {
                        this.availableMetrics.push(key);
                        valueAxes.push(this.metrics[key].axis);
                        graphs.push(this.metrics[key].info);
                    }
                }
                this.fillChart(valueAxes, graphs);
                if ('chart' in this) {
                    this.bindToggles();
                }

                this.loadTraining();
            },
            loadTraining: function () {
                var dateHash = moment.unix(this.activity.start_time).format('YYYYMMDD');
                var trainingDay = trainingPlan.getDay(dateHash);
                if (trainingDay !== null) {
                    this.day_title = trainingDay.title;
                    this.day_description = trainingDay.description;
                    // Clear previous segments
                    while (Polymer.dom(this.$.segments).firstChild) {
                        Polymer.dom(
                            this.$.segments
                        ).removeChild(
                            Polymer.dom(
                                this.$.segments
                            ).firstChild
                        );
                    }
                    for (var segment of trainingDay.segments) {
                        var segmentDom = document.createElement('workout-segment');
                        segmentDom.setData(segment);
                        Polymer.dom(this.$.segments).appendChild(segmentDom);
                    }
                }
            },
            removeLoading: function () {
                this.$.spinner.classList.remove('show');
                this.$.spinner.classList.add('hide');
                this.$.spinner.classList.add('fade');
                this.$.spinner.style.zIndex = -1;
            },
            setLoading: function () {
                this.$.spinner.classList.add('show');
                this.$.spinner.classList.remove('hide');
                this.$.spinner.classList.remove('fade');
                this.$.spinner.style.zIndex = 12;
            },
            toggleMetrics: function (e) {
                var target = e.target;
                while (!('stat' in target.dataset)) {
                    target = target.parentElement;
                }
                var opt = target.dataset.stat;

                /* Change visual state */
                var active = this.querySelector('[data-toggle="on"].stat');
                active.dataset.toggle = 'off';
                target.dataset.toggle = 'on';
                
                var bubbles = this.querySelectorAll('bubble-stat');
                for (var bubble of bubbles) {
                    bubble.setMode(opt);
                }
            },
            bindToggles: function () {
                for (var key in this.metrics) {
                    if (this.availableMetrics.indexOf(key) === -1) {
                        this.metrics[key].toggle.classList.add('hidden');
                    } else {
                        this.metrics[key].toggle.classList.remove('hidden');
                    }
                }
                this.metrics.power.switch('on');
                this.metrics.heartRate.switch('on');
                var hiddenMetrics = ['pace', 'elevation', 'cadence', 'groundTime', 'vertOsc'];
                for (key of this.availableMetrics) {
                    if (hiddenMetrics.indexOf(key) > -1) {
                        this.metrics[key].switch('off');
                    }
                }
            },
            toggle: function (e) {
                var target = e.target;
                while (!('graph' in target.dataset)) {
                    target = target.parentElement;
                }
                var graph = target.dataset.graph;
                this.metrics[graph].switch('flip');
            },
            calcAvgs: function (begin, end) {
                var total = end - begin;

                var exactDistance = meterToMile(this.data[end-1].distance - this.data[begin].distance, 8);
                var distance = meterToMile(this.data[end-1].distance - this.data[begin].distance, 1);

                var paceUnit, distanceUnit;
                if (user.data.units === 'feet') {
                    paceUnit = 'Min/Mi';
                    distanceUnit = 'Mi';
                } else {
                    paceUnit = 'Min/KM';
                    distanceUnit = 'KM';
                }
                var pace = {
                    active: ['pace'],
                    pace: {
                        icon: 'maps:directions-run',
                        title: 'Pace',
                        moving: 0,
                        elapsed: 0,
                        unit: paceUnit
                    },
                    maxPace: {
                        icon: 'maps:directions-run',
                        title: 'Max Pace',
                        value: 0,
                        unit: paceUnit
                    }
                };
                var time = {
                    active: ['time'],
                    time: {
                        icon: 'image:timer',
                        title: 'Time',
                        value: 0,
                        moving: 0,
                        elapsed: 0,
                        mseconds: 0,
                        unit: 'HH:MM:SS'
                    },
                    totalTime: {
                        icon: 'image:timer',
                        title: 'Total Time',
                        value: 0,
                        unit: 'HH:MM:SS'
                    }
                };
                var power = {
                    active: ['power'],
                    power: {
                        icon: 'image:flash-on',
                        title: 'Power',
                        moving: 0,
                        elapsed: 0,
                        mTotal: 0,
                        unit: 'Watts'
                    },
                    maxPower: {
                        icon: 'image:flash-on',
                        title: 'Max Power',
                        value: 0,
                        unit: 'Watts'
                    },
                    timeInMaxZone: {
                        icon: 'image:flash-on',
                        title: 'Time in Max Zone',
                        value: 0,
                        unit: 'Watts'
                    }
                };
                var heartRate = {
                    active: ['heartRate'],
                    heartRate: {
                        icon: 'favorite',
                        title: 'HR',
                        moving: 0,
                        elapsed: 0,
                        mTotal: 0,
                        value: 0,
                        sum: 0,
                        total: 0,
                        unit: 'BPM'
                    },
                    maxHR: {
                        icon: 'favorite',
                        title: 'Max Heart Rate',
                        value: 0,
                        unit: 'BPM'
                    }
                };
                var dynamics = {
                    active: ['cadence', 'groundTime', 'vertOsc'],
                    cadence: {
                        icon: 'maps:directions-walk',
                        title: 'Cadence',
                        elapsed: 0,
                        moving: 0,
                        mTotal: 0,
                        unit: 'SPM'
                    },
                    groundTime: {
                        icon: 'av:av-timer',
                        title: 'Ground Time',
                        elapsed: 0,
                        moving: 0,
                        mTotal: 0,
                        unit: 'MS'
                    },
                    vertOsc: {
                        icon: 'communication:call-missed',
                        title: 'Vert. Osc.',
                        elapsed: 0,
                        moving: 0,
                        mTotal: 0,
                        unit: 'CM'
                    }
                };
                var misc = {
                    active: [],
                    distance: {
                        icon: 'communication:swap-calls',
                        title: 'Distance',
                        value: 0,
                        unit: distanceUnit
                    }
                };

                var milliseconds = this.data[end-1].date - this.data[begin].date;
                var elapsedHMS = hmsTime(milliseconds);
                var seconds = milliseconds / 1000;
                time.totalTime.value = elapsedHMS;

                for (var i = begin; i < end; i++) {
                    var data = this.data[i];

                    var timeSectionMSeconds = 1000;
                    if (i !== end - 1) {
                        timeSectionMSeconds = this.data[i+1].date - this.data[i].date;
                    }

                    /* Pace */
                    if (data.pace > pace.maxPace.value) {
                        pace.maxPace.value = data.pace;
                    }

                    /* Power */
                    if (data.power > power.maxPower.value) {
                        power.maxPower.value = data.power.toFixed(0);
                    }

                    if (data.power > 0) {
                        time.time.moving += timeSectionMSeconds;
                    }
                    time.time.elapsed += timeSectionMSeconds;

                    // power.movingPower.sum += data.power;

                    power.power.elapsed += data.power;

                    if (data.power > 10) {
                        power.power.moving += data.power;
                        power.power.mTotal += 1;
                    }

                    if (data.power > 300) {
                        power.timeInMaxZone.value += timeSectionMSeconds;
                    }

                    /* Heart rate */
                    if (data.heartRate > heartRate.maxHR.value) {
                        heartRate.maxHR.value = data.heartRate;
                    }

                    heartRate.heartRate.elapsed += data.heartRate;

                    if (data.power > 10) {
                        heartRate.heartRate.moving += data.heartRate;
                        heartRate.heartRate.mTotal += 1;
                    }

                    dynamics.cadence.elapsed += data.cadence;
                    if (data.power > 10) {
                        dynamics.cadence.moving += data.cadence;
                        dynamics.cadence.mTotal += 1;
                    }

                    if ('groundTime' in data) {
                        dynamics.groundTime.elapsed += data.groundTime;
                        if (data.power > 10) {
                            dynamics.groundTime.moving += data.groundTime;
                            dynamics.groundTime.mTotal += 1;
                        }
                    }
                    if ('vertOsc' in data) {
                        dynamics.vertOsc.elapsed += data.vertOsc;
                        if (data.power > 10) {
                            dynamics.vertOsc.moving += data.vertOsc;
                            dynamics.vertOsc.mTotal += 1;
                        }
                    }
                }

                var elapsedMinutes = seconds / 60;
                var movingMinutes = time.time.moving / 1000 / 60;
                var elapsedDec, movingDec, maxPace;
                var coeff = 1;
                if (user.data.units === 'meters') {
                    coeff = 0.621371;
                }
                elapsedDec = elapsedMinutes / exactDistance * coeff;
                movingDec = movingMinutes / exactDistance * coeff;
                maxPace = speedToPace(pace.maxPace.value, user.data.units);

                pace.pace.elapsed = formatPace(elapsedDec.toFixed(2));
                pace.pace.moving = formatPace(movingDec.toFixed(2));
                pace.maxPace.value = maxPace;

                power.power.moving = (power.power.moving / power.power.mTotal).toFixed(1);
                power.power.elapsed = (power.power.elapsed / total).toFixed(1);

                heartRate.heartRate.moving = (heartRate.heartRate.moving / heartRate.heartRate.mTotal).toFixed(1);
                heartRate.heartRate.elapsed = (heartRate.heartRate.elapsed / total).toFixed(1);

                time.time.elapsed = hmsTime(time.time.elapsed);
                time.time.moving = hmsTime(time.time.moving);

                if (isNaN(distance)) {
                    misc.distance.value = 'Not';
                    misc.distance.unit = 'Available';
                } else {
                    misc.distance.value = distance;
                    if (user.data.units !== 'feet') {
                        misc.distance.value = (distance / 0.621371).toFixed(1);
                    }
                    misc.distance.unit = distanceUnit;
                }

                dynamics.cadence.moving = (dynamics.cadence.moving / dynamics.cadence.mTotal).toFixed(1);
                dynamics.cadence.elapsed = (dynamics.cadence.elapsed / total).toFixed(1);

                if (dynamics.groundTime.elapsed !== 0) {
                    dynamics.groundTime.moving = (dynamics.groundTime.moving / dynamics.groundTime.mTotal).toFixed(1);
                    dynamics.groundTime.elapsed = (dynamics.groundTime.elapsed / total).toFixed(1);
                } else {
                    delete dynamics.groundTime;
                }

                if (dynamics.vertOsc.elapsed !== 0) {
                    dynamics.vertOsc.moving = (dynamics.vertOsc.moving / dynamics.vertOsc.mTotal).toFixed(1);
                    dynamics.vertOsc.elapsed = (dynamics.vertOsc.elapsed / total).toFixed(1);
                } else {
                    delete dynamics.vertOsc;
                }

                delete heartRate.movingHR;
                delete power.timeInMaxZone;
                this.querySelector('[type="pace"]').setData(pace);
                this.querySelector('[type="time"]').setData(time);
                this.querySelector('[type="power"]').setData(power);
                this.querySelector('[type="heartRate"]').setData(heartRate);
                this.querySelector('[type="dynamics"]').setData(dynamics);
                this.querySelector('[type="misc"]').setData(misc);
            },
            addPoint: function (pt) {
                this.chart.dataProvider.push(pt);
            },
            refreshData: function () {
                this.calcAvgs(0, this.chart.dataProvider.length - 1);
                this.chart.validateData();
            },
            fillChart: function (valueAxes, graphs) {
                this.chart = AmCharts.makeChart(
                    this.$.chartdiv,
                    {
                        'type': 'serial',
                        'theme': 'stryd',
                        'autoMarginOffset': 20,
                        'valueAxes': valueAxes,
                        'graphs': graphs,
                        'valueScrollbar':{
                            'oppositeAxis': false,
                            'offset': 50,
                            'scrollbarHeight': 10
                        },
                        'guides': [
                            {
                                'fillAlpha': 0.50,
                                'value': 50,
                                'toValue': 200,
                                'valueAxis': valueAxes[1]
                            }
                        ],
                        'chartScrollbar': {
                            'graph': 'power',
                            'autoGridCount': false,
                            'scrollbarHeight': 50,
                            'offset':30,
                            'backgroundAlpha': 0,
                            'selectedBackgroundAlpha': 0.2,
                            'selectedBackgroundColor': '#ababab',
                            'graphFillAlpha': 0,
                            'graphLineAlpha': 0.2,
                            'selectedGraphFillAlpha': 0,
                            'selectedGraphLineAlpha': 0.5,
                            'oppositeAxis': false,
                        },
                        'chartCursor': {},
                        'categoryField': 'date',
                        'categoryAxis': {
                            'parseDates': false,
                            'minorGridEnabled': true,
                            'axisAlpha': 0,
                            'gridAlpha': 0,
                            'gridCount': 0,
                            'gridThickness': 0,
                            /*jshint unused: false */
                            categoryFunction: (a, d, b) => {
                                var timeDiff = a.getTime() - this.startTime.getTime();
                                return hmsTime(timeDiff);
                            }
                        },
                        'export': {
                            'enabled': true
                        },
                        'balloon': {
                            'adjustBorderColor': true,
                            'color': '#1e1e1e',
                            'cornerRadius': 5,
                            'borderThickness': 2,
                            'fillColor': '#FFFFFF',
                            'shadowAlpha': 0,
                            'fontSize': 16,
                            'verticalPadding': 4,
                            'horizontalPadding': 8
                        },
                        'dataProvider': this.chartData,
                        'pathToImages': 'https://www.stryd.com/powercenter/scripts/amcharts/images/'
                    },
                    0
                );

                this.chart.addListener('init', (e) => {
                    this.removeLoading();
                    this.bindToggles();
                    this.calcAvgs(0, this.chartData.length);
                });

                this.chart.addListener('zoomed', (e) => {
                    this.calcAvgs(e.startIndex, e.endIndex + 1);
                });
            }
        });
    </script>
</dom-module>
