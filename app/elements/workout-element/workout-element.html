<dom-module id="workout-element">
    <style>
        :host {
            @apply(--layout);
            @apply(--layout-vertical);
            background-color: var(--primary-background-color);
            position: relative;
        }
        h1.header {
            @apply(--header);
        }
        h2.subtitle {
            @apply(--subtitle);
        }
        #chartdiv {
            color: #ffffff;
            height: 60vh;
            width: 100%;
        }
        .toggle {
            @apply(--layout-center);
            @apply(--layout-justified);
            @apply(--layout-vertical);
            background-color: var(--primary-background-color);
            border: 2px solid #FFFFFF;
            border-radius: 6px;
            color: #FFFFFF;
            cursor: pointer;
            font-size: 1vw;
            font-weight: 500;
            margin: 0.5vw 0 0 0;
            padding: 0.8vw 1.1vw;
            position: relative;
            text-transform: uppercase;
            z-index: 5;
            width: 200px;
        }
        .options {
            @apply(--layout-horizontal);
            padding: 1vw 3.3vw;
            flex: none;
        }
        .toggles {
            @apply(--layout-vertical);
            @apply(--layout-end);
            @apply(--layout-flex);
            position: absolute;
            top: 13px;
            right: 13px;
        }
        .toggles .toggle {
            display: none;
        }
        .toggles iron-icon {
            padding: 10px;
            border: 1px solid;
            background-color: #1C1C1C;
            border-radius: 6px;
            color: white;
        }
        .toggles:hover .toggle {
            display: block;
        }
        .toggles:hover iron-icon {
            display: none;
        }
        .stat-toggles {
            @apply(--layout-horizontal);
            @apply(--layout-end);
            @apply(--layout-flex);
            position: absolute;
            top: 13px;
            right: 13px;
        }
        .stat-toggle {
            @apply(--layout-center);
            @apply(--layout-justified);
            @apply(--layout-horizontal);
            background-color: var(--primary-background-color);
            border: 2px solid #FFFFFF;
            border-radius: 6px;
            color: #FFFFFF;
            cursor: pointer;
            font-size: 1vw;
            font-weight: 500;
            margin: 0.5vw 1vw 0 0;
            padding: 0.8vw 1.1vw;
            position: relative;
            text-transform: uppercase;
            z-index: 5;
            width: 200px;
        }
        [data-graph="power"] {
            --paper-radio-button-checked-color: #f7a017;
            --paper-radio-button-checked-ink-color: #f7a017;
        }
        [data-graph="heartRate"] {
            --paper-radio-button-checked-color: #683a78;
            --paper-radio-button-checked-ink-color: #683a78;
        }
        [data-graph="pace"] {
            --paper-radio-button-checked-color: #074a8c;
            --paper-radio-button-checked-ink-color: #074a8c;
        }
        [data-graph="elevation"] {
            --paper-radio-button-checked-color: #a06a81;
            --paper-radio-button-checked-ink-color: #a06a81;
        }
        [data-graph="cadence"] {
            --paper-radio-button-checked-color: #5ea7a1;
            --paper-radio-button-checked-ink-color: #5ea7a1;
        }
        [data-graph="groundTime"] {
            --paper-radio-button-checked-color: #00ACEE;
            --paper-radio-button-checked-ink-color: #00ACEE;
        }
        [data-graph="vertOsc"] {
            --paper-radio-button-checked-color: #2BAF2B;
            --paper-radio-button-checked-ink-color: #2BAF2B;
        }
        [data-graph="formPower"] {
            --paper-radio-button-checked-color: #AB5400;
            --paper-radio-button-checked-ink-color: #AB5400;
        }
        [data-graph="devicePace"] {
            --paper-radio-button-checked-color: #B3B8BC;
            --paper-radio-button-checked-ink-color: #B3B8BC;
        }
        [data-graph="legSpring"] {
            --paper-radio-button-checked-color: #E94F65;
            --paper-radio-button-checked-ink-color: #E94F65;
        }
        .toggle .circle, .stat-toggle .circle {
            width: 1.3vw;
            height: 1.3vw;
            border-radius: 50%;
            border: 3px #FFFFFF solid;
            z-index: 2;
        }
        .toggle .type {
            z-index: 2;
        }
        .toggle paper-radio-button {
            padding-bottom: 15px;
            padding-left: 10px;
        }
        .toggle paper-radio-button:first-child {
            padding-top: 15px;
        }

        .bubbles {
            @apply(--layout-horizontal);
            @apply(--layout-around-justified);
            @apply(--layout-wrap);
            padding: 1vw 1vw;
        }
        bubble-stat {
            width: 10vw;
            height: 10vw;
            margin: 1vw;
            --bubble-stat-wrap: {
                width: 10vw;
                height: 10vw;
            };
            --bubble-stat-border: {
                width: 10vw;
                height: 10vw;
            };
        }

        .outer-spinner {
            margin: 0;
            padding: 0;
            position: absolute;
            background-color: var(--primary-background-color);
            z-index: 10;
            @apply(--layout-horizontal);
            @apply(--layout-center)
            @apply(--layout-center-justified)
            transition: opacity 2s;
            opacity: 1;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            z-index: 12;
        }
        .outer-spinner.fade {
            opacity: 0;
            z-index: 0;
        }

        .spinner {
            margin: 100px auto;
            width: 40px;
            height: 40px;
            -webkit-animation: sk-rotate 2.0s infinite linear;
            animation: sk-rotate 2.0s infinite linear;
        }
        .spinner .dot1, .spinner .dot2 {
            width: 60%;
            height: 60%;
            display: inline-block;
            position: absolute;
            top: 0;
            background-color: var(--primary-icon-color);
            border-radius: 100%;
            -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
            animation: sk-bounce 2.0s infinite ease-in-out;
        }
        .spinner .dot2 {
            top: auto;
            bottom: 0;
            -webkit-animation-delay: -1.0s;
            animation-delay: -1.0s;
        }

        @-webkit-keyframes sk-rotate { 100% { -webkit-transform: rotate(360deg) }}
        @keyframes sk-rotate { 100% { transform: rotate(360deg); -webkit-transform: rotate(360deg) }}

        @-webkit-keyframes sk-bounce {
            0%, 100% { -webkit-transform: scale(0.0) }
            50% { -webkit-transform: scale(1.0) }
        }
        @keyframes sk-bounce {
            0%, 100% { 
                transform: scale(0.0);
                -webkit-transform: scale(0.0);
            } 50% { 
                transform: scale(1.0);
                -webkit-transform: scale(1.0);
            }
        }
    </style>
    <template>
        <div class="outer-spinner" id="spinner">
            <div class="spinner">
                <div class="dot1"></div>
                <div class="dot2"></div>
            </div>
        </div>
        <div class="layout horizontal end options">
            <h1 class="header">Statistics</h1>
            <div class="stat-toggles hidden">
                <div class="stat-toggle"
                data-toggle="on"
                on-click="toggleMetrics"
                data-stat="elapsed">
                    <div class="type">Elapsed Statistics</div>
                    <div class="circle"></div>
                </div>
                <div class="stat-toggle"
                data-toggle="off"
                on-click="toggleMetrics"
                data-stat="moving">
                    <div class="type">Moving Statistics</div>
                    <div class="circle"></div>
                </div>
            </div>
        </div>
        <div class="layout horizontal">
            <div class="layout vertical flex">
                <div class="bubbles">
                    <bubble-stat id="pace"></bubble-stat>
                    <bubble-stat id="time"></bubble-stat>
                    <bubble-stat id="power"></bubble-stat>
                    <bubble-stat id="heartRate"></bubble-stat>
                    <bubble-stat id="dynamics"></bubble-stat>
                    <bubble-stat id="misc"></bubble-stat>
                </div>
            </div>
        </div>
        <div class="layout horizontal" style="position: relative; width: 100%;">
            <div id="chartdiv"></div>
            <div class="toggles">
                <iron-icon icon="icons:menu"></iron-icon>
                <div class="toggle">
                    <paper-radio-button on-click="toggle" data-graph="power" checked="true">Power</paper-radio-button>
                    <paper-radio-button on-click="toggle" data-graph="heartRate" checked="true">Heart Rate</paper-radio-button>
                    <paper-radio-button on-click="toggle" data-graph="pace">Pace</paper-radio-button>
                    <paper-radio-button on-click="toggle" data-graph="elevation">Elevation</paper-radio-button>
                    <paper-radio-button on-click="toggle" data-graph="cadence">Cadence</paper-radio-button>
                    <paper-radio-button on-click="toggle" data-graph="groundTime">Ground Time</paper-radio-button>
                    <paper-radio-button on-click="toggle" data-graph="vertOsc">Vertical Oscillation</paper-radio-button>
                    <paper-radio-button on-click="toggle" data-graph="legSpring">Leg Spring Stiffness</paper-radio-button>
                    <paper-radio-button on-click="toggle" data-graph="formPower">Form Power</paper-radio-button>
                    <paper-radio-button on-click="toggle" data-graph="devicePace">Foot Pod Pace</paper-radio-button>
                </div>
            </div>
        </div>
        <div class="layout vertical" style="padding-bottom: 5vh;">
            <div class="layout horizontal center center-justified">
                <paper-textarea
                    class="editable"
                    label="Description"
                    rows="1"
                    max-rows="3"
                    value="{{descriptionText}}"
                    id="descriptionInput"
                    style="flex: 0 70%;">
                </paper-textarea>
                <button is="stryd-button" id="descriptionButton" on-click="" style="margin-left: 10px;">Save</button> 
            </div>
            <p id="descriptionDisplay" style="color: white;">{{descriptionText}}</p>
        </div>
    </template>
    <script>
    /*global AmCharts*/
    /*jshint camelcase: false */
    /*global updateWorkout*/
    Polymer({
        is: 'workout-element',
        switchMetric: function (metric, state) {
            if (state === 'off' ||
                (state === 'flip' &&
                this.metrics[metric].toggle.checked === false)
            ) {
                this.metrics[metric].toggle.checked = false;
                this.chart.hideGraph(this.metrics[metric].graph());
            } else {
                this.metrics[metric].toggle.checked = true;
                this.chart.showGraph(this.metrics[metric].graph());
            }
        },
        ready: function () {
            this.activity = null;
            this.descriptionText = '';
            this.$.descriptionInput.addEventListener(
                'blur',
                () => {
                    if (this.activity !== null) {
                        updateWorkout(
                            this.activity.id,
                            {
                                description: this.descriptionText
                            },
                            null
                        );
                    }
                }
            );

            AmCharts.handleLoad();
            //this.fillzones();
            this.metrics = {
                heartRate: {
                    toggle: this.querySelector('[data-graph="heartRate"]'),
                    graph: () => {
                        return this.chart.getGraphById('heartRate');
                    },
                    axis: {
                        'id': 'heartRate',
                        'position': 'left',
                        'axisThickness': 2,
                        'gridAlpha': 0.2,
                        'axisColor': '#683a78',
                        'dashLength': 1
                    },
                    info: {
                        'id': 'heartRate',
                        'valueAxis': 'heartRate',
                        'bullet': 'round',
                        'bulletBorderAlpha': 1,
                        'bulletColor': '#FFFFFF',
                        'bulletSize': 5,
                        'hideBulletsCount': 50,
                        'lineThickness': 2,
                        'title': 'heartRate',
                        'useLineColorForBulletBorder': true,
                        'valueField': 'heartRate',
                        'type': 'smoothedLine',
                        'balloonText': '[[value]] BPM',
                        'lineColor': '#683a78'
                    }
                },
                power: {
                    toggle: this.querySelector('[data-graph="power"]'),
                    graph: () => {
                        return this.chart.getGraphById('power');
                    },
                    axis: {
                        'id': 'power',
                        'position': 'right',
                        'offset': 0,
                        'axisThickness': 2,
                        'gridAlpha': 0.2,
                        'axisColor': '#f7a017',
                        'dashLength': 1
                    },
                    info: {
                        'id': 'power',
                        'valueAxis': 'power',
                        'bullet': 'round',
                        'bulletBorderAlpha': 1,
                        'bulletColor': '#FFFFFF',
                        'bulletSize': 5,
                        'hideBulletsCount': 50,
                        'lineThickness': 2,
                        'title': 'power',
                        'useLineColorForBulletBorder': true,
                        'valueField': 'power',
                        'type': 'line',
                        'balloonText': '[[value]] Watts',
                        'lineColor': '#f7a017'
                    }
                },
                formPower: {
                    toggle: this.querySelector('[data-graph="formPower"]'),
                    graph: () => {
                        return this.chart.getGraphById('formPower');
                    },
                    axis: {
                        'id': 'formPower',
                        'position': 'left',
                        'offset': 0,
                        'axisThickness': 2,
                        'gridAlpha': 0.2,
                        'axisColor': '#DF7B0B',
                        'dashLength': 1
                    },
                    info: {
                        'id': 'formPower',
                        'valueAxis': 'formPower',
                        'bullet': 'round',
                        'bulletBorderAlpha': 1,
                        'bulletColor': '#FFFFFF',
                        'bulletSize': 5,
                        'hideBulletsCount': 50,
                        'lineThickness': 2,
                        'title': 'formPower',
                        'useLineColorForBulletBorder': true,
                        'valueField': 'formPower',
                        'type': 'line',
                        'balloonText': '[[value]] Watts',
                        'lineColor': '#DF7B0B'
                    }
                },
                pace: {
                    toggle: this.querySelector('[data-graph="pace"]'),
                    graph: () => {
                        return this.chart.getGraphById('pace');
                    },
                    axis: {
                        'id': 'pace',
                        'position': 'right',
                        'offset': 40,
                        'axisThickness': 2,
                        'gridAlpha': 0.2,
                        'axisColor': '#074a8c',
                        'dashLength': 1,
                        'labelFunction': speedToPaceForValueAxis
                    },
                    info: {
                        'id': 'pace',
                        'valueAxis': 'pace',
                        'bullet': 'round',
                        'bulletBorderAlpha': 1,
                        'bulletColor': '#FFFFFF',
                        'bulletSize': 5,
                        'hideBulletsCount': 50,
                        'lineThickness': 2,
                        'title': 'pace',
                        'useLineColorForBulletBorder': true,
                        'valueField': 'pace',
                        'type': 'smoothedLine',
                        'balloonFunction': speedToPaceForBalloon,
                        'balloonText': '[[value]] Min/Mile',
                        'lineColor': '#074a8c',
                    }
                },
                cadence : {
                    toggle: this.querySelector('[data-graph="cadence"]'),
                    graph: () => {
                        return this.chart.getGraphById('cadence');
                    },
                    axis: {
                        'id': 'cadence',
                        'position': 'left',
                        'offset': 40,
                        'axisThickness': 2,
                        'gridAlpha': 0.2,
                        'axisColor': '#5ea7a1',
                        'dashLength': 1
                    },
                    info: {
                        'id': 'cadence',
                        'valueAxis': 'cadence',
                        'bullet': 'round',
                        'bulletBorderAlpha': 1,
                        'bulletColor': '#FFFFFF',
                        'bulletSize': 5,
                        'hideBulletsCount': 50,
                        'lineThickness': 2,
                        'title': 'cadence',
                        'useLineColorForBulletBorder': true,
                        'valueField': 'cadence',
                        'type': 'smoothedLine',
                        'balloonText': '[[value]] SPM',
                        'lineColor': '#5ea7a1'
                    }
                },
                elevation: {
                    toggle: this.querySelector('[data-graph="elevation"]'),
                    graph: () => {
                        return this.chart.getGraphById('elevation');
                    },
                    axis: {
                        'id': 'elevation',
                        'position': 'right',
                        'offset': 80,
                        'axisThickness': 2,
                        'gridAlpha': 0.2,
                        'axisColor': '#a06a81',
                        'dashLength': 1
                    },
                    info: {
                        'id': 'elevation',
                        'valueAxis': 'elevation',
                        'bullet': 'round',
                        'bulletBorderAlpha': 1,
                        'bulletColor': '#FFFFFF',
                        'bulletSize': 5,
                        'hideBulletsCount': 50,
                        'lineThickness': 2,
                        'title': 'elevation',
                        'useLineColorForBulletBorder': true,
                        'valueField': 'elevation',
                        'type': 'smoothedLine',
                        'balloonText': '[[value]] Meters',
                        'lineColor': '#a06a81',
                    }
                },
                groundTime: {
                    toggle: this.querySelector('[data-graph="groundTime"]'),
                    graph: () => {
                        return this.chart.getGraphById('groundTime');
                    },
                    axis: {
                        'id': 'groundTime',
                        'position': 'left',
                        'offset': 80,
                        'axisThickness': 2,
                        'gridAlpha': 0.2,
                        'axisColor': '#00ACEE',
                        'dashLength': 1,
                        'stackType': '3d'
                    },
                    info: {
                        'id': 'groundTime',
                        'valueAxis': 'groundTime',
                        'bullet': 'round',
                        'bulletBorderAlpha': 1,
                        'bulletColor': '#FFFFFF',
                        'bulletSize': 5,
                        'hideBulletsCount': 50,
                        'lineThickness': 2,
                        'title': 'groundTime',
                        'useLineColorForBulletBorder': true,
                        'valueField': 'groundTime',
                        'type': 'smoothedLine',
                        'balloonText': '[[value]] MS',
                        'lineColor': '#00ACEE',
                    }
                },
                vertOsc: {
                    toggle: this.querySelector('[data-graph="vertOsc"]'),
                    graph: () => {
                        return this.chart.getGraphById('vertOsc');
                    },
                    axis: {
                        'id': 'vertOsc',
                        'position': 'right',
                        'offset': 40,
                        'axisThickness': 2,
                        'gridAlpha': 0.2,
                        'axisColor': '#2BAF2B',
                        'dashLength': 1,
                        'stackType': '3d'
                    },
                    info: {
                        'id': 'vertOsc',
                        'valueAxis': 'vertOsc',
                        'bullet': 'round',
                        'bulletBorderAlpha': 1,
                        'bulletColor': '#FFFFFF',
                        'bulletSize': 5,
                        'hideBulletsCount': 50,
                        'lineThickness': 2,
                        'title': 'vertOsc',
                        'useLineColorForBulletBorder': true,
                        'valueField': 'vertOsc',
                        'type': 'smoothedLine',
                        'balloonText': '[[value]] CM',
                        'lineColor': '#2BAF2B'
                    }
                },
                legSpring: {
                    toggle: this.querySelector('[data-graph="legSpring"]'),
                    graph: () => {
                        return this.chart.getGraphById('legSpring');
                    },
                    axis: {
                        'id': 'legSpring',
                        'position': 'right',
                        'offset': 40,
                        'axisThickness': 2,
                        'gridAlpha': 0.2,
                        'axisColor': '#E94F65',
                        'dashLength': 1,
                        'stackType': '3d'
                    },
                    info: {
                        'id': 'legSpring',
                        'valueAxis': 'legSpring',
                        'bullet': 'round',
                        'bulletBorderAlpha': 1,
                        'bulletColor': '#FFFFFF',
                        'bulletSize': 5,
                        'hideBulletsCount': 50,
                        'lineThickness': 2,
                        'title': 'legSpring',
                        'useLineColorForBulletBorder': true,
                        'valueField': 'legSpring',
                        'type': 'smoothedLine',
                        'balloonText': '[[value]] kN/m',
                        'lineColor': '#E94F65'
                    }
                }
            };
        },
        setChartData: function (data, activity, activityMetrics) {
            this.setLoading();

            this.activity = activity;
            this.descriptionText = activity.description;
            if (jwt.hasToken &&
                'user_id' in this.activity &&
                jwt.data.id === this.activity.user_id) {
                this.$.descriptionInput.classList.remove('hidden');
                this.$.descriptionButton.classList.remove('hidden');
                this.$.descriptionDisplay.classList.add('hidden');
            } else {
                this.$.descriptionInput.classList.add('hidden');
                this.$.descriptionButton.classList.add('hidden');
                this.$.descriptionDisplay.classList.remove('hidden');
            }

            this.data = data;
            this.availableMetrics = [];
            this.startTime = this.data[0].date;
            for (var val of activityMetrics) {
                if (val in this.metrics) {
                    this.availableMetrics.push(val);
                }
            }
            var valueAxes = [], graphs = [];
            for (val of this.availableMetrics) {
                valueAxes.push(this.metrics[val].axis);
                graphs.push(this.metrics[val].info);
            }

            this.fillChart(valueAxes, graphs);
            if ('chart' in this) {
                this.bindToggles();
            }
        },
        removeLoading: function () {
            this.$.spinner.classList.remove('show');
            this.$.spinner.classList.add('hide');
            this.$.spinner.classList.add('fade');
            this.$.spinner.style.zIndex = -1;
        },
        setLoading: function () {
            this.$.spinner.classList.add('show');
            this.$.spinner.classList.remove('hide');
            this.$.spinner.classList.remove('fade');
            this.$.spinner.style.zIndex = 12;
        },
        toggleMetrics: function (e) {
            var target = e.target;
            while (!('stat' in target.dataset)) {
                target = target.parentElement;
            }
            var opt = target.dataset.stat;

            /* Change visual state */
            var active = this.querySelector('[data-toggle="on"].stat');
            active.dataset.toggle = 'off';
            target.dataset.toggle = 'on';
            
            var bubbles = this.querySelectorAll('bubble-stat');
            for (var bubble of bubbles) {
                bubble.setMode(opt);
            }
        },
        bindToggles: function () {
            for (var key in this.metrics) {
                if (this.availableMetrics.indexOf(key) === -1) {
                    this.metrics[key].toggle.classList.add('hidden');
                } else {
                    this.metrics[key].toggle.classList.remove('hidden');
                }
            }
            var hiddenMetrics = [];
            if (this.availableMetrics.indexOf('heartRate') > -1) {
                hiddenMetrics = ['pace', 'elevation', 'cadence', 'groundTime', 'vertOsc', 'legSpring', 'formPower'];
            } else {
                hiddenMetrics = ['pace', 'elevation', 'cadence', 'groundTime', 'vertOsc', 'legSpring'];
            }
            for (key of this.availableMetrics) {
                if (hiddenMetrics.indexOf(key) > -1) {
                    this.switchMetric(key, 'off');
                } else {
                    this.switchMetric(key, 'on');
                }
            }
            this.switchMetric('power', 'on');
        },
        toggle: function (e) {
            var target = e.target;
            while (!('graph' in target.dataset)) {
                target = target.parentElement;
            }
            var graph = target.dataset.graph;
            this.switchMetric(graph, 'flip');
        },
        calcAvgs: function (begin, end) {
            var total = end - begin;

            var distance = this.data[end-1].distance - this.data[begin].distance;

            var paceUnit = 'Min/KM';
            var distanceUnit = 'KM';
            var distanceDisplay;
            var distanceValue;
            if (user.data.units === 'feet') {
                paceUnit = 'Min/Mi';
                distanceUnit = 'Mi';
                distanceDisplay = meterToMile(distance, 1);
                distanceValue = distance/1609.34;
            } else {
                distanceDisplay = meterToKM(distance);
                distanceValue = distance/1000;
            }

            var pace = {
                active: ['pace'],
                pace: {
                    icon: 'maps:directions-run',
                    title: 'Pace',
                    moving: 0,
                    elapsed: 0,
                    unit: paceUnit
                },
                maxPace: {
                    icon: 'maps:directions-run',
                    title: 'Max Pace',
                    value: 0,
                    unit: paceUnit
                }
            };
            var time = {
                active: ['time'],
                time: {
                    icon: 'image:timer',
                    title: 'Time',
                    value: 0,
                    moving: 0,
                    elapsed: 0,
                    mseconds: 0,
                    unit: 'HH:MM:SS'
                },
                totalTime: {
                    icon: 'image:timer',
                    title: 'Total Time',
                    value: 0,
                    unit: 'HH:MM:SS'
                }
            };
            var power = {
                active: ['power'],
                power: {
                    icon: 'image:flash-on',
                    title: 'Power',
                    moving: 0,
                    elapsed: 0,
                    mTotal: 0,
                    unit: 'Watts'
                },
                maxPower: {
                    icon: 'image:flash-on',
                    title: 'Max Power',
                    value: 0,
                    unit: 'Watts'
                },
                timeInMaxZone: {
                    icon: 'image:flash-on',
                    title: 'Time in Max Zone',
                    value: 0,
                    unit: 'Watts'
                }
            };
            var heartRate = {
                active: ['heartRate'],
                heartRate: {
                    icon: 'favorite',
                    title: 'HR',
                    moving: 0,
                    elapsed: 0,
                    mTotal: 0,
                    value: 0,
                    sum: 0,
                    total: 0,
                    unit: 'BPM'
                },
                maxHR: {
                    icon: 'favorite',
                    title: 'Max Heart Rate',
                    value: 0,
                    unit: 'BPM'
                }
            };
            var dynamics = {
                active: ['cadence', 'groundTime', 'vertOsc'],
                cadence: {
                    icon: 'maps:directions-walk',
                    title: 'Cadence',
                    elapsed: 0,
                    moving: 0,
                    mTotal: 0,
                    unit: 'SPM'
                },
                groundTime: {
                    icon: 'av:av-timer',
                    title: 'Ground Time',
                    elapsed: 0,
                    moving: 0,
                    mTotal: 0,
                    unit: 'MS'
                },
                vertOsc: {
                    icon: 'communication:call-missed',
                    title: 'Vert. Osc.',
                    elapsed: 0,
                    moving: 0,
                    mTotal: 0,
                    unit: 'CM'
                }
            };
            var form = {
                active: ['formPower', 'legSpring'],
                formPower: {
                    icon: 'places:hot-tub',
                    title: 'Form Power',
                    elapsed: 0,
                    moving: 0,
                    mTotal: 0,
                    unit: 'Watts'
                },
                legSpring: {
                    icon: 'image:leak-add',
                    title: 'Leg Spring',
                    elapsed: 0,
                    moving: 0,
                    mTotal: 0,
                    unit: 'kN/M'
                }
            };
            var misc = {
                active: [],
                distance: {
                    icon: 'communication:swap-calls',
                    title: 'Distance',
                    value: 0,
                    unit: distanceUnit
                }
            };

            var milliseconds = this.data[end-1].date - this.data[begin].date;
            var elapsedHMS = hmsTime(milliseconds);
            var seconds = milliseconds / 1000;
            time.totalTime.value = elapsedHMS;

            for (var i = begin; i < end; i++) {
                var data = this.data[i];

                var timeSectionMSeconds = 1000;
                if (i !== end - 1) {
                    timeSectionMSeconds = this.data[i+1].date - this.data[i].date;
                }

                if ('pace' in data) {
                    if (data.pace > pace.maxPace.value) {
                        pace.maxPace.value = data.pace;
                    }
                }

                if ('power' in data) {
                    if (data.power > power.maxPower.value) {
                        power.maxPower.value = data.power.toFixed(0);
                    }
                    if (data.power > 0) {
                        time.time.moving += timeSectionMSeconds;
                    }
                    power.power.elapsed += data.power;
                    if (data.power > 10) {
                        power.power.moving += data.power;
                        power.power.mTotal += 1;
                    }

                    if (data.power > 300) {
                        power.timeInMaxZone.value += timeSectionMSeconds;
                    }
                }

                time.time.elapsed += timeSectionMSeconds;

                if ('heartRate' in data && 'power' in data) {
                    if (data.heartRate > heartRate.maxHR.value) {
                        heartRate.maxHR.value = data.heartRate;
                    }

                    heartRate.heartRate.elapsed += data.heartRate;

                    if (data.power > 10) {
                        heartRate.heartRate.moving += data.heartRate;
                        heartRate.heartRate.mTotal += 1;
                    }
                }

                if ('cadence' in data) {
                    dynamics.cadence.elapsed += data.cadence;
                    if (data.power > 10) {
                        dynamics.cadence.moving += data.cadence;
                        dynamics.cadence.mTotal += 1;
                    }
                }

                if ('groundTime' in data && 'power' in data) {
                    dynamics.groundTime.elapsed += data.groundTime;
                    if (data.power > 10) {
                        dynamics.groundTime.moving += data.groundTime;
                        dynamics.groundTime.mTotal += 1;
                    }
                }

                if ('vertOsc' in data && 'power' in data) {
                    dynamics.vertOsc.elapsed += data.vertOsc;
                    if (data.power > 10) {
                        dynamics.vertOsc.moving += data.vertOsc;
                        dynamics.vertOsc.mTotal += 1;
                    }
                }

                if ('formPower' in data && 'power' in data) {
                    form.formPower.elapsed += data.formPower;
                    if (data.power > 10) {
                        form.formPower.moving += data.formPower;
                        form.formPower.mTotal += 1;
                    }
                }

                if ('legSpring' in data && 'power' in data) {
                    form.legSpring.elapsed += data.legSpring;
                    if (data.power > 10) {
                        form.legSpring.moving += data.legSpring;
                        form.legSpring.mTotal += 1;
                    }
                }
            }

            var elapsedMinutes = seconds / 60;
            var movingMinutes = time.time.moving / 1000 / 60;

            var elapsedDec = elapsedMinutes / distanceValue;
            var movingDec = movingMinutes / distanceValue;
            var maxPace = speedToPace(pace.maxPace.value, user.data.units);

            pace.pace.elapsed = formatPace(elapsedDec);
            pace.pace.moving = formatPace(movingDec);
            pace.maxPace.value = maxPace;

            power.power.moving = (power.power.moving / power.power.mTotal).stat();
            power.power.elapsed = (power.power.elapsed / total).stat();

            heartRate.heartRate.moving = (heartRate.heartRate.moving / heartRate.heartRate.mTotal).stat();
            heartRate.heartRate.elapsed = (heartRate.heartRate.elapsed / total).stat();

            time.time.elapsed = hmsTime(time.time.elapsed);
            time.time.moving = hmsTime(time.time.moving);

            if (isNaN(distance)) {
                misc.distance.value = 'Not';
                misc.distance.unit = 'Available';
            }
            misc.distance.value = distanceDisplay;
            misc.distance.unit = distanceUnit;

            dynamics.cadence.moving = (dynamics.cadence.moving / dynamics.cadence.mTotal).stat();
            dynamics.cadence.elapsed = (dynamics.cadence.elapsed / total).stat();

            if (dynamics.groundTime.elapsed !== 0) {
                dynamics.groundTime.moving = (dynamics.groundTime.moving / dynamics.groundTime.mTotal).stat();
                dynamics.groundTime.elapsed = (dynamics.groundTime.elapsed / total).stat();
            } else {
                delete dynamics.groundTime;
            }

            if (dynamics.vertOsc.elapsed !== 0) {
                dynamics.vertOsc.moving = (dynamics.vertOsc.moving / dynamics.vertOsc.mTotal).stat();
                dynamics.vertOsc.elapsed = (dynamics.vertOsc.elapsed / total).stat();
            } else {
                delete dynamics.vertOsc;
            }

            if (form.formPower.elapsed !== 0) {
                form.formPower.moving = (form.formPower.moving / form.formPower.mTotal).stat();
                form.formPower.elapsed = (form.formPower.elapsed / total).stat();
            } else {
                delete form.formPower;
            }

            if (form.legSpring.elapsed !== 0) {
                form.legSpring.moving = (form.legSpring.moving / form.legSpring.mTotal).stat();
                form.legSpring.elapsed = (form.legSpring.elapsed / total).stat();
            } else {
                delete form.legSpring;
            }

            delete heartRate.movingHR;
            delete power.timeInMaxZone;
            this.$.pace.setData(pace);
            this.$.time.setData(time);
            this.$.power.setData(power);
            if (this.availableMetrics.indexOf('heartRate') > -1) {
                this.$.heartRate.setData(heartRate);
            } else {
                this.$.heartRate.setData(form);
            }
            this.$.dynamics.setData(dynamics);
            this.$.misc.setData(misc);
        },
        fillChart: function (valueAxes, graphs) {
            this.chart = AmCharts.makeChart(
                this.$.chartdiv,
                {
                    'type': 'serial',
                    'theme': 'stryd',
                    'autoResize': true,
                    'autoMarginOffset': 20,
                    'valueAxes': valueAxes,
                    'graphs': graphs,
                    'valueScrollbar':{
                        'oppositeAxis': true,
                        'offset': 50,
                        'scrollbarHeight': 10
                    },
                    'chartScrollbar': {
                        'graph': 'power',
                        'autoGridCount': false,
                        'scrollbarHeight': 50,
                        'offset': 30,
                        'backgroundAlpha': 0,
                        'selectedBackgroundAlpha': 0.2,
                        'selectedBackgroundColor': '#ababab',
                        'graphFillAlpha': 0,
                        'graphLineAlpha': 0.2,
                        'selectedGraphFillAlpha': 0,
                        'selectedGraphLineAlpha': 0.5,
                        'oppositeAxis': false
                    },
                    'categoryField': 'date',
                    'categoryAxis': {
                        'parseDates': false,
                        'minorGridEnabled': true,
                        'axisAlpha': 0,
                        'gridAlpha': 0,
                        'gridCount': 0,
                        'gridThickness': 0,
                        /*jshint unused: false */
                        categoryFunction: (a, d, b) => {
                            var timeDiff = a.getTime() - this.startTime.getTime();
                            return hmsTime(timeDiff);
                        }
                    },
                    'chartCursor': {},
                    'balloon': {
                        'adjustBorderColor': true,
                        'color': '#1e1e1e',
                        'cornerRadius': 5,
                        'borderThickness': 2,
                        'fillColor': '#FFFFFF',
                        'shadowAlpha': 0,
                        'fontSize': 16,
                        'verticalPadding': 4,
                        'horizontalPadding': 8
                    },
                    'dataProvider': this.data,
                    'pathToImages': 'https://www.stryd.com/powercenter/scripts/amcharts/images/'
                },
                0
            );

            this.chart.addListener('init', (e) => {
                this.removeLoading();
                this.bindToggles();
                this.calcAvgs(0, this.data.length);
            });

            this.chart.addListener('zoomed', (e) => {
                this.calcAvgs(e.startIndex, e.endIndex + 1);
            });
        }
    });
    </script>
</dom-module>
