<dom-module id="workout-element">
  <link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
  <link rel="import" href="../../styles/app-theme.html">
  <link rel="import" href="../bubble-stat/bubble-stat.html">
  <link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
  <style>
    section {
        @apply(--layout);
        @apply(--layout-vertical);
        background-color: var(--primary-background-color);
    }
    h2.subheader {
        text-transform: uppercase;
        color: #FFFFFF;
        font-size: 12px;
        margin: 0;
    }
    h1.header {
        @apply(--header);
    }
    .seperator {
        display: block;
        margin: 5px 0;
        height: 1px;
        border-top: 1px solid #5B5B5B;
    }
    .toggles {
        @apply(--layout-flex);
    }
    .chart {
        display: block;
        width: 100%;
        height: 450px;
    }
    .summary {
        background-color: rgba(41, 41, 39, 0.9); 
        padding: 30px;
        border-top-left-radius: 30px;
        border-bottom-left-radius: 30px;
        height: 500px;
    }
    .insights {
        list-style: none;
        margin: 0;
        padding: 0;
        @apply(--layout);
        @apply(--layout-vertical);
        color: #FFFFFF;
    }
    .insight {
        @apply(--layout-flex);
        @apply(--layout);
        @apply(--layout-horizontal);
        margin: 10px 0;
    }
    .insight .info {
        @apply(--layout-flex-9);
        @apply(--layout-horizontal);
    }
    .insight .cell {
        display: block;
        font-size: 24px;
        @apply(--layout);
        @apply(--layout-start-justified);
        @apply(--layout-vertical);
    }
    .insight .icon {
        @apply(--layout-flex);
        @apply(--layout);
        @apply(--layout-horizontal);
        @apply(--layout-self-end);
        padding-right: 30px;
        color: var(--primary-icon-color);
        fill: var(--primary-icon-color);
    }
    .insight .icon iron-icon {
        height: 50px;
        width: 50px;
    }
    .insight .info .title {
        font-size: 12px;
        text-transform: uppercase;
    }
    .insight .info .field {
        font-size: 24px;
    }
    #chartdiv {
        /*background: #3f3f4f;*/
        color: #ffffff;       
        min-width: 100%;
        height: 450px;
    }
    button {
        padding: 12px 17px;
        border: 2px solid #FFFFFF;
        border-radius: 6px;
        margin: 3px 8px;
        cursor: pointer;
        background-color: var(--primary-background-color);
        text-transform: uppercase;
        color: #FFFFFF;
        font-size: 16px;
        font-weight: 500;
        overflow: none;
    }
    .toggle {
        @apply(--layout);
        @apply(--layout-horizontal);
        flex-wrap: no-wrap;
        padding: 12px 17px;
        border: 2px solid #FFFFFF;
        border-radius: 6px;
        margin: 0px 8px;
        cursor: pointer;
        background-color: var(--primary-background-color);
        text-transform: uppercase;
        color: #FFFFFF;
        font-size: 16px;
        font-weight: 500;
        overflow: auto;
        @apply(--layout-center);
        z-index: 5;

    }
    .toggle .circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px #FFFFFF solid;
        margin-left: 15px;
        @apply(--layout-flex-auto);
        z-index: 2;
    }
    .toggle .type {
        @apply(--layout-flex-auto);
        z-index: 2;
    }
    .options {
        @apply(--layout);
        @apply(--layout-horizontal);
        padding: 0 50px;
    }
    .options h1 {
        @apply(--layout-flex-1);
    }
    .toggles {
        @apply(--layout);
        @apply(--layout-center);
        @apply(--layout-horizontal);

        @apply(--layout-flex-1);
        @apply(--layout-end-justified);

    }
    .toggles .heartRate[data-toggle="on"] {
        border-color: #683a78;
    }
    .toggles .heartRate[data-toggle="on"] .circle {
        border-color: #683a78;
        box-shadow: 0px 0px 5px #683a78;
        background-color: #683a78;
    }
    .toggles .power[data-toggle="on"] {
        border-color: #f7a017;
    }
    .toggles .power[data-toggle="on"] .circle {
        border-color: #f7a017;
        box-shadow: 0px 0px 5px #f7a017;
        background-color: #f7a017;
    }
    .toggles .cadence[data-toggle="on"] {
        border-color: #5ea7a1;
    }
    .toggles .cadence[data-toggle="on"] .circle {
        border-color: #5ea7a1;
        box-shadow: 0px 0px 5px #5ea7a1;
        background-color: #5ea7a1;
    }
    .toggles .pace[data-toggle="on"] {
        border-color: #074a8c;
    }
    .toggles .pace[data-toggle="on"] .circle {
        border-color: #074a8c;
        box-shadow: 0px 0px 5px #074a8c;
        background-color: #074a8c;
    }
    .toggles .elevation[data-toggle="on"] {
        border-color: #a06a81;
    }
    .toggles .elevation[data-toggle="on"] .circle {
        border-color: #a06a81;
        box-shadow: 0px 0px 5px #a06a81;
        background-color: #a06a81;
    }
    .bubbles {
        @apply(--layout);
        @apply(--layout-horizontal);
        padding: 40px;
    }
    .bubbles .filler {
        @apply(--layout-flex);
    }
    bubble-stat {
        @apply(--layout-flex-2);
    }
  </style>
  <template>
    <section>
        <h1 class="header" style="padding: 50px 0px 0px 50px;">Statistics</h1>
        <div class="bubbles">
            <div class="filler"></div>
            <bubble-stat
                type="avg_power"
                title="Average Power"
                unit="Watts">
            </bubble-stat>
            <bubble-stat
                type="avg_pace"
                title="Average Pace"
                unit="Min/Mile">
            </bubble-stat>
            <bubble-stat
                type="avg_hr"
                title="Average Heart Rate"
                unit="BPM">
            </bubble-stat>
            <bubble-stat
                type="max_hr"
                title="Max Heart Rate"
                unit="BPM">
            </bubble-stat>
            <bubble-stat
                type="time"
                title="Run Time"
                unit="HH:MM:SS">
            </bubble-stat>
            <div class="filler"></div>
        </div>
        <div class="options">
            <h1 class="header">Chart</h1>
            <div class="toggles">
                <div class="heartRate toggle" data-toggle="on" on-click="toggle" data-graph="heartRate">
                    <div class="type">Heart Rate</div>
                    <div class="circle"></div>
                </div>
                <div class="power toggle" data-toggle="on" on-click="toggle" data-graph="power">
                    <div class="type">Power</div>
                    <div class="circle"></div>
                </div>
                <div class="pace toggle" data-toggle="off" on-click="toggle" data-graph="pace">
                    <div class="type">Pace</div>
                    <div class="circle"></div>
                </div>
                <div class="cadence toggle" data-toggle="off" on-click="toggle" data-graph="cadence">
                    <div class="type">Cadence</div>
                    <div class="circle"></div>
                </div>
                <div class="elevation toggle" data-toggle="off" on-click="toggle" data-graph="elevation">
                    <div class="type">Elevation</div>
                    <div class="circle"></div>
                </div>
            </div>
        </div>
        <div class="chart">
            <div id="chartdiv"></div>
        </div>
    </section>
  </template>
  <script src="../../scripts/amcharts/amcharts.js"></script>
  <script src="../../scripts/amcharts/serial.js"></script>
  <script src="../../scripts/amcharts/themes/stryd.js"></script>
  <script>
    /*global AmCharts*/
    /*jshint camelcase: false */
  	Polymer({
        is: 'workout-element',
        ready: function () {
            AmCharts.handleLoad();
            this.style.display = 'hidden';
        },
        show: function () { 
            this.style.display = 'block';
        },
        setChartData: function (data) {
            this.show();
            this.data = data;
            this.chartData = this.data;
            this.startTime = this.data[0].date;
            this.fillChart();
        },
        calcAvgs: function (begin, end) {
            var i, total = end - begin - 1;
            var avgs = {
                power: 0,
                powerCount: 0,
                pace: 0,
                paceCount: 0,
                heartRate: 0,
                heartRateCount: 0,
                elevation: 0
            };
            var stats = {
                maxHeartRate: 0,
                timeHMS: hmsTime(setDate(total))
            };
            for (i = begin; i < end; i++) {
                if ('power' in this.data[0]) {
                    if (this.data[i].power > 5) {
                        avgs.powerCount += 1;
                        avgs.power += this.data[i].power;
                    }
                }
                if ('pace' in this.data[0]) {
                    avgs.paceCount += 1;
                    avgs.pace += this.data[i].pace;
                }
                if ('heartRate' in this.data[0]) {
                    if (this.data[i].heartRate > 5) {
                        avgs.heartRateCount += 1;
                        avgs.heartRate += this.data[i].heartRate;
                    }
                    if (this.data[i].heartRate > stats.maxHeartRate) {
                        stats.maxHeartRate = this.data[i].heartRate;
                    }
                }
                if ('elevation' in this.data[0]) {
                    avgs.elevation += this.data[i].elevation;
                }
            }
            avgs.power = avgs.power / avgs.powerCount;
            avgs.pace = avgs.pace / avgs.paceCount;
            avgs.heartRate = avgs.heartRate / avgs.heartRateCount;
            avgs.elevation = avgs.elevation / total;

            this.querySelector('[type="avg_power"]').setAttribute('value', avgs.power.stat());
            this.querySelector('[type="avg_pace"]').setAttribute('value', avgs.pace.stat());
            this.querySelector('[type="avg_hr"]').setAttribute('value', avgs.heartRate.stat());
            this.querySelector('[type="max_hr"]').setAttribute('value', stats.maxHeartRate.stat());
            this.querySelector('[type="time"]').setAttribute('value', stats.timeHMS);
        },
        bindToggles: function () {
            this.graphs = {
                heartRate: this.chart.getGraphById('heartRate'),
                pace: this.chart.getGraphById('pace'),
                cadence: this.chart.getGraphById('cadence'),
                power: this.chart.getGraphById('power'),
                elevation: this.chart.getGraphById('elevation')
            };
            this.querySelector('[data-graph="heartRate"]').dataset.toggle = 'on';
            this.querySelector('[data-graph="power"]').dataset.toggle = 'on';
            this.querySelector('[data-graph="pace"]').dataset.toggle = 'off';
            this.querySelector('[data-graph="cadence"]').dataset.toggle = 'off';
            this.querySelector('[data-graph="elevation"]').dataset.toggle = 'off';
            this.chart.hideGraph(this.graphs.pace);
            this.chart.hideGraph(this.graphs.cadence);
            this.chart.hideGraph(this.graphs.elevation);
        },
        toggle: function (e) {
            var target = e.target;
            while (!('graph' in target.dataset)) {
                target = target.parentElement;
            }
            var graph = target.dataset.graph;
            if (target.dataset.toggle === 'on') {
                target.dataset.toggle = 'off';
                this.chart.hideGraph(this.graphs[graph]);
            } else {
                target.dataset.toggle = 'on';
                this.chart.showGraph(this.graphs[graph]);
            }
        },
        fillChart: function () {
            this.chart = AmCharts.makeChart(this.$.chartdiv, {
                'type': 'serial',
                'theme': 'stryd',
                'autoMarginOffset': 20,
                'valueAxes': [{
                    'id': 'heartRate',
                    'axisAlpha': 1,
                    'position': 'left',
                    'axisThickness': 2,
                    'gridAlpha': 0.2,
                    'axisColor': '#683a78',
                    'dashLength': 1
                }, {
                    'id': 'pace',
                    'axisAlpha': 1,
                    'position': 'right',
                    'offset': 50,
                    'axisThickness': 2,
                    'gridAlpha': 0,
                    'axisColor': '#074a8c',
                    'dashLength': 1
                }, {
                    'id': 'cadence',
                    'axisAlpha': 1,
                    'position': 'left',
                    'offset': 50,
                    'axisThickness': 2,
                    'gridAlpha': 0,
                    'axisColor': '#5ea7a1',
                    'dashLength': 1
                }, {
                    'id': 'power',
                    'axisAlpha': 1,
                    'position': 'right',
                    'offset': 0,
                    'axisThickness': 2,
                    'gridAlpha': 0,
                    'axisColor': '#f7a017',
                    'dashLength': 1
                }, {
                    'id': 'elevation',
                    'axisAlpha': 1,
                    'position': 'right',
                    'offset': 100,
                    'axisThickness': 2,
                    'gridAlpha': 0,
                    'axisColor': '#a06a81',
                    'dashLength': 1
                }],
                'balloon': {
                    'borderThickness': 1,
                    'shadowAlpha': 0
                },
                'graphs': [{
                    'id': 'heartRate',
                    'valueAxis': 'heartRate',
                    'bullet': 'round',
                    'bulletBorderAlpha': 1,
                    'bulletColor': '#FFFFFF',
                    'bulletSize': 5,
                    'hideBulletsCount': 50,
                    'lineThickness': 2,
                    'title': 'heartRate',
                    'useLineColorForBulletBorder': true,
                    'valueField': 'heartRate',
                    'type': 'smoothedLine',
                    'balloonText': '<div style="margin:5px; font-size:19px;">[[value]] BPM</div>'
                }, {
                    'id': 'pace',
                    'valueAxis': 'pace',
                    'bullet': 'round',
                    'bulletBorderAlpha': 1,
                    'bulletColor': '#FFFFFF',
                    'bulletSize': 5,
                    'hideBulletsCount': 50,
                    'lineThickness': 2,
                    'title': 'pace',
                    'useLineColorForBulletBorder': true,
                    'valueField': 'pace',
                    'type': 'smoothedLine',
                    'balloonText': '<div style="margin:5px; font-size:19px;">[[value]] Min/Mile</div>'
                }, {
                    'id': 'cadence',
                    'valueAxis': 'cadence',
                    'bullet': 'round',
                    'bulletBorderAlpha': 1,
                    'bulletColor': '#FFFFFF',
                    'bulletSize': 5,
                    'hideBulletsCount': 50,
                    'lineThickness': 2,
                    'title': 'cadence',
                    'useLineColorForBulletBorder': true,
                    'valueField': 'cadence',
                    'type': 'smoothedLine',
                    'balloonText': '<div style="margin:5px; font-size:19px;">[[value]] SPM</div>'
                }, {
                    'id': 'power',
                    'valueAxis': 'power',
                    'bullet': 'round',
                    'bulletBorderAlpha': 1,
                    'bulletColor': '#FFFFFF',
                    'bulletSize': 5,
                    'hideBulletsCount': 50,
                    'lineThickness': 2,
                    'title': 'power',
                    'useLineColorForBulletBorder': true,
                    'valueField': 'power',
                    'type': 'smoothedLine',
                    'balloonText': '<div style="margin:5px; font-size:19px;">[[value]] Watts</div>'
                }, {
                    'id': 'elevation',
                    'valueAxis': 'elevation',
                    'bullet': 'round',
                    'bulletBorderAlpha': 1,
                    'bulletColor': '#FFFFFF',
                    'bulletSize': 5,
                    'hideBulletsCount': 50,
                    'lineThickness': 2,
                    'title': 'elevation',
                    'useLineColorForBulletBorder': true,
                    'valueField': 'elevation',
                    'type': 'smoothedLine',
                    'balloonText': '<div style="margin:5px; font-size:19px;">[[value]] Meters</div>'
                }],
                'chartScrollbar': {
                    'autoGridCount': false,
                    'graph': 'power',
                    'scrollbarHeight': 80,
                    'oppositeAxis': false
                },
                'chartCursor': {

                },
                'categoryField': 'date',
                'categoryAxis': {
                    'parseDates': false,
                    'dashLength': 1,
                    'minorGridEnabled': true,
                    'axisAlpha': 0.2,
                    'gridAlpha': 0,
                    /*jshint unused: false */
                    categoryFunction: function (a, d, b) {
                        var timeDiff = a.getTime() - this.startTime.getTime();
                        return hmsTime(timeDiff);
                    }.bind(this)
                },
                'export': {
                    'enabled': true
                },
                'dataProvider': this.chartData
            });
            function zoomChart(){
                this.chart.zoomToIndexes(
                    this.chart.dataProvider.length - 20,
                    this.chart.dataProvider.length - 1
                );
            }
            this.bindToggles();
            this.calcAvgs(0, this.chartData.length);
            this.chart.addListener('zoomed', function (e) {
                this.calcAvgs(e.startIndex, e.endIndex + 1);
            }.bind(this));
            // zoomChart();
        }
    });
  </script>
</dom-module>
