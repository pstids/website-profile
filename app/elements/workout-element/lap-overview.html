<dom-module id="lap-overview">
	<style>
		h1.header {
			@apply(--header);
		}
		h2.subtitle {
			@apply(--subtitle);
		}
		.title {
			padding: 20px;
			@apply(--layout-end);
		}
		table {
			color: white;
			border: 1px solid #4D4D4D;
			width: 100%;
		}
		table thead {
			background-color: #222222;
		}
		table tbody tr, table thead tr {
			display: flex;
			flex-direction: row;
			border-bottom: 1px solid #4D4D4D;
			cursor: pointer;
		}
		table tbody tr:last-child {
			border-bottom: 0;
		}
		table th, table td {
			flex: 1;
			padding: 6px 0;
			text-align: center;
		}

		paper-input input {
			text-align: center !important;
		}

		paper-dropdown-menu.test-selector {
			--paper-input-container-label: {
				color: white;
				font-weight: bold;
			};
			--paper-input-container-input: {
				color: white;
				font-style: normal;
			};
			/* no underline */
			--paper-input-container-underline: {
				color: white;
			};
		}

		paper-icon-button {
			color: white;
		}
		svg {
			width: 330px;
		}
	</style>
	<template>
		<div class="layout horizontal" id="container">
			<div class="layout vertical flex-3">
				<div class="layout horizontal title">
					<div class="flex">
						<h1 class="header">Laps</h1>
					</div>
					<div class="flex layout horizontal end-justified">
						<paper-dropdown-menu class="test-selector" label="Workout Type">
							<paper-menu class="dropdown-content" selected="{{selected_lap}}" id="lapType">
								<paper-item>Miles</paper-item>
								<paper-item>Kilometers</paper-item>
							</paper-menu>
						</paper-dropdown-menu>
					</div>
				</div>
				<div class="layout horizontal">
					<table>
						<thead>
							<tr>
								<th>Lap</th>
								<th>Power</th>
								<th>Time</th>
								<th>Distance</th>
								<th>Pace</th>
								<th>Form Power</th>
								<th>Leg Spring</th>
								<th>RSS</th>
							</tr>
						</thead>
						<tbody id="laps"></tbody>
					</table>
				</div>
			</div>
			<div class="layout vertical flex">
				<h1 class="header" style="padding: 20px;">Lap <span>{{lap_number}}</span></h1>
				<div class="layout horizontal center center-justified flex">
					<svg id="tiz233"></svg>
				</div>
			</div>
		</div>
	</template>
	<script>
	/* global lapProcessing */
	Polymer({
		is: 'lap-overview',
		listeners: {
			'tap': 'eleTap'
		},
		properties: {
			lap_number: Number
		},
		ready: function () {
			this.first = true;
			this.lapType = ['mi', 'km', 'split'];
			this.selected_lap = 0;
			this.$.lapType.addEventListener('iron-select', () => {
				if (this.first) {
					this.first = false;
					return;
				}
				var item = this.lapType[this.$.lapType.selected];
				lapProcessing(this.id, item);
			});
			this.lap_number = 1;
			this.laps = [];
		},
		eleTap: function (e) {
			var target = e.target;
			while (true) {
				if (target === this.$.container) {
					return;
				} else if ('dataset' in target && target.dataset.lap !== undefined) {
					this.lap_number = target.dataset.lap;
					var lapIdx = (+target.dataset.lap)-1;
					this.tiz(this.laps[lapIdx].tiz, this.laps[lapIdx].rss);

					Polymer.dom(target.classList.add('active'));
					return;
				}
				if ('parentNode' in target && target.parentNode !== null) {
					target = target.parentNode;
				} else {
					return;
				}
			}
		},
		getLaps: function (id) {
			this.id = id;
			lapProcessing(this.id, 'mi');
		},
		displayLaps: function (laps) {
			this.laps = laps;
			while (Polymer.dom(this.$.laps).firstChild) {
				Polymer.dom(
					this.$.laps
				).removeChild(
					Polymer.dom(
						this.$.laps
					).firstChild
				);
			}
			for (var lap of laps) {
				var row = this.createRow(lap);
				Polymer.dom(this.$.laps).appendChild(row);
			}
			this.tiz(this.laps[0].tiz, this.laps[0].rss);
		},
		createRow: function (row) {
			var elements = [
				{
					key: 'lap',
					unit: ''
				}, {
					key: 'power',
					unit: 'watts',
				}, {
					key: 'time',
					unit: ''
				}, {
					key: 'distance',
					unit: 'meters'
				}, {
					key: 'pace',
					unit: ''
				}, {
					key: 'formPower',
					unit: 'watts'
				}, {
					key: 'legSpring',
					unit: 'kN/m'
				}, {
					key: 'rss',
					unit: ''
				}
			];
			var tr = document.createElement('tr');
			tr.dataset.lap = row.lap;
			for (var ele of elements) {
				var td = document.createElement('td');
				var value = row[ele.key];
				if (typeof(value) === 'number') {
					value = value.toFixed(0);
				}
				Polymer.dom(td).textContent = `${value} ${ele.unit}`;
				Polymer.dom(tr).appendChild(td);
			}
			return tr;
		},
		tiz: function (tizs, rss) {
			var data = [];
			var total = tizs.reduce((a, b) => {
				return a + b;
			}, 0);
			for (var i = 0; i < tizs.length; i++) {
				var tiz = tizs[i];
				data.push({
					zone: i+1,
					tiz: tiz,
					percentage: tiz/total
				});
			}
			var width = 330, height = 230, radius = 110;
			var color = d3.scale.ordinal().range(['#fce9d2', '#fad3a5', '#f8be78', '#f6a84b', '#f4931f']);
			var arc = d3.svg.arc()
				.outerRadius(radius-40)
				.innerRadius(radius-60);
			var pie = d3.layout.pie()
				.sort(null)
				.value((d) => {
					return d.tiz;
				});
			d3.select('#tiz233')
				.selectAll('*')
				.remove();
			var svg = d3.select('#tiz233')
				.attr('width', width)
				.attr('height', height)
				.append('g')
					.attr('transform', `translate(${radius}, ${radius})`);
			var g = svg.selectAll('.arc')
				.data(pie(data))
				.enter()
				.append('g')
					.attr('class', 'arc');
			g.append('path')
				.attr('d', arc)
				.style('fill', (d) => {
					return color(d.data.zone);
				});
			g.append('rect')
				.attr('width', 20)
				.attr('height', 20)
				.attr('transform', (d) => {
					return `translate(${radius}, ${d.data.zone*25-radius+15})`;
				})
				.attr('fill', (d) => {
					return color(d.data.zone);
				});
			g.append('text')
				.attr('transform', (d) => {
					return `translate(${radius+25}, ${d.data.zone*25-radius+30})`;
				})
				.style('text-anchor', 'start')
				.attr('font-size', 16)
				.text((d) => {
					var percentage = (d.data.percentage * 100).toFixed(0);
					return `Z${d.data.zone} ${percentage}%`;
				});
			svg.append('text')
				.attr('x', 0)
				.attr('y', 0)
				.attr('font-size', 25)
				.attr('font-weight', '400')
				.attr('fill', '#FFFFFF')
				.style('text-anchor', 'middle')
				.text('RSS');
			svg.append('text')
				.attr('x', 0)
				.attr('y', 25)
				.attr('font-size', 25)
				.attr('font-weight', 'bolder')
				.attr('fill', '#FFFFFF')
				.style('text-anchor', 'middle')
				.text(rss.toFixed(0));
		}
	});
	</script>
</dom-module>