<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<dom-module id="compare-day">
    <template>
        <style>
            :host {
                @apply --layout-flex;
                @apply --layout-vertical;
                position: relative;
                height: 100%;
            }
            .container {
                @apply --layout-flex;
                @apply --layout-vertical;
                overflow: hidden;
                background-size: cover;
                height: 100%;
                cursor: auto;
                background-image: 'none';
            }
            .container.has-workout {
                background-image: url(https://storage.googleapis.com/stryd_static_assets/calendar-entry.png);
                cursor: pointer;
            }
            .workout-display {
                display: none;
            }
            .workout-display .other {
                @apply --layout;
                @apply --layout-vertical;
            }
            .has-workout .workout-display {
                @apply --layout;
                @apply --layout-vertical;
                @apply --layout-around-justified;
            }
            .header {
                @apply --layout-horizontal;
                @apply --layout-end-justified;
                height: 20px;
                padding: 0 3px;
                opacity: 0.6;
                transition: 0.5s opacity;
                flex: 0 1 20px;
            }
            .header .numday {
                text-align: right;
                color: white;
                line-height: 20px;
                font-size: 12px;
            }
            .wattage {
                margin-top: 5px;
                @apply --layout-center-justified;
                @apply --layout-center;
                @apply --layout-horizontal;
            }
            .wattage .value {
                color: white;
                text-align: center;
                font-size: 21px;
            }
            .wattage .unit {
                color: white;
                text-align: center;
                font-size: 20px;
            }
            .wattage iron-icon {
                margin-right: 5px;
                color: var(--primary-icon-color);
                fill: var(--primary-icon-color);
                width: 15px;
                height: 15px;
            }
            .other {
                height: 21px;
                margin-bottom: 5px;
            }
            .stat {
                height: 21px;
                @apply --layout-center-justified;
                @apply --layout-center;
                @apply --layout-horizontal;
            }
            .stat .value {
                color: white;
                text-align: center;
                font-size: 14px;
                font-weight: 300;
            }
            .stat iron-icon {
                margin-right: 5px;
                color: var(--primary-icon-color);
                fill: var(--primary-icon-color);
                height: 14px;
                width: 14px;
            }
        </style>
        <div class="container" id="container">
            <div class="header" id="header">
                <div class="numday">{{day}}</div>
            </div>
            <div class="data workout-display">
                <div class="wattage">
                    <iron-icon icon="{{power_icon}}"></iron-icon>
                    <div class="value">{{power}}</div>
                </div>
                <div class="other">
                    <div class="stat">
                        <iron-icon icon="communication:swap-calls"></iron-icon>
                        <div class="value">{{distance}}</div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <script>
    class CompareDay extends Polymer.GestureEventListeners(Polymer.Element) {
        static get is() { return 'compare-day'; }

        static get properties() {
            return {
                day: String,
                power: String,
                distance: String,
                power_icon: String,
            };
        }

        constructor() {
            super();
            this._eleTap = this.eleTap.bind(this);
        }
        connectedCallback() {
            super.connectedCallback();
            Polymer.Gestures.addListener(this.$.container, 'tap', this._eleTap);
        }
        disconnectedCallback() {
            super.disconnectedCallback();
            Polymer.Gestures.removeListener(this.$.container, 'tap', this._eleTap);
        }
        eleTap(e) {
            this.viewWorkout();
        }
        clearWorkout() {
            this.data = {};
            this.classList.remove('active');
        }
        setData(data) {
            Polymer.RenderStatus.afterNextRender(this, function() {
                this._setData(data);
            });
        }
        _setData(data) {
            this.data = data;
            this.day = data.day;
            this.rgb = 'rgb(0, 0, 0)';
            if ('power' in data) {
                this.$.container.classList.add('has-workout');
                if (
                    'rss' in this.data &&
                    this.data.rss > 0
                ) {
                    this.unit = 'RSS';
                    this.power = this.data.rss.toFixed(0);
                    this.power_icon = 'social:whatshot';
                } else {
                    this.unit = 'watts';
                    this.power = this.data.power.toFixed(0);
                    this.power_icon = 'image:flash-on';
                }
                this.distance = unit.distanceValue(this.data.distance, user.data.units);

                var duration = moment.duration(this.data.time, 'seconds');
                var minutesStr = duration.minutes().toString();
                if (minutesStr.length === 1) {
                    minutesStr = `0${minutesStr}`;
                }
                this.time = `${duration.hours()}:${minutesStr}`;

                var relativePower;
                if (data.power > colorInterpolate.threshold.high) {
                    relativePower = colorInterpolate.threshold.range;
                } else if (data.power < colorInterpolate.threshold.low) {
                    relativePower = 0;
                } else {
                    relativePower = (data.power - colorInterpolate.threshold.low);
                }

                this.rgb = colorInterpolate.RGB(relativePower);

                this.$.header.style.backgroundColor = this.rgb;
            } else {
                this.$.container.classList.remove('has-workout');
                this.rgb = 'rgb(0, 0, 0)';
                this.unit = '';
                this.power = '';
                this.$.header.style.backgroundColor = this.rgb;
            }
        }
        viewWorkout() {
            if (
                ('id' in this.data)
            ) {
                urlManager.compareRun(this.data.id);
                // var id = 0;
                // if ('id' in this.data) {
                //     updatedTime = this.data.updated_time;
                //     id = this.data.id;
                // }
                // urlManager.setURL(id, hash);
            }
        }
        // returns bool based on if workout has been inserted
        hasWorkout() {
            if ('power' in this.data) {
                return true;
            }
            return false;
        }
        getID() {
            if (this.data && 'id' in this.data) {
                return this.data.id;
            }
            return 0;
        }
        getDay() {
            if ('day' in this.data) {
                return this.data.day;
            }
            return 0;
        }
    }
    window.customElements.define(CompareDay.is, CompareDay);
    </script>
</dom-module>
