<dom-module id="spider-chart">
<style>
	:host {
		height: 100%;
		@apply(--layout);
		@apply(--layout-vertical);
		@apply(--layout-center);
		@apply(--layout-center-justified);
		padding: 20px;
	}
	:host.blurred {
		-webkit-filter: blur(2px);
		-moz-filter: blur(2px);
		-ms-filter: blur(2px);
		-o-filter: blur(2px);
		filter: blur(2px);
	}
	h1.header {
		@apply(--header);
		text-align: center;
		padding: 15px 0;
	}
	h2.subtitle {
		@apply(--subtitle);
	}
	#spider {
		height: 600px;
		min-width: 700px;
		flex: 2;
	}

	table {
		border: 1px solid #4D4D4D;
		color: white;
		line-height: 2;
		font-size: 17px;
		text-align: center;
		border-collapse: collapse;
		cursor: pointer;
		flex: 1;
	}
	table thead th {
		font-weight: 700;
	}
	table .highlight {
		background: orange;
	}
	table tr:last-child td {
		border-bottom: 0;
	}
	table td, table th {
		border-right: 1px solid #4D4D4D;
		border-bottom: 1px solid #4D4D4D;
		padding: 8px;
	}
	table tbody td:last-child {
		border-right: 0;
	}
	table tr.active td, table tr.active th {
		border-bottom: 2px solid #F7A017;
	}
	table tr td:first-child, table tr th:first-child {
		width: 230px;
	}
	table tr.active th {
		background: #393939;
	}
	table tr {
		order: 2;
	}
	table tr.active {
		order: 1;
	}
	table th {
		background: #393939;
	}
	table th.active {
		background: #393939;
		border-bottom: 2px solid #F7A017;
	}
	.setButton {
		width: 250px;
		padding: 10px;
		margin-bottom: 30px;
	}
	.targetRace {
		text-transform: uppercase;
	}
	.questionBtn {
		margin-top: 0;
		margin-left: 20px;
	}
</style>
<template>
	<div class="layout horizontal center center-justified">
		<h1 class="header">Strengthen Your Skills</h1>
		<button is="stryd-button" class="questionBtn" on-click="callQuestion">?</button>
	</div>
	<button is="stryd-button" on-click="changeRace" class="setButton">Update My Race (<span class="targetRace">{{raceKey}}</span>)</button>
	<div class="layout horizontal" style="margin-top: 20px;">
		<div id="spider"></div>
		<table>
			<thead>
				<tr>
					<td>Workouts</td>
					<th data-category="metobolic_fitness">Metabolic Fitness</th>
					<th data-category="muscle_endurance">Muscle Endurance</th>
					<th data-category="muscle_power">Muscle Power</th>
				</tr>
			</thead>
			<tbody>
				<tr data-workout="speed">
					<th>Speed/VO2 Max Repeat</th>
					<td class="highlight" data-highlight="metobolic_fitness"></td>
					<td></td>
					<td class="highlight" data-highlight="muscle_power"></td>
				</tr>
				<tr data-workout="lactate">
					<th>Lactate Threshold Runs</th>
					<td class="highlight" data-highlight="metobolic_fitness"></td>
					<td></td>
					<td></td>
				</tr>
				<tr data-workout="easy">
					<th>High Volume Easy Run</th>
					<td class="highlight" data-highlight="metobolic_fitness"></td>
					<td></td>
					<td></td>
				</tr>
				<tr data-workout="aerobic">
					<th>Aerobic Threshold Runs</th>
					<td class="highlight" data-highlight="metobolic_fitness"></td>
					<td class="highlight" data-highlight="muscle_endurance"></td>
					<td></td>
				</tr>
				<tr data-workout="race">
					<th>Race Specific</th>
					<td class="highlight" data-highlight="metobolic_fitness"></td>
					<td class="highlight" data-highlight="muscle_endurance"></td>
					<td></td>
				</tr>
				<tr data-workout="long">
					<th>Long Run</th>
					<td></td>
					<td class="highlight" data-highlight="muscle_endurance"></td>
					<td></td>
				</tr>
				<tr data-workout="hill">
					<th>Hill/Track Sprint</th>
					<td></td>
					<td></td>
					<td class="highlight" data-highlight="muscle_power"></td>
				</tr>
				<tr data-workout="pylo">
					<th>Pylometric Exercises</th>
					<td></td>
					<td></td>
					<td class="highlight" data-highlight="muscle_power"></td>
				</tr>
			</tbody>
		</table>
	</div>
	<div class="layout horizontal flex hidden">
		<h1>Last <span>{{timeRange}}</span> weeks</h1>
		<paper-slider id="dateSelection" pin="" max="24" step="1" value="10"></paper-slider>
	</div>
	<paper-dialog id="workoutDialog" style="max-width: 600px;">
		<h1>{{workoutTitle}}</h1>
		<div class="layout vertical">
			<p>{{workoutDescription}}</p>
		</div>
		<div class="buttons">
			<paper-button dialog-dismiss>Close</paper-button>
		</div>
	</paper-dialog>
	<paper-dialog id="questionDialog" style="max-width: 600px;">
		<h1>Running Optimization Tool</h1>
		<p>Your <b>Running Optimization Tool</b> allows you to quickly identify your strengths and limiters based on your goal distance and other runners like you.  Use the tool to determine how you should spend your time when training.</p>
		<div class="buttons">
			<paper-button dialog-dismiss>Close</paper-button>
		</div>
	</paper-dialog>
</template>
<script>
Polymer({
	is: 'spider-chart',
	listeners: {
		tap: 'eleTap'
	},
	eleTap: function (e) {
		var target = e.target;
		while (true) {
			if (target === this) {
				return;
			} else if ('workout' in target.dataset) {
				var recommendation = this.recommendations[target.dataset.workout];
				this.workoutDescription = recommendation.desc;
				this.workoutTitle = recommendation.title;
				this.$.workoutDialog.open();
				return;
			} else if ('category' in target.dataset) {
				var category = this.categories[target.dataset.category];
				this.workoutDescription = category.desc;
				this.workoutTitle = category.title;
				this.$.workoutDialog.open();
			}
			if ('parentNode' in target && target.parentNode !== null) {
				target = target.parentNode;
			} else {
				return;
			}
		}
	},
	callQuestion: function () {
		this.$.questionDialog.open();
	},
	changeRace: function () {
		var improveStone = document.querySelector('improve-stone');
		if (improveStone) {
			improveStone.changeRace();
		}
	},
	ready: function () {
		if (!featureManagement.hasFeatures) {
			return;
		}
		this.chart = null;

		this.workoutDescription = '';
		this.workoutTitle = '';

		this.mapping = {
			metobolic_fitness: 'Metabolic Fitness',
			muscle_endurance: 'Muscle Endurance',
			muscle_power: 'Muscle Power'
		};

		this.recKeys = ['metobolic_fitness', 'muscle_endurance', 'muscle_power'];
		this.categories = {
			metobolic_fitness: {
				title: 'Metabolic Fitness',
				desc: 'Your overall fitness. This considers both your metabolic endurance and current aerobic baseline.  While it is possible to build up to your fitness ceiling in a relatively short time, it is important to remember that you can also slowly improve your overall fitness ceiling over time.'
			},
			muscle_endurance: {
				title: 'Muscle Endurance',
				desc: 'Run long! Your ability to keep running.  Your ability to run long should be improved slowly.  Research recommends increasing by ~10% each week, and a single long run should not be more than 20-25% of your total weekly load.'
			},
			muscle_power: {
				title: 'Muscle Power',
				desc: 'Run Fast! Your instantaneous power.  Muscular power is directly linked to running economy.  By improving the strength of your muscles, the stiffness of your tendons, your technique, and your coordination, to get the most out of each and every step.'
			}
		};
		this.recommendations = {
			race: {
				features: [true, true, false],
				desc: 'Workouts performed at your race pace, designed to increase your efficiency and/or your resistance to fatigue at your goal race pace.',
				title: 'Race Specific Training'
			},
			long: {
				features: [false, true, false],
				desc: 'A long, sustained run completed once per week. This run typically comprises of roughly 20-30% of total weekly volume. Your overall endurance improves and promotes the use of fate as a fuel source.',
				title: 'Long Run'
			},
			hill: {
				features: [false , false, true],
				desc: 'Short, intense uphill runs lasting between 8-15 seconds with longer recovery periods. Your neuromuscular capabilities, overall strength, and leg spring stiffness improves. These skills lead to improved running economy.',
				title: 'Hill/Track Sprint'
			},
			pylo: {
				features: [false, false, true],
				desc: 'Improves muscle recruitment patterns, allowing you to run with more power and coordination. Should be used incrementally focussing on lower impact routines first. Form Drills - Strengthens key running muscles, improves functional range of motion, improves neuromuscular communication, and increases mindfulness of good running form. Heavy Weights Lifting - The optimal number of repetitions for increasing strength and endurance is 5-6. Not only does it translate to a more powerful stride, but it also promotes good posture and muscle stiffness which also improves efficiency.',
				title: 'Pylometric Exercises',
			},
			speed: {
				features: [true, false, true],
				desc: '3 to 5 min bouts of Zone 4 running with short rest. The goal is to stress your aerobic capacity to a greater degree than could be accomplished with a single, continuous run.',
				title: 'Speed/VO2 Max Repeat'
			},
			lactate: {
				features: [true, false, false],
				desc: '20-60 min of Zone 3/Zone 4 running. Often described as comfortably hard. Run at a slightly higher intensity than an Aerobic Threshold Run - targeting your lactate clearing system.',
				title: 'Lactate Threshold Tempo'
			},
			easy: {
				features: [true, false, false],
				desc: 'Zone 1 running strengthens the heart muscle, increases vascularization, promotes healing, and oxygen delivery at the cellular level.',
				title: 'High Volume Easy Run'
			},
			aerobic: {
				features: [true, true, false],
				desc: '20-60 min of Zone 3 running. Often described as comfortably hard. Run faster than an easy run, but less intense than an LT Tempo Run. Designed to stress the aerobic system with limited lactate build up.',
				title: 'Aerobic Threshold Tempo Runs'
			}
		};

		this.chartData = [];

		var path = '/b/api/v1/users/runnerprofile?srtDate=02-01-2017&endDate=04-01-2017';
		if (isLocal) {
			path = '/powercenter/scripts/spider.json';
		}
		superagent
			.get(path)
			.send()
			.set('Accept', 'application/json')
			.set('Authorization', `Bearer: ${jwt.token}`)
			.end((err, res) => {
				if (res.ok) {
					this.data = res.body;
					this.processData();
					this.createChart();
					//this.findHighlights(this.data);
					this.findShading();
				} else {
					console.log('Error: cannot fetch data');
				}
			});

		this.raceKey = '5k';
		if ('race' in user.data && user.data.race !== '') {
			this.raceKey = user.data.race;
		}
	},
	findShading: function () {
		for (var skill of Object.keys(this.data)) {
			var opacity = (1.4-this.data[skill]);
			var tiles = document.querySelectorAll(`[data-highlight="${skill}"]`);
			for (var tile of tiles) {
				tile.style.opacity = opacity;
			}
		}
	},
	findRecs: function (highlights) {
		// recommendation rows to highlight
		var highlightRecs = [];
		// look for recommendations corresponding to categories
		for (var highlight of highlights) {
			// look at each recommendation
			for (var recKey of Object.keys(this.recommendations)) {
				var recommendation = this.recommendations[recKey];
				// find if this recommendation is in the category
				var highlightIdx = this.recKeys.indexOf(highlight.key);
				if (recommendation.features[highlightIdx]) {
					highlightRecs.push(recKey);
				}
			}
		}
		this.highlightRecs(highlightRecs, highlights);
	},
	highlightRecs: function (highlightRecs, highlights) {
		for (var rec of highlightRecs) {
			this.querySelector(`[data-workout="${rec}"]`).classList.add('active');
		}
		for (var highlight of highlights) {
			console.log(highlight.key);
			this.querySelector(`[data-category="${highlight.key}"]`).classList.add('active');
		}
	},
	findHighlights: function (profile) {
		var profileArr = [];
		for (var key of Object.keys(profile)) {
			profileArr.push({
				key: key,
				value: profile[key]
			});
		}
		profileArr.sort((a, b) => {
			return a.value - b.value;
		});
		var below30Threshold = false;
		var below60Threshold = false;
		var highlights = [];
		for (var obj of profileArr) {
			if (obj.value < 0.30) {
				below30Threshold = true;
				highlights.push(obj);
			} else if (obj.value < 0.60) {
				below60Threshold = true;
			}
		}

		if (!below30Threshold && below60Threshold) {
			highlights.push(profileArr[0]);
		}

		this.findRecs(highlights);
	},
	processData: function () {
		for (var key of Object.keys(this.data)) {
			this.chartData.push({
				category: this.mapping[key],
				units: Math.floor(this.data[key] * 100)
			});
		}
	},
	createLabels: function () {
		var labels = [{
			align: 'center',
			text: 'Metabolic Fitness',
			color: 'white',
			x: '0%',
			y: 0,
			size: 20,
			bold: true
		}, {
			align: 'center',
			text: 'Muscle Endurance',
			color: 'white',
			x: '-35%',
			y: 430,
			size: 20,
			bold: true
		}, {
			align: 'center',
			text: 'Muscle Power',
			color: 'white',
			x: '40%',
			y: 430,
			size: 20,
			bold: true
		}];

		var profileArr = [];
		for (let key of Object.keys(this.data)) {
			profileArr.push({
				key: key,
				value: this.data[key]
			});
		}
		profileArr.sort((a, b) => {
			return a.value - b.value;
		});

		var i = 0;
		for (let key of this.recKeys) {
			var label = JSON.parse(JSON.stringify(labels[i]));
			label.y += 20;
			label.text = Math.floor(this.data[key] * 100) + '%';
			label.size = 20;
			label.bold = false;
			labels.push(label);
			i++;
		}
		return labels;
	},
	createChart: function () {
		var labels = this.createLabels();
		console.log(labels);
		this.chart = AmCharts.makeChart(
			this.$.spider,
			{
				type: 'radar',
				theme: 'stryd',
				valueAxes: [{
					axisTitle: 50,
					minimum: 0,
					maximum: 100,
					axisAlpha: 1,
					dashLength: 0,
					labelsEnabled: true,
					fontSize: 20,
					id: 'pts',
					axisTitleOffset: 50,
					autoWrap: true,
					labelOffset: 20,
					radarCategoriesEnabled: false,
					gridThickness: 3
				}],
				fontFamily: 'Roboto',
				allLabels: labels,
				colors: ['#F7A017'],
				startDuration: 1,
				startEffect: 'easeInSine',
				marginTop: 10,
				graphs: [{
					balloonText: '[[value]]%',
					bullet: 'round',
					bulletSize: 30,
					lineThickness: 10,
					valueField: 'units'
				}],
				categoryField: 'category',
				radius: '40%',
				dataProvider: this.chartData
			}
		);
	}
});
</script>
</dom-module>