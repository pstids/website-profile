<dom-module id="distance-training">
    <style>
        h1.title {
            @apply(--header);
        }
        h2.subtitle {
            @apply(--subtitle);
        }
        h3 {
            font-size: 20px;
            color: #FFFFFF;
            font-weight: 700;
            text-align: center
        }
        p {
            color: white;
            line-height: 28px;
        }
        paper-input input {
            text-align: center !important;
        }
        .inactive {
            border-color: rgb(96, 96, 96);
            color: rgb(96, 96, 96);
            background-color: rgb(36, 36, 36);
            display: none;
        }
        .item {
            margin-right: 40px;
        }
        hr {
            margin: 30px 0;
            color: #F5A214;
            border: 1px solid #F5A214;
        }

        .zones {
            @apply(--layout-vertical);
        }
        .zones zone-entry:nth-of-type(odd) {
            background-color: rgba(20, 20, 20, 0.5);
        }

        .zones-titles {
            margin-top: 50px;
        }
        .zone {
            @apply(--layout-flex);
            border-radius: 30px;
            border: 1px solid white;
            margin: 20px 0px 20px 20px;
            padding: 20px;
        }
        .zone:first-child {
            margin-left: 0px;
        }
        .zone.titles {
            @apply(--layout-flex);
        }

        .entry paper-input[name] {
            margin-left: 0;
        }

        .entry {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            margin-top: 20px;
        }
        .entry paper-input {
            @apply(--layout-flex-2);
            font-size: 20px;
            font-weight: 700;
            text-align: center;
        }

        .titles paper-input {
            margin-top: 20px;
        }
        .to {
            @apply(--layout-flex);
            color: var(--accent-background-color);
            text-transform: uppercase;
            text-align: center;
        }
        .units {
            color: white;
            margin-left: 14px;
            margin-bottom: 8px;
            width: 50px;
        }

        .faux-input {
            @apply(--layout-vertical);
            height: 46px;
            width: 162px;
            padding: 8px 0;
        }
        .faux-input label {
            color: #C1BBAD;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Roboto', 'Noto', sans-serif;
            -webkit-font-smoothing: antialiased;
            font-size: 12px;
            font-weight: 400;
            line-height: 24px;
        }
        .faux-input span {
            color: #FFFFFF;
            font-family: 'Roboto', 'Noto', sans-serif;
            -webkit-font-smoothing: antialiased;
            font-size: 16px;
            font-weight: 400;
            line-height: 16px;
            padding: 0;
            margin-top: 8px;
        }
        .auto {
            display: none !important;
        }
        .automatic .auto {
            display: flex !important;
        }
        .automatic .manual {
            display: none !important;
        }

        .save {
            position: fixed;
            bottom: 30px;
            right: 30px;
            @apply(--layout-horizontal);
            @apply(--layout-end-justified);
            @apply(--layout-center);
            cursor: pointer;
            background-color: #262626;
            padding: 0 0 0 30px;
            border-radius: 40px;
            border: 2px solid #F7A017;
        }
        .save p {
            color: white;
            font-size: 14px;
            margin-right: 15px;
        }
        .save-line {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(38, 38, 38, 0.4);
            width: 100vw;
            height: 100px;
        }

        #critTestContainer.hide, #critValuesContainer.hide {
            max-height: 0;
        }
        #critTestContainer, #critValuesContainer {
            max-height: 800px;
            -webkit-transition: max-height 0.8s;
            -moz-transition: max-height 0.8s;
            transition: max-height 0.8s;
            overflow: hidden;
        }

        .instructions {
            padding: 20px;
            border: 1px solid #FFFFFF;
            margin-bottom: 20px;
        }
        .instructions h1 {
            color: #FFFFFF;
            font-size: 18px;
            margin: 0;
        }
        .instructions p {
            line-height: 18px;
            padding: 0;
            margin: 10px 0 0 0;
            font-weight: 300;
            font-size: 15px;
        }
    </style>
    <template>
    <div data-zone="container">
        <div class="layout vertical instructions">
            <h1>Instructions</h1>
            <p>1. Complete the <a href="http://club.stryd.com/t/coach-mike-ricci-and-his-team-do-the-critical-power-test/1592">Distance Based Critical Power Test</a> on Stryd Mobile. The testing results from the mobile app are updated when the test is complete.</p>
        </div>
        <div class="layout horizontal justified">
            <h1 class="title self-center">Critical Power & Pace</h1>
            <button is="stryd-button" class="hidden self-center self-end" style="margin-top: 0;" on-click="toggleTests">
                <div class="layout horizontal">
                    <span class="self-center" style="margin-right: 15px;">USE 3-6 AP CRITICAL POWER TEST</span>
                    <paper-checkbox id="critToggle" checked class="self-center"></paper-checkbox>
                </div>
            </button>
        </div>
        <div class="crit">
            <div class="layout vertical">
                <!-- <div class="layout horizontal">
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>800M AVG WATTS</label>
                            <span>200</span>
                        </div>
                        <span class="units self-end">WATTS</span>
                    </div>
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>800M AVG PACE</label>
                            <span>8:00</span>
                        </div>
                        <span class="units self-end">{{userLocal}}</span>
                    </div>
                </div> -->
                <div class="layout horizontal" style="margin-top: 10px; border-top: 0px solid #FFFFFF; width: 540px;">
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>1200M AVG WATTS</label>
                            <span>{{power_short}}</span>
                        </div>
                        <span class="units self-end">WATTS</span>
                    </div>
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>1200M AVG PACE</label>
                            <span>{{pace_short}}</span>
                        </div>
                        <span class="units self-end">{{userLocal}}</span>
                    </div>
                </div>
                <div class="layout horizontal" style="margin-top: 10px; border-top: 1px solid #FFFFFF; width: 540px;">
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>2400M AVG WATTS</label>
                            <span>{{power_long}}</span>
                        </div>
                        <span class="units self-end">WATTS</span>
                    </div>
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>2400M AVG PACE</label>
                            <span>{{pace_long}}</span>
                        </div>
                        <span class="units self-end">{{userLocal}}</span>
                    </div>
                </div>
                <div class="layout horizontal" style="margin-top: 10px; border-top: 2px solid #F5A214; padding: 15px 0; width: 540px;">
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>CRITICAL POWER</label>
                            <span>{{critical_power}}</span>
                        </div>
                        <span class="units self-end">WATTS</span>
                    </div>
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>CRITICAL PACE</label>
                            <span>{{critical_pace}}</span>
                        </div>
                        <span class="units self-end">{{userLocal}}</span>
                    </div>
                </div>
            </div>
        </div>
        <div data-zones="container">
            <div class="layout horizontal justified">
                <div class="zones-titles self-center">
                    <h1 class="title">Power & Pace Zones</h1>
                </div>
                <button is="stryd-button" on-click="calculateZones" class="self-center self-end hidden" style="margin-top: 0;">Calculate Zones on Jack Daniel's Method</button>
            </div>
            <div class="titles layout horizontal">
                <div class="title flex-1">
                    <h3>Zones</h3>
                </div>
                <div class="title flex-1">
                    <h3>Power (WATTS)</h3>
                </div>
                <div class="title flex-1">
                    <h3>Pace (<span>{{userLocal}}</span>)</h3>
                </div>
                <div style="width: 44px;"></div>
            </div>
            <div class="zones" id="zones" style="margin-bottom: 20px;">
            </div>
            <button is="stryd-button" class="self-center hidden" on-click="addZone" style="margin: 0 0 20px 20px;">Add Zone</button>
        </div>
        <!-- <div class="save-line"></div> -->
        <div class="save hidden" on-click="saveZones">
            <p>Save Training Information</p>
            <paper-fab icon="inbox"></paper-fab>
        </div>
        <paper-toast duration="1300" text="" id="toast"></paper-toast>
        <paper-dialog id="autoCalc">
            <h1>You are about to automatically calculate your zones. This will overwrite your current zones.</h1>
            <div class="buttons">
                <paper-button dialog-dismiss style="margin-right: 20px;">No</paper-button>
                <paper-button dialog-confirm autofocus on-click="autoCalc">Yes</paper-button>
            </div>
        </paper-dialog>
    </div>
    </template>
    <script>
        Polymer({
            is: 'distance-training',
            properties: {
                critPower: {
                    type: Object,
                    notify: true
                },
                critPace: {
                    type: Object,
                    notify: true
                },
                userLocal: {
                    type: String,
                    notify: true
                }
            },
            jsonToQueryString: function (json) {
                return '?' +
                    Object.keys(json).map(function(key) {
                        return encodeURIComponent(key) + '=' +
                                encodeURIComponent(json[key]);
                    }).join('&');
            },
            ready: function () {
                if (!jwt.hasToken) {
                    return;
                }
                if (user.data.units === 'feet') {
                    this.userLocal = 'MIN/MILE';
                } else {
                    this.userLocal = 'MIN/KM';
                }

                var storedZones = (typeof localStorage.getItem('ambassadorZones') === 'string');
                
                if (storedZones !== false) {
                    var zones = JSON.parse(localStorage.getItem('ambassadorZones'));
                    for (var i = 0; i < zones.length; i++) {
                        var zoneEntry = document.createElement('zone-entry');
                        zoneEntry.import(zones[i]);
                        this.$.zones.appendChild(zoneEntry);
                    }
                } else {
                //     var names = ['Easy/Long', 'Marathon', 'Threshold', 'Interval', 'Repetition'];
                //     this.addZone({
                //         name: names[0]
                //     });
                //     this.addZone({
                //         name: names[1]
                //     });
                //     this.addZone({
                //         name: names[2]
                //     });
                //     this.addZone({
                //         name: names[3]
                //     });
                //     this.addZone({
                //         name: names[4]
                //     });
                }

            },
            setData: function (pl) {
                console.log('called with', pl);
                this.set('power_long', pl.critical_result.power_long);
                this.set('power_short', pl.critical_result.power_short);
                this.set('pace_long', this.mpsToPace(pl.critical_result.speed_long));
                this.set('pace_short', this.mpsToPace(pl.critical_result.speed_short));
                this.set('critical_power', pl.critical_power);
                this.set('critical_pace', this.mpsToPace(pl.critical_speed));

                for (var i = 0; i < pl.training_zones.length; i++) {
                    var zone = pl.training_zones[i];
                    this.addZone({
                        name: zone.name,
                        power_low: parseInt(zone.power_low),
                        power_high: parseInt(zone.power_high),
                        pace_low: this.mpsToPace(zone.speed_low),
                        pace_high: this.mpsToPace(zone.speed_high)
                    });
                }
            },
            addZone: function (zone) {
                var zoneEntry = document.createElement('zone-entry');
                zoneEntry.setAttribute('keep', 'true');
                zoneEntry.import(zone);
                this.$.zones.appendChild(zoneEntry);
            },
            clearZones: function () {
                while (this.$.zones.hasChildNodes()) {
                    this.$.zones.removeChild(this.$.zones.childNodes[0]);
                }
            },
            automatic: function () {
                this.$.autoCalc.open();
            },
            saveZones: function () {

                var zones = [];
                for (var i = 0; i < this.$.zones.children.length; i++) {
                    zones.push(this.$.zones.children[i].export());
                }

                var zoneString = JSON.stringify(zones);

                localStorage.setItem('ambassadorZones', zoneString);
                this.$.toast.text = 'Your training information is up-to-date!';
                this.$.toast.show();
            },
            calculateZones: function () {
                var paceDec = this.paceToDec(this.critPace.value);
                if (isNaN(paceDec) || isNaN(this.critPower.value) || this.critPower.value === 0) {
                    this.$.toast.text = 'Your critical power & pace values are incorrect. Please review.';
                    this.$.toast.show();
                    return;
                }

                var conv;
                var mps;
                if (user.data.units === 'feet') {
                    conv = 26.8224;
                    mps = conv / paceDec;
                } else {
                    conv = 16.6667;
                    mps = conv / paceDec;
                }

                this.clearZones();

                superagent
                    .post('/b/api/v1/users/' + user.data.id + '/training-zone')
                    .send({
                        critical_speed: mps,
                        critical_power: parseInt(this.critPower.value)
                    })
                    .set('Authorization', 'Bearer: ' + jwt.token)
                    .end((err, res) => {
                        if (res.ok) {
                            var zones = res.body.zones;
                            var zone;
                            for (var i = 0; i < zones.length; i++) {
                                zone = zones[i];
                                if (zone.power_low > 0) {
                                    zones[i].power_high = parseInt(zones[i].power_high);
                                    zones[i].power_low = parseInt(zones[i].power_low);
                                    this.addZone(zones[i]);
                                }
                            }
                        }
                    });
                this.$.toast.text = 'Zones are updated.';
                this.$.toast.show();
            },
            paceToDec: function (pace) {
                var parts = pace.split(':');
                var secondFraction;

                if (parts.length > 1) { 
                    secondFraction = parseFloat(parseInt(parts[1]) / 60);
                } else {
                    secondFraction = 0;
                }

                var dec = parseFloat(parts[0]) + secondFraction;
                return parseFloat(dec);
            },
            decToPace: function (dec) {
                dec = parseFloat(dec);
                var min = Math.floor(dec);
                var part = dec - min;
                var seconds = part * 60;
                var stringSeconds = String(seconds.toFixed());
                if (stringSeconds.length === 1) {
                    stringSeconds = '0' + stringSeconds;
                }
                min = String(min);

                if (isNaN(min)) {
                    min = '--';
                }
                if (isNaN(stringSeconds)) {
                    stringSeconds = '--';
                }
                if (min.length === 1) {
                    min = '0' + min;
                }
                return min + ':' + stringSeconds;
            },
            paceToMPH: function (val) {
                var mph;
                if (user.data.units === 'feet') {
                    mph = (60/val);
                } else {
                    mph = (37.2822715/val);
                }
                return mph;
            },
            mpsToPace: function (val) {
                var pace;
                if (user.data.units === 'feet') {
                    pace = 26.8224 / val;
                } else {
                    pace = 16.6666667 / val;
                }
                return this.formatPace(parseInt(pace*60));
            },
            formatPace: function (seconds) {
                var dec = seconds / 60;
                var minutes = parseInt(dec);
                var remaining = (seconds - (minutes * 60)).toString();
                if (remaining.length === 1) {
                    remaining = '0' + remaining;
                }
                return minutes + ':' + remaining;
            }
        });
    </script>
</dom-module>