<dom-module id="settings-training">
    <style>
        h1.title {
            @apply(--header);
        }
        h2.subtitle {
            @apply(--subtitle);
        }
        h3 {
            font-size: 20px;
            color: #FFFFFF;
            font-weight: 700;
            text-align: center
        }
        p {
            color: white;
            line-height: 28px;
        }
        paper-input input {
            text-align: center !important;
        }
        .inactive {
            border-color: rgb(96, 96, 96);
            color: rgb(96, 96, 96);
            background-color: rgb(36, 36, 36);
            display: none;
        }
        .item {
            margin-right: 40px;
        }
        hr {
            margin: 30px 0;
            color: #F5A214;
            border: 1px solid #F5A214;
        }

        .zones {
            @apply(--layout-vertical);
        }
        .zones zone-entry:nth-of-type(odd) {
            background-color: rgba(20, 20, 20, 0.5);
        }

        .zones-titles {
            margin-top: 50px;
        }
        .zone {
            @apply(--layout-flex);
            border-radius: 30px;
            border: 1px solid white;
            margin: 20px 0px 20px 20px;
            padding: 20px;
        }
        .zone:first-child {
            margin-left: 0px;
        }
        .zone.titles {
            @apply(--layout-flex);
        }

        .entry paper-input[name] {
            margin-left: 0;
        }

        .entry {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            margin-top: 20px;
        }
        .entry paper-input {
            @apply(--layout-flex-2);
            font-size: 20px;
            font-weight: 700;
            text-align: center;
        }

        .titles paper-input {
            margin-top: 20px;
        }
        .to {
            @apply(--layout-flex);
            color: var(--accent-background-color);
            text-transform: uppercase;
            text-align: center;
        }
        .units {
            color: white;
            margin-left: 14px;
            margin-bottom: 8px;
            width: 50px;
        }

        .faux-input {
            @apply(--layout-vertical);
            height: 46px;
            width: 196px;
            padding: 8px 0;
        }
        .faux-input label {
            color: #C1BBAD;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Roboto', 'Noto', sans-serif;
            -webkit-font-smoothing: antialiased;
            font-size: 12px;
            font-weight: 400;
            line-height: 24px;
        }
        .faux-input span {
            color: #FFFFFF;
            font-family: 'Roboto', 'Noto', sans-serif;
            -webkit-font-smoothing: antialiased;
            font-size: 16px;
            font-weight: 400;
            line-height: 16px;
            padding: 0;
            margin-top: 8px;
        }
        .auto {
            display: none !important;
        }
        .automatic .auto {
            display: flex !important;
        }
        .automatic .manual {
            display: none !important;
        }

        .save {
            position: fixed;
            bottom: 30px;
            right: 30px;
            @apply(--layout-horizontal);
            @apply(--layout-end-justified);
            @apply(--layout-center);
            cursor: pointer;
            background-color: #262626;
            padding: 0 0 0 30px;
            border-radius: 40px;
            border: 2px solid #F7A017;
        }
        .save p {
            color: white;
            font-size: 14px;
            margin-right: 15px;
        }

        #critTestContainer.hide, #critValuesContainer.hide {
            max-height: 0;
        }
        #critTestContainer, #critValuesContainer {
            max-height: 800px;
            -webkit-transition: max-height 0.8s;
            -moz-transition: max-height 0.8s;
            transition: max-height 0.8s;
            overflow: hidden;
        }
    </style>
    <template>
    <div data-zone="container">
        <div class="layout horizontal center">
            <h1 class="title">Critical Power & Pace</h1>
            <button is="stryd-button" style="margin: 0 0 0 20px;" on-click="toggleTests">
                <div class="layout horizontal">
                    <span class="self-center" style="margin-right: 15px;">USE 3-9 MINUTE CRITICAL POWER TEST</span>
                    <paper-checkbox id="critToggle" checked class="self-center"></paper-checkbox>
                </div>
            </button>
        </div>
        <div class="crit" id="critTestContainer">
            <p>Fill in your critical values from your 3-9 minute critical power test & click calculate zones. Stryd automatically determines your training zones and critical values. If you want to manually set your critical values, untoggle 'Use 3-9 Minutes Test'.</p>
            <div class="layout vertical">
                <div class="layout horizontal" style="margin-top: 10px;">
                    <div class="layout horizontal item">
                        <paper-input
                            value="{{critPower.three}}"
                            editable="true"
                            type="text"
                            placeholder="Watts"
                            class="flex"
                            label="THREE MIN AVG WATTS">
                        </paper-input>
                        <span class="units self-end">WATTS</span>
                    </div>
                    <div class="layout horizontal item">
                        <paper-input
                            value="{{critPace.three}}"
                            editable="true"
                            type="text"
                            placeholder="Pace (i.e. 4:40)"
                            label="THREE MIN AVG PACE"
                            class="flex">
                        </paper-input>
                        <span class="units self-end">{{userLocal}}</span>
                    </div>
                </div>
                <div class="layout horizontal" style="margin-top: 10px;">
                    <div class="layout horizontal item">
                        <paper-input
                            value="{{critPower.nine}}"
                            editable="true"
                            type="text"
                            placeholder="Watts"
                            class="flex"
                            label="NINE MIN AVG WATTS">
                        </paper-input>
                        <span class="units self-end">WATTS</span>
                    </div>
                    <div class="layout horizontal item">
                        <paper-input
                            value="{{critPace.nine}}"
                            editable="true"
                            type="text"
                            placeholder="Pace (i.e. 5:40)"
                            label="NINE MIN AVG PACE"
                            class="flex">
                        </paper-input>
                        <span class="units self-end">{{userLocal}}</span>
                    </div>
                </div>
                <div class="layout horizontal" style="margin-top: 10px;">
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>CRITICAL POWER</label>
                            <span>{{calcCritPower(critPower.three, critPower.nine)}}</span>
                        </div>
                        <span class="units self-end">WATTS</span>
                    </div>
                    <div class="layout horizontal item">
                        <div class="faux-input">
                            <label>CRITICAL PACE</label>
                            <span>{{calcCritPace(critPace.three, critPace.nine)}}</span>
                        </div>
                        <span class="units self-end">{{userLocal}}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="crit" id="critValuesContainer">
            <p>Based off your own critical power test.</p>
            <div class="layout horizontal">
                <div class="layout horizontal item">
                    <paper-input
                    value="{{critPower.value}}"
                    type="text"
                    placeholder="Power (i.e. 300)"
                    label="CRITICAL POWER">
                    </paper-input>
                    <span class="self-end units">WATTS</span>
                </div>
                <div class="layout horizontal item">
                    <paper-input
                    value="{{critPace.value}}"
                    type="text"
                    placeholder="Pace (i.e. 5:40)"
                    label="CRITICAL PACE">
                    </paper-input>
                    <span class="self-end units">{{userLocal}}</span>
                </div>
            </div>
        </div>
        <div data-zones="container">
            <div class="layout horizontal center">
                <div class="zones-titles self-center">
                    <h1 class="title">Power & Pace Zones</h1>
                    <h2 class="subtitle">Based off your critical power & pace.</h2>
                </div>
                <button is="stryd-button" on-click="automatic" style="margin-left: 20px;">Calculate Zones on Jack Daniel's Method</button>
            </div>
            <div class="titles layout horizontal">
                <div class="title flex-1">
                    <h3>Zones</h3>
                </div>
                <div class="title flex-1">
                    <h3>Power (WATTS)</h3>
                </div>
                <div class="title flex-1">
                    <h3>Pace (<span>{{userLocal}}</span>)</h3>
                </div>
                <div style="width: 44px;"></div>
            </div>
            <div class="zones" id="zones" style="margin-bottom: 20px;">
            </div>
            <button is="stryd-button" class="self-center" on-click="addZone" style="margin: 0 0 20px 20px;">Add Zone</button>
        </div>
        <div class="save" on-click="saveZones">
            <p>Save Training Information</p>
            <paper-fab icon="inbox"></paper-fab>
        </div>
        <paper-toast duration="1300" text="" id="toast"></paper-toast>
        <paper-dialog id="autoCalc">
            <h1>You are about to automatically calculate your zones. This will overwrite your current zones.</h1>
            <div class="buttons">
                <paper-button dialog-dismiss style="margin-right: 20px;">No</paper-button>
                <paper-button dialog-confirm autofocus on-click="autoCalc">Yes</paper-button>
            </div>
        </paper-dialog>
    </div>
    </template>
    <script>
        Polymer({
            is: 'settings-training',
            properties: {
                crit: {
                    type: Object,
                    notify: true
                },
                userLocal: {
                    type: String,
                    notify: true
                }
            },
            jsonToQueryString: function (json) {
                return '?' +
                    Object.keys(json).map(function(key) {
                        return encodeURIComponent(key) + '=' +
                                encodeURIComponent(json[key]);
                    }).join('&');
            },
            ready: function () {
                if (user.data.units === 'feet') {
                    this.userLocal = 'MIN/MILE';
                } else {
                    this.userLocal = 'MIN/KM';
                }
                console.log('init');
                if (!('critical_pace' in user.data) || !('critical_power' in user.data)) {
                    console.log('Refetch user details.');
                    user.fetchDetails(this.ready.bind(this));
                }

                this.critPower = {
                    three: user.data.critical_power.three_minutes,
                    nine: user.data.critical_power.nine_minutes,
                    value: user.data.critical_power.value
                };

                this.critPace = {
                    nineDec: 0,
                    threeDec: 0,
                    three: user.data.critical_pace.three_minutes,
                    nine: user.data.critical_pace.nine_minutes,
                    value: user.data.critical_pace.value
                };

                var zones = user.get('zones');
                if (zones) {
                    for (var i = 0; i < zones.length; i++) {
                        var zoneEntry = document.createElement('zone-entry');
                        zoneEntry.import(zones[i]);
                        this.$.zones.appendChild(zoneEntry);
                    }
                } else {
                    this.addZone({});
                }


                var useTest = (localStorage.getItem('useTest') === 'true');
                if (useTest === null) {
                    this.useTest = true;
                } else {
                    this.useTest = useTest;
                    this.$.critToggle.checked = this.useTest;
                    if (!this.useTest) {
                        this.$.critTestContainer.classList.add('hide');
                    } else {
                        this.$.critValuesContainer.classList.add('hide');
                    }
                }
            },
            toggleTests: function () {
                this.useTest = !this.useTest;
                this.$.critTestContainer.classList.toggle('hide');
                this.$.critValuesContainer.classList.toggle('hide');
                this.$.critToggle.checked = this.useTest;
            },
            addZone: function (zone) {
                var zoneEntry = document.createElement('zone-entry');
                zoneEntry.import(zone);
                this.$.zones.appendChild(zoneEntry);
            },
            clearZones: function () {
                while (this.$.zones.hasChildNodes()) {
                    this.$.zones.removeChild(this.$.zones.childNodes[0]);
                }
            },
            automatic: function () {
                this.$.autoCalc.open();
            },
            autoCalc: function () {
                this.jackDanielsVDOT();
                if (this.useTest) {
                    this.calcCrits();
                }
            },
            calcCrits: function () {
                var critPaceMess = this.calcCritPace();
                var critPowerMess = this.calcCritPower();
                this.$.toast.text = critPowerMess + ' ' + critPaceMess;
                this.$.toast.show();
            },
            calcCritPower: function (three, nine) {
                if (three === '' || nine === '') {
                    this.$.toast.text = 'Fill in the critical power values.';
                    this.$.toast.show();
                    return '';
                }
                three = parseInt(three);
                nine = parseInt(nine);
                var scaled_nine = (nine*9);
                var scaled_three = (three*3);
                var crit_power = ((scaled_nine - scaled_three)/(6));
                if (crit_power < 0) {
                    crit_power = 0;
                }
                this.critPower.value = crit_power;
                this.notifyPath('critPower.value', crit_power);
                return crit_power;
            },
            calcCritPace: function (three, nine) {
                if (three === '' || nine === '') {
                    this.$.toast.text = 'Fill in the critical pace values.';
                    this.$.toast.show();
                    return '';
                }

                if (three.indexOf(':') === -1 || nine.indexOf(':') === -9) {
                    this.$.toast.text = 'Use colon notation. i.e. 10:00, 5:15';
                    this.$.toast.show();
                    return '';
                }

                this.critPace.threeDec = this.paceToDec(three);
                this.critPace.nineDec = this.paceToDec(nine);

                var speedThree = this.paceToMPH(this.critPace.threeDec);
                var speedNine = this.paceToMPH(this.critPace.nineDec);

                var scaledThree = speedThree * 3;
                var scaledNine = speedNine * 9;

                var critSpeed = (scaledNine - scaledThree)/6;
                if (critSpeed < 0) {
                    critSpeed = 0;
                }
                var critPace = this.decToPace(this.paceToMPH(critSpeed));

                this.critPace.value = critPace;
                this.notifyPath('critPace.value', critPace);
                return critPace;
            },
            saveZones: function () {
                localStorage.setItem('useTest', this.useTest);
                var queryObj = {};
                queryObj.crit_power_three_minutes = this.critPower.three;
                queryObj.crit_power_nine_minutes = this.critPower.nine;
                queryObj.crit_power_value = this.critPower.value;
                queryObj.crit_pace_three_minutes = this.critPace.three;
                queryObj.crit_pace_nine_minutes = this.critPace.nine;
                queryObj.crit_pace_value = this.critPace.value;

                var zones = [];
                for (var i = 0; i < this.$.zones.children.length; i++) {
                    zones.push(this.$.zones.children[i].export());
                }
                console.log('Zones:', zones);

                var queryString = this.jsonToQueryString(queryObj);
                superagent
                    .put('/b/api/v1/users/' + jwt.data.id + queryString)
                    .send({
                        zones: zones
                    })
                    .set('Accept', 'application/json')
                    .set('Authorization', 'Bearer: ' + jwt.token)
                    .end(function(err, res) {
                        if (res.ok) {
                            this.$.toast.text = 'Your training information is up-to-date!';
                            user.updateData(res.body);
                        } else {
                            this.$.toast.text = 'Your information has not been updated. Please try again.';
                        }
                        this.$.toast.show();
                    }.bind(this));
            },
            jackDanielsVDOT: function () {
                var cons;
                if (user.data.units === 'feet') {
                    cons = 3.10686;
                } else {
                    cons = 5;
                }
                var approx5KDec = cons * this.paceToDec(this.critPace.value);
                var approx5K = this.decToPace(approx5KDec);

                superagent
                    .post('/b/api/v1/users/paces')
                    .type('form')
                    .set('Authorization', 'Bearer: ' + jwt.token)
                    .send({
                        time: '00:' + approx5K
                    })
                    .set('Accept', 'application/json')
                    .end(function(err, res) {
                        if (res.ok) {
                            var data = res.body;
                            var key;
                            if (user.data.units === 'feet') {
                                key = 'mi';
                            } else {
                                key = 'k';
                            }
                            this.paces = [];
                            this.paces.push(data.paces.normal.E[key].split('-')[1]);
                            this.paces.push(data.paces.normal.E[key].split('-')[0]);
                            this.paces.push(data.paces.normal.M[key]);
                            this.paces.push(data.paces.normal.T[key]);
                            this.paces.push(data.paces.normal.I[key]);
                            this.paces.push(data.paces.normal.R[key]);
                            this.producePowerZones();
                        } else {
                            this.$.toast.text = 'Pace zones could not be retrieved.';
                        }
                        this.$.toast.show();
                    }.bind(this));
            },
            paceToDec: function (pace) {
                var parts = pace.split(':');
                var secondFraction = parseInt(parts[1]) / 60;
                var dec = parseInt(parts[0]) + parseFloat(secondFraction.toFixed(2));
                return dec;
            },
            decToPace: function (dec) {
                dec = parseFloat(dec);
                var min = Math.floor(dec);
                var part = dec - min;
                var seconds = part * 60;
                var stringSeconds = String(seconds.toFixed());
                if (stringSeconds.length === 1) {
                    stringSeconds = '0' + stringSeconds;
                }
                min = String(min);
                if (isNaN(min)) {
                    min = '--';
                }
                if (isNaN(stringSeconds)) {
                    stringSeconds = '--';
                }
                return min + ':' + stringSeconds;
            },
            paceToMPH: function (val) {
                var mph;
                if (user.data.units === 'feet') {
                    mph = (60/val);
                } else {
                    mph = (37.2822715/val);
                }
                return mph;
            },
            producePowerZones: function () {
                var slope, offset;
                if (!this.useTest) {
                    var slopeNonWeight = 0.5421;
                    offset = 0.0649;
                    var weightKg = parseInt(user.data.weight);
                    if (user.data.units === 'feet') {
                        weightKg = weightKg * 0.453592;
                    }
                    offset = offset * weightKg;
                    slope = slopeNonWeight * weightKg;
                } else {
                    var paceSlope = this.paceToMPH(this.critPace.threeDec) - this.paceToMPH(this.critPace.nineDec);
                    var powerSlope = this.critPower.three - this.critPower.nine;

                    slope = powerSlope / paceSlope;
                    offset = this.critPower.three - slope * this.paceToMPH(this.critPace.threeDec);
                }
                var powers = [];
                for (var i = 0; i < 6; i++) {
                    var pace = this.paces[i];
                    var power = (this.paceToMPH(this.paceToDec(pace)) * slope + offset).toFixed(0);
                    powers.push(power);
                }
                var names = ['Easy', 'Aerobic', 'Tempo', 'Threshold', 'VO2'];
                this.clearZones();
                for (i = 0; i < 5; i++) {
                    var paceLow = this.paces[i];
                    var last = parseInt(paceLow.charAt(paceLow.length-1)) + 1;
                    var paceLowPlus;
                    if (last === 10 || isNaN(last)) {
                        paceLowPlus = paceLow;
                    } else {
                        paceLowPlus = paceLow.slice(0, -1) + last;
                    }
                    console.log(paceLow, last, paceLowPlus);
                    var zone = {
                        name: names[i],
                        power_low: parseInt(powers[i]) + 1,
                        power_high: powers[i+1],
                        pace_low: paceLowPlus,
                        pace_high: this.paces[i+1]
                    };
                    this.addZone(zone);
                }
                this.$.toast.text = 'Zones are updated.';
                this.$.toast.show();
            }
        });
    </script>
</dom-module>