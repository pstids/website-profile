<dom-module id="heat-duration">
<style>
	:host {
		width: 100%;
		height: 600px;
		@apply(--layout);
		@apply(--layout-horizontal);
		position: relative;
	}
	#heatcontainer {
		height: 600px;
		width: 100%:;
	}
	#heatcanvas {
		width: 960px;
		height: 500px;
		position: absolute;
	}
</style>
<template>
	<div id="heatcontainer">
		<canvas width="960" height="500" id="heatcanvas"></canvas>
	</div>
</template>
<script>
Polymer({
	is: 'heat-duration',
	ready: function () {
		this.width = 960;
		this.height = 500;
		this.data = {};
		superagent
			.get('/powercenter/scripts/heat.json')
			.send()
			.set('Accept', 'application/json')
			.end((err, res) => {
				if (res.ok) {
					this.data = res.body;
					this.createChart();
				} else {
					console.log('Error: cannot fetch data');
				}
			});
	},
	createChart: function () {
		this.dx = this.data.heatmaps[0].length;
		this.dy = this.data.heatmaps.length;

		var x = d3.scale.linear()
			.domain([0, this.dx])
			.range([0, this.width]);
		var y = d3.scale.linear()
			.domain([0, this.dy])
			.range([this.height, 0]);

		var xAxis = d3.svg.axis()
			.scale(x)
			.orient('top')
			.tickFormat((d) => {
				var unit = ' secs';
				var val = this.data.windows[d-1];
				if (val > 60) {
					val /= 60;
					unit = ' mins';
				}
				return [`${val}${unit}`];
			})
			.ticks(10);

		var yAxis = d3.svg.axis()
			.scale(y)
			.orient('right')
			.tickFormat((d) => {
				return this.data.powers[d];
			});

		var svg = d3.select('#heatcontainer')
			.append('svg')
			.style('position', 'absolute')
			.attr('width', this.width)
			.attr('height', this.height)
				.append('g')
				.attr('transform', 'translate(0, 0)');

		var line = d3.svg.line()
			/* unused: d */
			.x((d, i) => {
				return x(i);
			})
			.y((d) => {
				return y(d);
			});

		svg.append('path')
			.datum(this.data.maxs)
			.attr('class', 'line')
			.attr('d', line)
			.attr('stroke', '#f4931f')
			.attr('stroke-width', 4)
			.attr('border', '')
			.attr('fill', 'rgba(0, 0, 0, 0)');

		svg.append('g')
			.attr('class', 'x axis')
			.attr('transform', `translate(0, ${this.height})`)
			.attr('stroke', '#FFFFFF')
			.attr('fill', '#FFFFFF')
			.attr('color', '#FFFFFF')
			.call(xAxis)
			.call(this.removeZero)
				.append('text')
				.attr('transform', `translate(${this.width/2}, -50)`)
				.attr('dy', '0.71em')
				.attr('fill', '#fff')
				.text('Duration');

		svg.append('g')
			.attr('class', 'y axis')
			.attr('stroke', '#FFFFFF')
			.attr('fill', '#FFFFFF')
			.attr('color', '#FFFFFF')
			.call(yAxis)
			.call(this.removeZero)
				.append('text')
				.attr('transform', `rotate(-90), translate(${this.height*2}, 50)`)
				.attr('dy', '0.71em')
				.attr('fill', '#fff')
				.text('Power (W)');

		this.draw();
	},
	/* globals HeatCanvas:true */
	draw: function () {
		var heatmap = new HeatCanvas(this.$.heatcanvas);
		for (var y = 0; y < this.dy; y++) {
			for (var x = 0; x < this.dx; x++) {
				var pt = this.getXY(x, y, this.dx, this.dy);
				var it = this.getIntensity(this.data.heatmaps[y][x]);
				heatmap.push(Math.round(pt.x), Math.round(pt.y), it);
			}
		}
		heatmap.render(null, null, (value) => {
			var h = (1 - value);
			var s = 0.8;
			var l = value * 0.6;
			var a = 1;
			if (value < 0.3) {
				a = value * (10/3);
			}
			return [h, s, l, a];
		});
	},
	getXY: function (xi, yi, xm, ym) {
		var width = 960;
		var height = 500;
		var partx = width / xm;
		var party = height / ym;
		return {
			x: partx * xi + (partx/2),
			y: party * yi + (party/2)
		};
	},
	getIntensity: function (value) {
		if (value === 0) {
			return 0;
		}
		var high = 210;
		return ((value/high)*30) + 20;
	},
	removeZero: function (axis) {
		axis.selectAll('g')
			.filter((d) => {
				return !d;
			}).remove();
	}
});
</script>
</dom-module>