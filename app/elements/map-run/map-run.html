<dom-module id='map-run'>
    <style>
        #map {
            width: 100%;
            height: 75vh;
        }
    </style>
    <template>
        <div id='map'></div>
        <!-- <map-summary></map-summary> -->
    </template>
    <script async defer src='https://maps.googleapis.com/maps/api/js?key=AIzaSyC-D84ZWKQT9kbZ8meKUu1yvklQUtWRiOg&callback=mapReady'></script>
    <script>
        var mapReadyTrigger = false;
        var mapReadyEvent = new Event('MapReady');
        window.mapReady = function () {
            mapReadyTrigger = true;
            window.dispatchEvent(mapReadyEvent);
        };
        Polymer({
            is: 'map-run',
            ready: function () {
                this.center = {
                    lat: 0,
                    lng: 0
                };
                this.mapObjs = [];
            },
            setData: function (data) {
                this.data = data;
                if (mapReadyTrigger) {
                    this.setMap();
                    this.setDataReady(data);
                } else {
                    window.addEventListener('MapReady', function() {
                        this.setMap();
                        this.setDataReady(this.data);
                    }.bind(this));
                }
            },
            setMap: function () {
                this.strydDarkId = 'strydDarkStyle';
                this.strydDarkStyle = new google.maps.StyledMapType([
                    {
                        'featureType': 'All',
                        'elementType': 'All'
                    },
                    {
                        'featureType': 'All',
                        'elementType': 'All',
                        'stylers': [
                            { 'lightness': -50 },
                            { 'hue': '#1f1f1f' },
                            { 'saturation': -80 },
                            { 'weight': 1.3 },
                            { 'visibility': 'simplified' },
                            { 'gamma': 0.63 }
                        ]
                    },
                    {
                        'elementType': 'labels.text',
                        'stylers': [
                            { 'visibility': 'off' }
                        ]
                    }
                ], { name: 'Power Map' });

                this.map = new google.maps.Map(
                    this.$.map,
                    {
                        center: {
                            lat: 40.0274,
                            lng: -105.2519
                        },
                        zoom: 14,
                        panControl: false,
                        zoomControl: true,
                        scaleControl: false,
                        scrollwheel: false,
                        mapTypeControlOptions: {
                            mapTypeIds: [google.maps.MapTypeId.SATELLITE, this.strydDarkId]
                        }
                    }
                );
                this.map.mapTypes.set(this.strydDarkId, this.strydDarkStyle);
                this.map.setMapTypeId(this.strydDarkId);
            },
            setDataReady: function (graphSegments) {
                var i, path, step, graphSegment;
                for (i = 0; i < this.mapObjs.length; i++) {
                    this.mapObjs[i].setMap(null);
                }
                var bounds = new google.maps.LatLngBounds();
                step = 1;
                if (graphSegments.length > 200) {
                    step = parseInt(graphSegments.length / 200);
                }
                for (i = 0; i < graphSegments.length; i=i+step) {
                    // Set segments on map
                    graphSegment = graphSegments[i];
                    path = new google.maps.Polyline({
                        path: graphSegment.location,
                        geodesic: false,
                        strokeColor: graphSegment.hex,
                        strokeOpacity: 1,
                        strokeWeight: 6
                    });
                    this.mapObjs.push(path);
                    path.setMap(this.map);
                    // Extend bounds for map
                    var latLng = new google.maps.LatLng(
                        graphSegment.location[0].lat,
                        graphSegment.location[0].lng
                    );
                    bounds.extend(latLng);
                }
                this.center.lat = graphSegments[0].location[0].lat;
                this.center.lng = graphSegments[0].location[0].lng;
                this.map.fitBounds(bounds);
                this.map.setCenter(bounds.getCenter());
                // Start Marker
                var start = new google.maps.Marker({
                    position: {
                        lat: this.center.lat,
                        lng: this.center.lng
                    },
                    map: this.map,
                    icon: {
                        url: '/profile/images/green_circle.png',
                        size: new google.maps.Size(25, 25),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(12, 12),
                        scaledSize: new google.maps.Size(20, 20)
                    }
                });
                this.mapObjs.push(start);
                // End Marker
                var stop = new google.maps.Marker({
                    position: {
                        lat: graphSegments[graphSegments.length-1].location[1].lat,
                        lng: graphSegments[graphSegments.length-1].location[1].lng
                    },
                    map: this.map,
                    icon: {
                        url: '/profile/images/red_circle.png',
                        size: new google.maps.Size(25, 25),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(12, 12),
                        scaledSize: new google.maps.Size(20, 20)
                    }
                });
                this.mapObjs.push(stop);
            }
        });
    </script>
</dom-module>