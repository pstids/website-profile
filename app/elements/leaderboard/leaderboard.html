<dom-module id="social-leaderboard">
	<style>
	:host {
		min-height: 450px;
		height: 100%;
		margin: 0;
		background: #333333;
		color: #fff;
	}
	.leaderboard {
		width: 50%;
		background: -webkit-linear-gradient(top, #262626, #1C1C1C);
		background: linear-gradient(to bottom, #262626, #1C1C1C);
		height: 100%;
	}
	.leaderboard h1 {
		@apply(--layout-horizontal);
		@apply(--layout-center);
		@apply(--layout-center-justified);

		font-size: 29px;
		color: #F5A214;
		font-weight: 800;
		margin: 15px;
	}
	.leaderboard h1 img {
		height: 80px;
		position: relative;
		top: 3px;
		margin-right: 6px;
		vertical-align: baseline;
	}
	.leaderboard ol {
		counter-reset: leaderboard;
		list-style: none;
		-webkit-padding-start: 0;
		-webkit-margin-after: 0;
		padding: 0;
		margin: 0;
		height: 100%;
		position: relative;
	}
	.leaderboard:first-child ol li {
		border-left: 0;
	}
	.leaderboard ol li {
		border-left: solid 1px orange;
		position: relative;
		z-index: 1;
		font-size: 14px;
		counter-increment: leaderboard;
		padding: 10px 25% 10px 25%;
		cursor: pointer;
		-webkit-backface-visibility: hidden;
		backface-visibility: hidden;
		-webkit-transform: translateZ(0) scale(1, 1);
		transform: translateZ(0) scale(1, 1);
		border-top: dashed 1px gray;
		border-bottom: dashed 1px gray;
		height: 57px;

		@apply(--layout-horizontal);
		@apply(--layout-center);
		@apply(--layout-center-justified);
	}
	.leaderboard ol li .count {
		z-index: 2;
		left: 15px;
		width: 25px;
		height: 25px;
		line-height: 25px;
		background: white;
		color: orange;
		font-weight: 800;
		border-radius: 20px;
		text-align: center;
	}
	.leaderboard ol li img {
		display: inline;
		width: 35px;
		height: 35px;
		border-radius: 50%;
		margin-right: 1em;
		margin-left: 1em;
	}
	.leaderboard ol li mark {
		margin: 0;
		background: none;
		color: #fff;
		font-size: 16px;
	}
	.leaderboard ol li small {
		font-size: 16px;
		flex-grow: 1;
		text-align: right;
		margin-right: 1em;
	}
	.leaderboard ol li.active {
		background: orange;
	}
	.leaderboard ol li.active .count {
		color: #1F1F1F;
	}
	.leaderboard ol li.active mark {
		color: #1F1F1F;
	}
	.leaderboard ol li.active small {
		color: #1F1F1F;
	}
	.space {
		width: 52px;
	}
	iron-icon {
		width: 12px;
		height: 12px;
		padding: 0 10px;
	}
	</style>
	<template>
		<div class="layout horizontal">
			<div class="leaderboard">
				<h1>
					<img src="https://storage.googleapis.com/stryd_static_assets/powercenter/badge.png" alt="Badge">
					<div>Weekly RSS</div>
				</h1>
				<ol data-rss="weekly"></ol>
			</div>
			<div class="leaderboard">
				<h1>
					<img src="https://storage.googleapis.com/stryd_static_assets/powercenter/badge.png" alt="Badge">
					<div>Daily RSS</div>
				</h1>
				<ol data-rss="daily"></ol>
			</div>
		</div>
	</template>
	<script>
	Polymer({
		is: 'social-leaderboard',
		ready: function () {
			var daily = new Promise(resolve => {
				superagent
					.get('/b/internal/leaderboard/1')
					.set('Accept', 'application/json')
					.set('Authorization', `Bearer: ${jwt.token}`)
					.end((err, res) => {
						if (res.ok) {
							resolve(res.body);
						} else {
							resolve(null);
						}
					});
			});
			var weekly = new Promise(resolve => {
				superagent
					.get('/b/internal/leaderboard/7')
					.set('Accept', 'application/json')
					.set('Authorization', `Bearer: ${jwt.token}`)
					.end((err, res) => {
						if (res.ok) {
							resolve(res.body);
						} else {
							resolve(null);
						}
					});
			});
			Promise.all([daily, weekly])
				.then(values => {
					var max = 10;
					if (values[0].user.rank <= 28 || values[1].user.rank <= 28) {
						max = 8;
					}
					if (values[0] !== null) {
						this.processEntries(values[0], 'daily', max);
					}
					if (values[1] !== null) {
						this.processEntries(values[1], 'weekly', max);
					}
				});
		},
		processEntries: function (entries, type, max) {
			var i = 0;
			var entry = {};
			var active = false;
			this.addTitle(type, 'top');
			var iterations = 10;
			if (entries.user.rank <= 28) {
				iterations = 30;
			}
			for (i = 0; i < iterations; i++) {
				entry = entries.top[i];
				active = false;
				if (entry.rank === entries.user.rank) {
					active = true;
				}
				this.addEntry(
					type,
					entry.profile,
					entry.name,
					entry.stress,
					entry.rank,
					active
				);
			}
			
			if (entries.user.rank > 29) {
				this.addTitle(type, 'mine');
				if (entries.ahead !== null) {
					for (i = 0; i < entries.ahead.length; i++) {
						entry = entries.ahead[i];
						this.addEntry(
							type,
							entry.profile,
							entry.name,
							entry.stress,
							entry.rank,
							false
						);
					}
				}
				entry = entries.user;
				this.addEntry(
					type,
					entry.profile,
					entry.name,
					entry.stress,
					entry.rank,
					true
				);
				if (entries.behind !== null) {
					for (i = 0; i < max; i++) {
						entry = entries.behind[i];
						this.addEntry(
							type,
							entry.profile,
							entry.name,
							entry.stress,
							entry.rank,
							false
						);
					}
				}
			}
		},
		addEntry: function (type, image, name, stress, order, active) {
			var li = document.createElement('li');
			if (active) {
				Polymer.dom(li).classList.add('active');
			}
			var count = document.createElement('div');
			Polymer.dom(count).classList.add('count');
			Polymer.dom(count).textContent = ++order;
			var img = document.createElement('img');
			if (image === '') {
				img.src = 'https://www.stryd.com/powercenter/images/favicon.png';
			} else {
				img.src = image;
			}
			var mark = document.createElement('mark');
			Polymer.dom(mark).textContent = name;
			var small = document.createElement('small');
			Polymer.dom(small).textContent = stress.toFixed(0);

			Polymer.dom(li).appendChild(count);
			Polymer.dom(li).appendChild(img);
			Polymer.dom(li).appendChild(mark);
			Polymer.dom(li).appendChild(small);

			var rssContainer = this.querySelector(`[data-rss="${type}"]`);
			Polymer.dom(rssContainer).appendChild(li);
		},
		addBridge: function (type) {
			var li = document.createElement('li');
			var icon1 = document.createElement('iron-icon');
			Polymer.dom(icon1).setAttribute('icon', 'image:brightness-1');
			var icon2 = document.createElement('iron-icon');
			Polymer.dom(icon2).setAttribute('icon', 'image:brightness-1');
			var icon3 = document.createElement('iron-icon');
			Polymer.dom(icon3).setAttribute('icon', 'image:brightness-1');

			Polymer.dom(li).appendChild(icon1);
			Polymer.dom(li).appendChild(icon2);
			Polymer.dom(li).appendChild(icon3);

			var rssContainer = this.querySelector(`[data-rss="${type}"]`);
			Polymer.dom(rssContainer).appendChild(li);
		},
		addTitle: function (type, title) {
			var li = document.createElement('li');
			if (title === 'top') {
				var count = document.createElement('mark');
				Polymer.dom(count).textContent = 'Rank';
				var space = document.createElement('div');
				Polymer.dom(space).classList.add('space');
				var mark = document.createElement('mark');
				Polymer.dom(mark).textContent = 'Username';
				var small = document.createElement('small');
				Polymer.dom(small).textContent = 'RSS';

				Polymer.dom(li).appendChild(count);
				Polymer.dom(li).appendChild(space);
				Polymer.dom(li).appendChild(mark);
				Polymer.dom(li).appendChild(small);

				var rssContainer = this.querySelector(`[data-rss="${type}"]`);
				Polymer.dom(rssContainer).appendChild(li);
			} else {
				this.addBridge(type);
			}
		}
	});
	</script>
</dom-module>