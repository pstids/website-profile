<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<dom-module id="log-options">
    <template>
        <style include="iron-flex"></style>
        <paper-dialog id="dialogDelete">
            <h1>Are you sure you want to remove this run?</h1>
            <div class="buttons">
                <paper-button dialog-dismiss>No</paper-button>
                <paper-button autofocus on-click="handleDelete">Yes</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="dialogShare">
            <h1>Share URL</h1>
            <div class="layout horizontal">
                <input
                    value="test"
                    type="text"
                    data-shareURL
                    style="width: 500px; height: 30px;">
                </input>
            </div>
            <div class="buttons">
                <paper-button dialog-dismiss>Close</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        class LogOptions extends Polymer.Element {
            static get is() { return 'log-options'; }
            connectedCallback () {
                super.connectedCallback();
                this.logCalendar = document.querySelector('log-calendar');
            }
            ready() {
                super.ready();
                this.shareBox = this.root.querySelector('[data-shareURL]');
                this.deleteID = null;
                this.shareID = null;
                this.descriptionID = null;
                this.logCalendar = null;
            }
            getFit(id) {
                superagent
                    .post(`/b/api/v1/activities/${id}/fit`)
                    .send()
                    .set('Accept', 'application/json')
                    .set('Authorization', `Bearer: ${jwt.token}`)
                    .end((err, res) => {
                        if (res.ok) {
                            app.setDownload(res.body.url);
                        } else {
                            console.log('Error: get download link failed', err);
                        }
                    });
            }
            callDelete(id) {
                this.deleteID = id;
                this.$.dialogDelete.open();
            }
            callShare(id) {
                this.shareID = id;
                this.shareBox.value = `${window.location.origin}${this.rootPath || '/'}run/${this.shareID}`;
                this.$.dialogShare.open();
                this.shareID = null;
            }
            callRecalculate(id) {
                superagent
                    .post(`/b/api/v1/activities/${id}/recalculate`)
                    .send()
                    .set('Accept', 'application/json')
                    .set('Authorization', `Bearer: ${jwt.token}`)
                    .end((err, res) => {
                        if (res.ok) {
                            calendarManager.recalculateActivity(id);
                            toast('Activity updated.');
                        } else {
                            console.log('failed to recalculate');
                        }
                    });
            }
            handleDelete() {
                if (this.deleteID !== null) {
                    superagent
                        .del(`/b/api/v1/activities/${this.deleteID}`)
                        .send()
                        .set('Accept', 'application/json')
                        .set('Authorization', `Bearer: ${jwt.token}`)
                        .end((err, res) => {
                            if (res.ok) {
                                if (this.logCalendar !== null) {
                                    this.logCalendar.removeActivity(this.deleteID);
                                    toast('Activity removed.');
                                }
                            } else {
                                console.log('failed to delete');
                            }
                        });
                }
                this.$.dialogDelete.close();
            }
        }
        window.customElements.define(LogOptions.is, LogOptions);
    </script>
</dom-module>
