<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<dom-module id="log-overview">
	<template>
		<style>
			:host {
				font-size: 12px;
				line-height: 1.5em;
				color: #ffffff;
				border: 1px solid #4D4D4D;
				margin: 20px;
				flex: 1;
			}
			@media (max-width: 1000px) {
				:host {
					display: none;
				}
			}
			table {
				border-collapse: collapse;
				margin: 0;
				height: 100%;
				width: 100%;
			}
			table thead {
				background-color: #222222;
				border-bottom: 1px solid #4D4D4D;
				height: 40px;
			}
			table tr {
				background: none;
			}
			table th {
				font-size: 14px;
			}
			table td {
				padding: 0;
				text-align: center;
				border: none;
			}
			table .day-wrapper {
				position: relative;
				height: 32px;
				width: 32px;
				cursor: pointer;
			}
			table a {
				color: #ffffff;
				cursor: pointer;
				text-decoration: none;
				transition: color 0.1s ease,border 0.1s ease,box-shadow 0.1s ease,background-color 0.1s ease,opacity 0.1s ease;
			}
			table .day {
				border-bottom: 2px solid #ffffff;
				font-weight: bold;
				padding-bottom: 2px;
				opacity: 0;
				transition: opacity 0.2s linear;
				-o-transition: opacity 0.2s linear;
				-ms-transition: opacity 0.2s linear;
				color: #ffffff;
			}
			table a:hover .day {
				opacity: 1;
			}
			table .activity-indicator {
				background-color: #ffffff;
				height: 2px;
				width: 2px;
				position: absolute;
				top: 50%;
				left: 50%;
				opacity: 1;
				transform: translate(-50%, -50%);
				border-radius: 100%;
				transition: opacity 0.2s linear;
			}
			table .highlighted .activity-indicator {
				background-color: #ffffff;
				height: 10px;
				width: 10px;
			}
			table a:hover .activity-indicator {
				opacity: 0;
			}

			#action {
				position: absolute;
				display: none;
			}
		</style>
		<table>
			<thead>
				<tr style="height: 70px;">
					<th>
						<div class="weekday">M</div>
					</th>
					<th>
						<div class="weekday">T</div>
					</th>
					<th>
						<div class="weekday">W</div>
					</th>
					<th>
						<div class="weekday">T</div>
					</th>
					<th>
						<div class="weekday">F</div>
					</th>
					<th>
						<div class="weekday">S</div>
					</th>
					<th>
						<div class="weekday">S</div>
					</th>
				</tr>
			</thead>
			<tbody id="container"></tbody>
		</table>
		<paper-material id="action" elevation="5">
			<paper-button data-view="" on-click="view" id="view">View</paper-button>
			<paper-button data-compare="" on-click="compare" id="compare">Compare</paper-button>
		</paper-material>
	</template>
	<script>
		class LogOverview extends Polymer.Element {
			static get is() { return 'log-overview'; }

			eleTap(e) {
				var target = e.target;
				while (true) {
					if (target === this.$.container) {
						return;
					} else if ('dataset' in target && target.dataset.id !== undefined) {
						this.$.action.style.display = 'block';
						this.$.action.style.position = 'fixed';
						this.$.action.style.top = `${e.detail.y}px`;
						if (window.innerWidth < (e.detail.x + 150)) {
							var leftPos = e.detail.x - 150;
							this.$.action.style.left = `${leftPos}px`;
						} else {
							this.$.action.style.left = `${e.detail.x}px`;
						}
						this.$.view.dataset.view = target.dataset.id;
						this.$.compare.dataset.compare = target.dataset.id;
						return;
					}
					if ('parentNode' in target && target.parentNode !== null) {
						target = target.parentNode;
					} else {
						return;
					}
				}
			}
			ready() {
				super.ready();
				this.primarySelected = null;
				this.secondarySelected = null;
			}
			connectedCallback() {
				super.connectedCallback();
				this.createCalendar();
				// window.addEventListener('scroll', () => {
				// 	if (this.$.action.style.display !== 'none') {
				// 		this.$.action.style.display = 'none';
				// 	}
				// });
				window.addEventListener('gotActivities', () => {
					this.createCalendar();
				});
			}
			createCalendar() {
				while (this.$.container.firstChild) {
					this.$.container.removeChild(this.$.container.firstChild);
				}

				var past = moment().subtract(3, 'weeks').day('Monday');
				var today = moment().add(1, 'days');
				var activities = calendarManager.getLOActivities(past, today);
				var hashed = {};
				var hash;
				for (var activity of activities) {
					hash = moment.unix(activity.timestamp).format('YYYYMMDD');
					hashed[hash] = activity;
				}
				for (var i = 0; i < 4; i++) {
					var days = [];
					for (var o = 0; o < 7; o++) {
						hash = past.format('YYYYMMDD');
						var day;
						if (hash in hashed) {
							day = hashed[hash];
						} else {
							day = {};
						}
						day.day = past.clone().format('DD');
						days.push(day);
						past.add(1, 'day');
					}
					var row = this.addRow(days);
					util.patchClasses(row, this);
					this.$.container.appendChild(row);
				}
			}
			addRow(days) {
				var row = document.createElement('tr');
				for (var day of days) {
					var dayEle = this.addDay(day);
					util.patchClasses(dayEle, this);
					row.appendChild(dayEle);
				}
				return row;
			}
			addDay(day) {
				var td = document.createElement('td');
				td.classList.add('day-wrapper');
				if ('timestamp' in day) {
					td.classList.add('highlighted');
					td.dataset.id = day.id;
				}

				var a = document.createElement('a');

				var spanDay = document.createElement('span');
				spanDay.classList.add('day');
				spanDay.textContent = day.day;

				var spanIndicator = document.createElement('span');
				spanIndicator.classList.add('activity-indicator');

				a.appendChild(spanDay);
				a.appendChild(spanIndicator);

				util.patchClasses(a, this);
				td.appendChild(a);
				return td;
			}
			view(e) {
				var id = +e.target.dataset.view;
				urlManager.setURL(id, 0);
				this.$.action.style.display = 'none';
			}
			compare(e) {
				var id = +e.target.dataset.compare;
				urlManager.compareRun(id);
				this.$.action.style.display = 'none';
			}
		}
		window.customElements.define(LogOverview.is, LogOverview);
	</script>
</dom-module>