<dom-module id="log-day">
    <style>
        :host {
            @apply(--layout-flex);
            @apply(--layout-vertical);
            position: relative;
        }
        :host:hover .header {
            opacity: 1;
        }
        :host:hover .header .options {
            opacity: 1;
        }

        .hasWorkout {
            background-image: url(https://storage.googleapis.com/stryd_static_assets/calendar-entry.png);
            cursor: pointer;
        }
        .hasNoWorkout {
            cursor: auto;
            background-image: 'none';
        }
        .hasNoWorkout .data,
        .hasNoWorkout .options,
        .hasPlanned .data,
        .hasPlanned .options {
            display: none !important;
        }
        .hasPlanned {
            cursor: pointer;
            background-image: 'none';
        }

        .container {
            @apply(--layout-flex);
            @apply(--layout-vertical);
            overflow: hidden;
            background-size: cover;
            /*min-height: 100px;*/
            height: 100%;
        }

        .header {
            @apply(--layout-horizontal);
            @apply(--layout-end-justified);
            height: 24px;
            padding: 0 3px;
            opacity: 0.6;
            transition: 0.5s opacity;
            flex: 0 1 24px;
        }
        .header .options {
            @apply(--layout-flex-3);
            @apply(--layout-horizontal);
            opacity: 0;
            transition: 0.5s opacity;
        }
        .header .tp, .header .numday {
            text-align: right;
            color: white;
            line-height: 24px;
            font-size: 14px;
        }

        .wattage {
            margin-top: 20px;
            @apply(--layout-center-justified);
            @apply(--layout-center);
            @apply(--layout-horizontal);
        }
        .wattage .value {
            color: white;
            text-align: center;
            font-size: 30px;

            margin-right: 10px;
        }
        .wattage .unit {
            color: white;
            text-align: center;
            font-size: 20px;
        }

        .other {
            height: 28px;
            margin-bottom: 5px;
        }
        .stat {
            height: 28px;
            @apply(--layout-center-justified);
            @apply(--layout-center);
            @apply(--layout-horizontal);
        }
        .stat .value {
            color: white;
            text-align: center;
            font-size: 14px;
            font-weight: 300;
        }
        .stat iron-icon {
            margin-right: 5px;
            color: var(--primary-icon-color);
            fill: var(--primary-icon-color);
            height: 14px;
            width: 14px;
        }

        .wattage iron-icon {
            margin-right: 5px;
            color: var(--primary-icon-color);
            fill: var(--primary-icon-color);
        }

        .header iron-icon {
            color: white;
            fill: white;
            margin: 5px 3px;
            width: 14px;
            height: 14px;
            cursor: pointer;
        }
    </style>
    <template>
        <div class="container hasNoWorkout" id="container">
            <div class="header" id="header">
                <div class="options">
                    <div id="share">
                        <iron-icon icon="social:share"></iron-icon>
                        <paper-tooltip>Share Workout</paper-tooltip>
                    </div>
                    <div id="fit">
                        <iron-icon icon="icons:file-download"></iron-icon>
                        <paper-tooltip>Download FIT</paper-tooltip>
                    </div>
                    <div id="delete">
                        <iron-icon icon="icons:delete"></iron-icon>
                        <paper-tooltip>Delete</paper-tooltip>
                    </div>
                    <div id="pin" class="hidden">
                        <iron-icon icon="maps:place"></iron-icon>
                        <paper-tooltip>Pin to Graph</paper-tooltip>
                    </div>
                </div>
                <div class="tp hidden" id="tpp">
                    <iron-icon icon="icons:track-changes"></iron-icon>
                </div>
                <div class="numday">
                    {{day}}
                </div>
            </div>
            <div class="layout vertical center-justified flex-auto data">
                <div class="wattage">
                    <iron-icon icon="image:flash-on"></iron-icon>
                    <div class="value">
                        {{power}}
                    </div>
                </div>
                <div class="layout horizontal around-justified other">
                    <div class="stat">
                        <iron-icon icon="image:timer"></iron-icon>
                        <div class="value">
                            {{time}}
                        </div>
                    </div>
                    <div class="stat">
                        <iron-icon icon="communication:swap-calls"></iron-icon>
                        <div class="value">
                            {{distance}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <script>
    /*global updatedTime:true*/
    Polymer({
        is: 'log-day',
        listeners: {
            'tap': 'eleTap'
        },
        eleTap: function (e) {
            var target = e.target;
            while (true) {
                if (target === this.$.container) {
                    this.viewWorkout();
                    return;
                } else if (target.id === 'share') {
                    if ('id' in this.data) {
                        this.logOption.callShare(this.data.id);
                    }
                    return;
                } else if (target.id === 'fit') {
                    this.fit();
                    return;
                } else if (target.id === 'delete') {
                    if ('id' in this.data) {
                        this.logOption.callDelete(this.data.id);
                    }
                    return;
                }
                if ('parentNode' in target && target.parentNode !== null) {
                    target = target.parentNode;
                } else {
                    return;
                }
            }
        },
        attached: function () {
            this.logOption = document.querySelector('log-options');
        },
        ready: function () {
            this.data = {
                day: 0
            };
            this.setData(this.data);
        },
        clearWorkout: function () {
            this.data = {};
            this.classList.remove('active');
        },
        setData: function (data) {
            this.data = data;
            this.day = data.day;
            this.rgb = 'rgb(0, 0, 0)';
            if ('power' in data) {
                if ('training' in data) {
                    Polymer.dom(this.$.tpp).classList.remove('hidden');
                } else {
                    Polymer.dom(this.$.tpp).classList.add('hidden');
                }

                this.$.container.classList.add('hasWorkout');
                this.$.container.classList.remove('hasNoWorkout');
                this.$.container.classList.remove('hasPlanned');

                this.unit = 'watts';
                this.power = data.power.toFixed(0);
                this.distance = meterToUserUnit(this.data.distance);

                var duration = moment.duration(this.data.time, 'seconds');
                var minutesStr = duration.minutes().toString();
                if (minutesStr.length === 1) {
                    minutesStr = `0${minutesStr}`;
                }
                this.time = `${duration.hours()}:${minutesStr}`;

                var relativePower;
                if (data.power > colorInterpolate.threshold.high) {
                    relativePower = colorInterpolate.threshold.range;
                } else if (data.power < colorInterpolate.threshold.low) {
                    relativePower = 0;
                } else {
                    relativePower = (data.power - colorInterpolate.threshold.low);
                }

                this.rgb = colorInterpolate.RGB(relativePower);

                this.$.header.style.backgroundColor = this.rgb;
            } else {
                if ('training' in data) {
                    this.$.container.classList.remove('hasWorkout');
                    this.$.container.classList.remove('hasNoWorkout');
                    this.$.container.classList.add('hasPlanned');
                    Polymer.dom(this.$.tpp).classList.remove('hidden');
                } else {
                    this.$.container.classList.remove('hasWorkout');
                    this.$.container.classList.add('hasNoWorkout');
                    this.$.container.classList.remove('hasPlanned');
                    Polymer.dom(this.$.tpp).classList.add('hidden');
                }

                this.unit = '';
                this.power = '';
                this.rgb = 'rgb(0, 0, 0)';
                this.$.header.style.backgroundColor = this.rgb;
            }
        },
        fit: function () {
            superagent
                .post(`/b/api/v1/activities/${this.data.id}/fit`)
                .send()
                .set('Accept', 'application/json')
                .set('Authorization', `Bearer: ${jwt.token}`)
                .end((err, res) => {
                    if (res.ok) {
                        document.querySelector('#dlFrame').src = res.body.url;
                    } else {
                        console.log('Error: get download link failed', err);
                    }
                });
        },
        viewWorkout: function () {
            if (!('id' in this.data)) {
                return;
            }
            var bubbles = document.querySelector('.bubbles');
            // Set this element as the only active element
            var logDayActive = document.querySelector('log-day.active');
            if (logDayActive) {
                logDayActive.classList.remove('active');
            }
            this.classList.add('active');
            updatedTime = this.data.updated_time;

            document.querySelector('workout-element').setLoading();
            page(`/run/${this.data.id}`);
            window.scrollTo(0, bubbles.offsetTop);
        },
        // returns true or false whether a workout has been inserted already
        hasWorkout: function () {
            if ('power' in this.data) {
                return true;
            }
            return false;
        },
        getID: function () {
            if ('id' in this.data) {
                return this.data.id;
            }
            return 0;
        },
        getDay: function () {
            if ('day' in this.data) {
                return this.data.day;
            }
            return 0;
        }
    });
    // var tooltip = document.querySelector('[data-tooltip]');
    // var tooltipDescription = tooltip.querySelector('#description');

    // this.$.container.addEventListener(
    //     'mouseenter',
    //     () => {
    //         if (
    //             'description' in this.data &&
    //             this.data.description.length > 0
    //         ) {
    //             tooltip.classList.remove('hidden');
    //             tooltip.style.borderColor = this.rgb;

    //             var duration = moment.duration(this.data.time, 'seconds');
    //             var minutesStr = duration.minutes().toString();
    //             if (minutesStr.length === 1) {
    //                 minutesStr = '0' + minutesStr;
    //             }
                
    //             if (this.data.description.length > 40) {
    //                 tooltipDescription.textContent = this.data.description.substring(0, 40) + '...';
    //             } else {
    //                 tooltipDescription.textContent = this.data.description;
    //             }
    //         } else if ('training' in this.data) {
    //             tooltip.classList.remove('hidden');
    //             tooltip.style.borderColor = this.rgb;

    //             tooltipDescription.textContent = this.data.training.description;
    //         }
    //     },
    //     false
    // );

    // this.$.container.addEventListener(
    //     'mouseleave',
    //     () => {
    //         if (
    //             'description' in this.data ||
    //             'training' in this.data   
    //         ) {
    //             tooltip.classList.add('hidden');
    //         }
    //     },
    //     false
    // );
    </script>
</dom-module>

