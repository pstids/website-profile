<dom-module id="log-day">
    <style>
        :host {
            @apply(--layout-flex);
            @apply(--layout-vertical);
            position: relative;
            border-right: 1px solid #4d4d4d;
            transition: 0.5s border;
        }
        :host:hover.hasChild {
            border: 1px solid #FFFFFF;
            border-bottom:none;
            box-sizing: border-box;
        }
        :host:hover log-day {
            display: block !important;
        }
        :host log-day:last-child {
            border-bottom: 1px solid #FFFFFF;
        }
        :host:hover .header .options {
            opacity: 1;
        }
        :host:last-child {
            border-right: 0;
        }
        :host.active {
            border: 1px solid #FFFFFF;
        }

        .half-items {
            @apply(--layout-vertical);
            position: absolute;
            width: 100%;
            top: 100%;
        }
        :host:hover .half-items log-day {
            display: block !important;
        }
        .half-items log-day {
            z-index: 300;
            width: 100%;
            border-left: 1px solid #FFFFFF;
            border-right: 1px solid #FFFFFF;
            left: -1px;
            flex: 1;
        }
        .half-items .container {
            min-height: 70px;
        }
        .half-items log-day .wattage {
            margin-top: 0;
        }
        .half-items log-day:last-child {
            border-bottom: 1px solid #FFFFFF;
        }
        .half-items .other {
            display: none;
        }

        .container {
            @apply(--layout-flex);
            @apply(--layout-vertical);
            overflow: hidden;
            
            cursor: pointer;
            background-image: url(https://storage.googleapis.com/stryd_static_assets/calendar-entry.png);
            background-size: cover;
            min-height: 100px;
        }
        .container:hover .header {
            opacity: 1;
        }

        .header {
            @apply(--layout-horizontal);
            height: 24px;
            padding: 0 3px;
            opacity: 0.6;
            transition: 0.5s opacity;
            flex: 0 1 24px;
        }
        .header .options {
            @apply(--layout-flex-2);
            @apply(--layout-horizontal);
            opacity: 0;
            transition: 0.5s opacity;
        }

        .header .numday {
            @apply(--layout-flex);
            text-align: right;
            color: white;
            line-height: 24px;
            font-size: 14px;
        }

        .wattage {
            margin-top: 20px;
            @apply(--layout-center-justified);
            @apply(--layout-center);
            @apply(--layout-horizontal);
        }
        .wattage .value {
            color: white;
            text-align: center;
            font-size: 30px;

            margin-right: 10px;
        }
        .wattage .unit {
            color: white;
            text-align: center;
            font-size: 20px;
        }

        .other {
            height: 28px;
        }
        .distance, .time {
            height: 28px;
            @apply(--layout-center-justified);
            @apply(--layout-center);
            @apply(--layout-horizontal);
        }
        .distance .value, .time .value {
            color: white;
            text-align: center;
            font-size: 14px;
            font-weight: 300;
        }

        .wattage iron-icon {
            margin-right: 5px;
            color: var(--primary-icon-color);
            fill: var(--primary-icon-color);
        }

        .distance iron-icon, .time iron-icon {
            margin-right: 5px;
            color: var(--primary-icon-color);
            fill: var(--primary-icon-color);
            height: 14px;
            width: 14px;
        }

        .options iron-icon {
            color: white;
            fill: white;
            margin: 5px 3px;
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .more {
            font-size: 12px;
            text-align: center;
            background-color: #000000;
            opacity: 0.6;
            color: #FFFFFF;
        }
    </style>
    <template>
        <div class="container" id="container">
            <div class="header" id="headera">
                <div class="options" id="options">
                    <div id="share">
                        <iron-icon icon="social:share"></iron-icon>
                        <paper-tooltip>Share Workout</paper-tooltip>
                    </div>
                    <div id="fit">
                        <iron-icon icon="icons:file-download"></iron-icon>
                        <paper-tooltip>Download FIT</paper-tooltip>
                    </div>
                    <div id="delete">
                        <iron-icon icon="icons:delete"></iron-icon>
                        <paper-tooltip>Delete</paper-tooltip>
                    </div>
                    <div id="pin" class="hidden">
                        <iron-icon icon="maps:place"></iron-icon>
                        <paper-tooltip>Pin to Graph</paper-tooltip>
                    </div>
                </div>
                <div class="numday">
                    {{day}}
                </div>
            </div>
            <div class="layout vertical center-justified flex-auto" id="data">
                <div class="wattage">
                    <iron-icon icon="image:flash-on"></iron-icon>
                    <div class="value">
                        {{power}}
                    </div>
                </div>
                <div class="layout horizontal around-justified other">
                    <div class="time">
                        <iron-icon icon="image:timer"></iron-icon>
                        <div class="value">
                            {{time}}
                        </div>
                    </div>
                    <div class="distance">
                        <iron-icon icon="communication:swap-calls"></iron-icon>
                        <div class="value">
                            {{distance}}
                        </div>
                    </div>
                </div>
            </div>

            <div class="more hidden" id="more">{{more}}</div>


        </div>
        <div class="half-items" id="half">
            
        </div>
    </template>
    <script>
        /*global page*/
        /*global updatedTime:true*/
        class Color {
            constructor(r, g, b) {
                this.r = r;
                this.g = g;
                this.b = b;
            }
            getColors() {
                return {
                    r: this.r,
                    g: this.g,
                    b: this.b
                };
            }
        }
        var lowColorRGB = new Color(95, 180, 61), highColorRGB = new Color(243, 60, 52);
        var lowColors = lowColorRGB.getColors(), highColors = highColorRGB.getColors();
        var interpolate = function (start, end, steps, count) {
            var s = start,
                e = end,
                final = s + (((e - s) / steps) * count);
            return Math.floor(final);
        };
        var threshold = {
            range: 200,
            high: 400,
            low: 200
        };

        Polymer({
            is: 'log-day',
            attached: function () {
                this.logOption = document.querySelector('log-options');
            },
            clearWorkout: function () {
                this.data = {};
                this.sameDays = [];
                this.classList.remove('hasChild');
                this.classList.remove('active');

                this.$.more.classList.add('hidden');
                var logDays = this.querySelectorAll('log-day');
                for (var i = 0; i < logDays.length; i++) {
                    this.$.half.removeChild(logDays[i]);
                }
            },
            ready: function () {
                this.sameDays = [];
                this.data = {};

                this.more = 'hover for more';

                this.$.container.addEventListener('click', function (e) {
                    var found = false;
                    var target = e.target;
                    while (!found) {
                        if (target === this.$.container) {
                            this.viewWorkout();
                            found = true;
                        } else if (target.id === 'share') {
                            if ('id' in this.data) {
                                this.logOption.callShare(this.data.id);
                            }
                            found = true;
                        } else if (target.id === 'fit') {
                            this.fit();
                            found = true;
                        } else if (target.id === 'delete') {
                            if ('id' in this.data) {
                                this.logOption.callDelete(this.data.id);
                            }
                            found = true;
                        }
                        target = target.parentNode;
                    }
                }.bind(this));

                var tooltip = document.querySelector('[data-tooltip]');
                var tooltipTime = tooltip.querySelector('#time');
                var tooltipDistance = tooltip.querySelector('#distance');
                var tooltipDescription = tooltip.querySelector('#description');

                this.$.container.addEventListener('mouseenter', function () {
                    if ('description' in this.data && this.data.description.length > 0) {
                        tooltip.classList.remove('hidden');
                        tooltip.style.borderColor = this.rgb;

                        var duration = moment.duration(this.data.time, 'seconds');
                        var minutesStr = duration.minutes().toString();
                        if (minutesStr.length === 1) {
                            minutesStr = '0' + minutesStr;
                        }
                        // tooltipTime.textContent = `${duration.hours()}:${minutesStr} duration`;
                        tooltipTime.textContent = '';
                        // var distance = meterToUserUnit(this.data.distance);
                        // tooltipDistance.textContent = distance;
                        tooltipDistance.textContent = '';
                        
                        if (this.data.description.length > 40) {
                            tooltipDescription.textContent = this.data.description.substring(0, 40) + '...';
                        } else {
                            tooltipDescription.textContent = this.data.description;
                        }
                    }
                }.bind(this), false);

                this.$.container.addEventListener('mouseleave', function () {
                    if ('power' in this.data) {
                        tooltip.classList.add('hidden');
                    }
                }.bind(this), false);
            },
            setData: function (data) {
                this.data = data;
                this.day = data.day;
                this.rgb = '#000000';
                if ('power' in data) {
                    this.$.options.classList.remove('hidden');
                    this.$.container.style.cursor = 'pointer';
                    if (this.$.container.style.backgroundImage !== 'url(https://storage.googleapis.com/stryd_static_assets/calendar-entry.png)') {
                        this.$.container.style.backgroundImage = 'url(https://storage.googleapis.com/stryd_static_assets/calendar-entry.png)';
                    }

                    this.$.data.classList.remove('hidden');
                    this.unit = 'watts';
                    this.power = data.power.toFixed(0);

                    var distance = meterToUserUnit(this.data.distance);
                    this.distance = distance;

                    var duration = moment.duration(this.data.time, 'seconds');
                    var minutesStr = duration.minutes().toString();
                    if (minutesStr.length === 1) {
                        minutesStr = '0' + minutesStr;
                    }
                    this.time = `${duration.hours()}:${minutesStr}`;

                    var relativePower;
                    if (data.power > threshold.high) {
                        relativePower = threshold.range;
                    } else if (data.power < threshold.low) {
                        relativePower = 0;
                    } else {
                        relativePower = (data.power - threshold.low);
                    }

                    var r = interpolate(lowColors.r, highColors.r, threshold.range, relativePower);
                    var g = interpolate(lowColors.g, highColors.g, threshold.range, relativePower);
                    var b = interpolate(lowColors.b, highColors.b, threshold.range, relativePower);
                    this.rgb = `rgb(${r}, ${g}, ${b})`;

                    this.$.headera.style.backgroundColor = this.rgb;
                } else {
                    this.$.options.classList.add('hidden');
                    this.$.container.style.cursor = 'auto';
                    this.$.container.style.backgroundImage = 'none';

                    this.$.data.classList.add('hidden');
                    this.unit = '';
                    this.power = '';
                    this.rgb = `rgb(0, 0, 0)`;
                    this.$.headera.style.backgroundColor = this.rgb;
                }
            },
            fit: function () {
                superagent
                    .post('/b/api/v1/activities/' + this.data.id + '/fit')
                    .send()
                    .set('Accept', 'application/json')
                    .set('Authorization', 'Bearer: ' + jwt.token)
                    .end(function(err, res) {
                        if (res.ok) {
                            document.querySelector('#dlFrame').src = res.body.url;
                            // window.open(res.body.url);
                        } else {
                            console.log('get download link failed');
                        }
                    }.bind(this));
            },
            viewWorkout: function () {
                if (!('id' in this.data)) {
                    return;
                }
                var bubbles = document.querySelector('.bubbles');
                // Set this element as the only active element
                var logDayActive = document.querySelector('log-day.active');
                if (logDayActive) {
                    logDayActive.classList.remove('active');
                }
                this.classList.add('active');
                updatedTime = this.data.updated_time;

                document.querySelector('workout-element').setLoading();
                page(`/run/${this.data.id}`);
                window.scrollTo(0, bubbles.offsetTop);
            },
            // returns true or false whether a workout has been inserted already
            hasWorkout: function () {
                if ('power' in this.data) {
                    return true;
                }
                return false;
            },
            // add another workout to this day
            addChild: function (node) {
                console.log('added child element');
                this.classList.add('hasChild');

                this.$.more.classList.remove('hidden');

                node.style.display = 'none';

                Polymer.dom(this.$.half).appendChild(node);

                this.sameDays.push(node);
            },
            getID: function () {
                if ('id' in this.data) {
                    return this.data.id;
                }
                return 0;
            },
            getDay: function () {
                if ('day' in this.data) {
                    return this.data.day;
                }
                return 0;
            }
        });
    </script>
</dom-module>
