<dom-module id="performance-management">
	<style>
		:host {
			background-color: #222222;
			display: block;
		}
		.bar:hover {
			opacity: 0.66;
		}
		.grid .tick {
			stroke: lightgrey;
			opacity: 0.7;
		}
		.grid path {
			stroke-width: 0;
		}
		.d3-tip {
			line-height: 1;
			font-weight: bold;
			padding: 12px;
			background: rgba(120, 120, 120, 0.8);
			color: #fff;
			border-radius: 2px;
		}
		.d3-tip:after {
			box-sizing: border-box;
			display: inline;
			font-size: 10px;
			width: 100%;
			line-height: 1;
			color: rgba(120, 120, 120, 0.8);
			content: '\25BC';
			position: absolute;
			text-align: center;
		}
		.d3-tip.n:after {
			margin: -1px 0 0 0;
			top: 100%;
			left: 0;
		}
		#svg {
			width: 940px;
			margin: 0 auto;
		}
		.y.axis text {
			color: white;
			font-family: 'Roboto';
		}
		.x.axis text {
			color: white;
			font-family: 'Roboto';
		}
	</style>
	<template>
		<div id="demo">
			<div id="buttons">
				<button id="weekly-stress">View Weekly</button>
				<button id="zone-break">Toggle Time In Zones Overlay</button>
			</div>
			<div id="buttons2">
				<button id="view_stress"><b>View Stress<b></button>
				<button id="view_dist"><b>View Distance<b></button>
				<button id="view_time"><b>View Time<b></button>
			</div>
			<svg id="svg"></svg>
		</div>
	</template>
	<script>
	Polymer({
		is: 'performance-management',
		ready: function () {
			this.mode = 0;
			this.max = 0;

			this.width = 860;
			this.height = 400;

			this.zBars = 0;
			this.gInd = 0;
			this.gZones = 0;
			this.gMode = 0;
			this.gCmd = 0;
			this.gMax = 0;
			this.toggledOn = 0;

			this.weekDays = ['Mon', 'Tues', 'Wed', 'Thur', 'Fri', 'Sat', 'Sun'];
			this.weekNames = ['09/25', '10/02', '10/09', '10/16', '10/23', '10/30', '11/06', '11/13', '11/20', '11/27', '12/04'];

			this.grabData();

			//window.addEventListener('resize', this.render);
		},
		updateDimensions: function (winWidth) {
			var dimensions = {
				margin: {
					top: 20,
					bottom: 50,
					right: 50,
					left: 50
				}
			};

			dimensions.width = winWidth - dimensions.margin.left - dimensions.margin.right;
			dimensions.height = 840 - dimensions.margin.top - dimensions.margin.bottom;

			return dimensions;
		},
		render: function () {
			this.dimensions = this.updateDimensions(window.innerWidth);

			this.x.range([0, this.dimensions.width]);
			this.y.range([this.dimensions.height, 0]);

			this.graph.attr('width', this.dimensions.width + 100)
				.attr('height', this.dimensions.height + 100);

			this.xAxis.scale(this.x);
			this.yAxis.scale(this.y);

			this.graph.select('.x.axis')
				.attr('transform', 'translate(0,' + this.dimensions.height + ')')
				.call(this.xAxis);

			this.graph.select('.y.axis')
				.call(this.yAxis);
		},
		getDayName: function (idx) {
			return this.weekDays[idx % 7];
		},
		getWeekName: function (idx) {
			return this.weekNames[idx];
		},
		fillInit: function () {
			this.dimensions = this.updateDimensions(500);
			this.graph = d3.select('#svg')
				.attr('width', this.dimensions.width + 100)
				.attr('height', this.dimensions.height + 100);

			this.graph.append('svg:rect')
				.attr('stroke', '#000')
				.attr('fill', 'none');

			this.graph.append('svg:g')
				.attr('id', 'barchart')
				.attr('transform', 'translate(50, 50)');

			this.x = d3.scale.ordinal()
				.range([0, this.dimensions.width])
				.rangeBands([0, this.dimensions.width], 0.3);

			this.y = d3.scale.linear()
				.domain([0, this.max])
				.range([this.dimensions.height, 0]);

			this.xAxis = d3.svg.axis()
				.scale(this.x)
				.tickSize(1)
				.orient('bottom')
				.innerTickSize(-this.dimensions.height)
				.outerTickSize(0);

			this.yAxis = d3.svg.axis()
				.scale(this.y)
				.tickSize(1)
				.tickFormat(d3.format('.1f'))
				.orient('left')
				.innerTickSize(-this.dimensions.width)
				.outerTickSize(0);

			d3.select('#weekly-stress')
				.on('click', () => {
					if (this.zBars) {
						d3.select('#barchart')
							.selectAll('*')
							.remove();
						this.zBars = 0;
					}
					this.fillBars(this.gMode, 'weeks');
					this.gCmd = 0;
					d3.select('#weekly-stress')
						.style('opacity', 0.5);
					if (this.gMode === 2) {
						d3.select('#zone-break')
							.style('opacity', 1);
						d3.select('#zone-break')
							.on('click', this.zFun.bind(this));
					}
				})
				.style('opacity', 0.5);

			d3.select('#view_stress')
				.on('click', this.sFun.bind(this))
				.style('opacity', 0.5)
				.style('color','orange');

			d3.select('#view_dist')
				.on('click', this.dFun.bind(this))
				.style('color','green'); 

			d3.select('#view_time')
				.on('click', this.tFun.bind(this))
				.style('color','steelblue');

			d3.select('#zone-break')
				.on('click', null)
				.style('opacity', 0.5);
		},
		fillBars: function (key, time) {
			this.mode = key;

			this.render();

			var cmd;
			if (time === 'weeks') {
				cmd = 1;
			} else {
				cmd = 0;
			}

			var data = [];
			var mColor = '';
			var msg2 = '';
			if (this.mode === 0) {
				data = this.getTimeType('average_leg_spring', time);
				mColor = 'orange';
				msg2 = 'Stress';
				this.max = d3.max(data) + 10;
			} else if (this.mode === 1) {
				data = this.getTimeType('distance', time);
				mColor = 'green';
				msg2 = 'Distance (km)';
				this.max = d3.max(data) + 1;
			} else if (this.mode === 2) {
				data = this.getTimeType('elapsed_time', time);
				mColor = 'steelblue';
				msg2 = 'Time (hr)';
				this.max = d3.max(data) + 0.25;
			}

			this.x.domain(d3.range(data.length));

			if (cmd) {
				this.xAxis.tickFormat(this.getWeekName.bind(this));
			} else {
				this.xAxis.tickFormat(this.getDayName.bind(this));
				d3.select('#weekly-stress')
					.style('opacity', 1);
			}

			d3.selectAll('.d3-tip')
				.remove();
			
			var tip = d3.tip()
				.attr('class', 'd3-tip')
				.offset([-10, 0])
				.html((d) => {
					var msg = '';
					if (this.mode === 0) {
						msg = `<strong>Stress:</strong> <span style='color:red'>${d}</span><br>`;
					} else if (this.mode === 1) {
						msg = `<strong>Distance (km):</strong> <span style='color:red'>${d}</span><br>`;
					} else if (this.mode === 2) {
						msg = `<strong>Time (hr):</strong> <span style='color:red'>${d}</span><br>`;
					}
					if (!cmd) {
						var id = '1';
						return `${msg}<a href="https://www.stryd.com/powercenter/run/${id}" target="_blank"><span style="color:rgb(236,176,31)">Click for run</span>`;
					} else {
						return msg;
					}
				});

			var vis = d3.select('#barchart');
			if (this.gZones) {
				this.gZones = 0;
			}
			vis.call(tip);

			d3.selectAll('.axis').remove();

			vis.append('g')
				.attr('class', 'x axis')
				.attr('transform', `translate(0, ${this.height})`)
				.call(this.xAxis)
				.attr('stroke-width', 1)
				.attr('stroke', '#2d2d2d')
				.attr('fill', '#2d2d2d')
				.attr('opacity', 1)
				.selectAll('text')
				.attr('opacity', 1)
				.attr('fill', '#727272')
				.attr('stroke-width',0)
				.attr('transform', 'rotate(0)')
				.style('text-anchor', 'middle');

			vis.append('g')
				.attr('class', 'y axis')
				.call(this.yAxis)
				.attr('stroke-width', 0)
				.attr('stroke', '#2d2d2d')
				.attr('fill', '#2d2d2d')
				.attr('opacity', 1)
				.attr('stroke-width',1)
				.append('text')
				.attr('y', -10)
				.text(msg2)
				.attr('stroke-width', 0)
				.attr('fill', '#727272');

			var bars = vis.selectAll('.bar')
				.data(data);

			//update
			bars.attr('fill', mColor)
				.attr('stroke', '#050');

			bars.enter()
				.append('svg:rect')
				.attr('class', 'bar')
				.attr('fill', mColor)
				.attr('opacity', 0.8);

			bars.exit()
				.attr('fill', mColor)
				.transition()
				.duration(300)
				.ease('square')
				.attr('transform', () => {
					return 'translate(100, 0)';
				})
				.remove();

			bars.transition()
				.duration(300)
				.ease('square')
				.attr('width', this.x.rangeBand())
				.attr('height', (d) => {
					return this.height - this.y(d);
				})
				/* unused: d */
				.attr('x', (d, i) => {
					return 2 * (this.x(i) - this.x(3));
				})
				.attr('y', (d) => {
					return this.y(d);
				})
				/* unused: d */
				.attr('transform', (d, i) => {
					var first = -this.x(i)+2*this.x(3);
					return `translate(${first}, 0)`;
				});

			if (cmd) {
				console.log('CMD = 1');
				bars.on('click', (d, i) => {
					console.log(d, i);
					this.gCmd = 1;
					this.gInd = i;
					this.fillBars(this.gMode, 'days');
				})
				.on('mouseover', tip.show)
				.on('mouseout', tip.hide);
			} else {
				this.gCmd = 1;
				console.log('CMD = 0');
				bars.on('click', () => {
					console.log('clicked');
				}).on('mouseover', tip.show);
			}
		},
		sFun: function () {
			if (this.gCmd) {
				this.fillBars(0, 'days');
			} else {
				d3.select('#zone-break')
					.style('opacity', 1);
				this.fillBars(0, 'weeks');
			}
			d3.select('#view_stress')
				.style('opacity', 0.5)
				.on('click', null);
			d3.select('#view_dist')
				.style('opacity', 1)
				.on('click', this.dFun.bind(this));
			d3.select('#view_time')
				.style('opacity', 1)
				.on('click', this.tFun.bind(this));
			d3.select('#zone-break')
				.style('opacity', 0.5)
				.on('click', null);
		},
		tFun: function () {
			if (this.gCmd) {
				this.fillBars(2, 'days');
			} else {
				this.fillBars(2, 'weeks');
			}
			d3.select('#view_stress')
				.style('opacity', 1)
				.on('click', this.sFun.bind(this));
			d3.select('#view_dist')
				.style('opacity', 1)
				.on('click', this.dFun.bind(this));
			d3.select('#view_time')
				.style('opacity', 0.5)
				.on('click', null);
			d3.select('#zone-break')
				.style('opacity', 1)
				.on('click', this.zFun.bind(this));
		},
		dFun: function () {
			if (this.gCmd) {
				this.fillBars(1, 'days');
			} else {
				d3.select('#zone-break')
					.style('opacity', 1);
				this.fillBars(1, 'weeks');
			}
			d3.select('#view_stress')
				.style('opacity', 1)
				.on('click', this.sFun.bind(this));
			d3.select('#view_dist')
				.style('opacity', 0.5)
				.on('click', null);
			d3.select('#view_time')
				.style('opacity', 1)
				.on('click', this.tFun.bind(this));
			d3.select('#zone-break')
				.style('opacity', 0.5)
				.on('click', null);
		},
		zFun: function () {
			this.toggledOn = !this.toggledOn;
			if (!this.toggledOn) {
				var vis = d3.select('#barchart');
				vis.selectAll('.bar').attr('opacity',1);
				vis.selectAll('.stack').remove();

				d3.select('#view_stress')
					.style('opacity', 1)
					.on('click', this.sFun.bind(this));
				d3.select('#view_dist')
					.style('opacity', 1)
					.on('click', this.dFun.bind(this));
				d3.select('#view_time')
					.style('opacity', 0.5)
					.on('click', null);
				d3.select('#zone-break')
					.style('opacity', 1)
					.on('click', this.zFun.bind(this));
			} else {
				if (!this.gCmd) {
					// this.zillBars(
					// 	weekly_total_time_in_zones,
					// 	2
					// );
					console.log('zillBars');
					this.zBars = 0;
				} else {
					this.fillBars(2, 'days');
					// this.zillBars(
					// 	daily_total_time_in_zones[this.gInd],
					// 	1
					// );
					console.log('zillBars');
					this.zBars = 1;
				}

				d3.select('#view_stress')
					.style('opacity', 0.5)
					.on('click', null);
				d3.select('#view_dist')
					.style('opacity', 0.5)
					.on('click', null);
				d3.select('#view_time')
					.style('opacity', 0.5)
					.on('click', null);

				d3.select('#zone-break')
					.style('opacity', 1)
					.on('click', this.zFun.bind(this));
			}
		},
		grabData: function () {
			var srtDate = '09-01-2016';
			var endDate = '12-30-2016';
			var activityEndPoint = `/b/api/v1/activities/calendar?srtDate=${srtDate}&endDate=${endDate}&sortBy=StartDate`;

			superagent
				.get(activityEndPoint)
				.send()
				.set('Accept', 'application/json')
				.set('Authorization', `Bearer: ${jwt.token}`)
				.end((err, res) => {
					if (res.ok) {
						this.processData(res.body.activities);
					} else {
						console.log('Error: failure on grabData', err, res);
					}
				});
		},
		processData: function (activities) {
			this.days = {};
			for (var activity of activities) {
				var hash = moment(activity.timestamp * 1000).format('YYYYMMDD');
				this.days[hash] = activity;
			}
			this.fillInit();
		},
		getTimeType: function (dataType, timeType) {
			if (timeType === 'days') {
				return this.getDayType(dataType);
			} else if (timeType === 'weeks') {
				return this.getWeekType(dataType);
			}
		},
		getDayType: function (dataType) {
			this.timeRange = 10;
			var movingDay = moment().subtract(10, 'weeks');
			var result = [];
			for (var i = 0; i < this.timeRange; i++) {
				var subResult = [];
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (hash in this.days) {
						subResult.push(this.getData(hash, dataType));
					} else {
						subResult.push(0);
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			return result;
		},
		getWeekType: function (dataType) {
			this.timeRange = 10;
			var movingDay = moment().subtract(10, 'weeks');
			var result = [];
			for (var i = 0; i < this.timeRange; i++) {
				var subResult = 0;
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (hash in this.days) {
						subResult += this.getData(hash, dataType);
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			return result;
		},
		getData: function (hash, dataType) {
			var value = this.days[hash][dataType];
			if (dataType === 'average_leg_spring') {
				return value;
			} else if (dataType === 'distance') {
				return value / 1000; //km
			} else if (dataType === 'elapsed_time') {
				return value / 3600;
			}
		},
		zillBars: function (data, cmd) {
			this.gZones = 1;

			var xData = ['A', 'B', 'C', 'D', 'E'];
			
			var x = d3.scale.ordinal()
				.domain(d3.range(data.length))
				.range([0, this.width])
				.rangeBands([0, this.width], 0.28);

			var y = d3.scale.linear()
				.domain([0, this.gMax])
				.range([this.height, 0]);

			var color = d3.scale.category20c();

			// var xAxis = d3.svg.axis()
			// 	.scale(x)
			// 	.tickSize(0)
			// 	.orient('bottom')
			// 	.innerTickSize(0)
			// 	.outerTickSize(0);

			var vis = d3.select('#barchart');
			vis.selectAll('.bar').attr('opacity',0);

			var dataIntermediate = xData.map((c) => {
				return data.map((d) => {
					return {
						x: d.week,
						y: d[c]
					};
				});
			});

			var dataStackLayout = d3.layout.stack()(dataIntermediate);

			x.domain(dataStackLayout[0].map((d) => {
				return d.x;
			}));

			// Prep the tooltip bits, initial display is hidden
			var tooltip = vis.append('g')
				.attr('class', 'tooltip')
				.style('display', 'none');

			tooltip.append('rect')
				.attr('width', 60)
				.attr('height', 40)
				.attr('fill', 'white')
				.style('opacity', 0.5);

			tooltip.append('text')
				.attr('x', 30)
				.attr('y', 10)
				.attr('dy', '1.2em')
				.style('text-anchor', 'middle')
				.attr('font-size', '16px')
				.attr('font-weight', 'bold');

			var layer = vis.selectAll('.stack')
				.data(dataStackLayout)
				.enter().append('g')
				.attr('class', 'stack')
				.attr('opacity', 0.5)
				/* unused: d */
				.style('fill', function (d, i) {
					return color(i);
				});

			var bars = layer.selectAll('rect')
				.data((d) => {
					return d;
				});

			bars.enter()
				.append('rect')
				.attr('x', (d) => {
					return x(d.x);
				})
				.attr('y', (d) => {
					return y(d.y + d.y0);
				})
				.attr('height', (d) => {
					return y(d.y0) - y(d.y + d.y0);
				})
				.attr('width', x.rangeBand())
				.on('mouseover', () => {
					tooltip.style('display', null);
				})
				.on('mouseout', () => {
					tooltip.style('display', 'none');
				})
				.on('mousemove', (d) => {
					var xPosition = d3.mouse(this)[0] - 30;
					var yPosition = d3.mouse(this)[1] + 15;
					tooltip.attr(
						'transform',
						`translate(${xPosition}, ${yPosition})`
					);
					tooltip.select('text').text(
						Math.round(d.y*100)/100 + ' hr'
					);
					tooltip.style('text-anchor', 'middle');
				})
				.on('click', (d, i) => {
					if (!cmd) {
						this.gInd = i;
						console.log(d, i);
					}
				});

			bars.transition()
				.duration(300)
				.attr('transform', () => {
					return 'translate(0, 0)';
				});

		},
	});
	</script>
</dom-module