<dom-module id="performance-management">
	<style>
		:host {
			@apply(--layout-vertical);
			@apply(--layout-center);
			font-family: "Stryd", sans-serif;
			background-color: var(--dark-background-color);
			padding: 20px;
			--paper-slider-knob-color: #F7A017;
			min-width: 860px;
			overflow-x: auto;
		}
		:host.blurred {
			-webkit-filter: blur(2px);
			-moz-filter: blur(2px);
			-ms-filter: blur(2px);
			-o-filter: blur(2px);
			filter: blur(2px);
		}
		#management {
			position: relative;
		}
		h1.header {
			@apply(--header);
			text-align: center;
			padding: 15px 0;
		}
		.title {
			padding: 20px;
			@apply(--layout-end);
		}
		.bar:hover {
			opacity: 0.66;
		}
		.grid .tick {
			stroke: lightgrey;
			opacity: 0.7;
		}
		.grid path {
			stroke-width: 0;
		}
		.d3-tip {
			line-height: 1;
			font-weight: bold;
			padding: 12px;
			background: rgba(120, 120, 120, 0.8);
			color: #fff;
			border-radius: 2px;
		}
		.d3-tip:after {
			box-sizing: border-box;
			display: inline;
			font-size: 10px;
			width: 100%;
			line-height: 1;
			color: rgba(120, 120, 120, 0.8);
			content: '\25BC';
			position: absolute;
			text-align: center;
		}
		.d3-tip.n:after {
			margin: -1px 0 0 0;
			top: 100%;
			left: 0;
		}
		#svg {
			width: 60vh;
			margin: 0 auto;
		}
		#stress {
			width: 960px;
		}

		[data-stat] {
			@apply(--layout-center);
			@apply(--layout-justified);
			@apply(--layout-horizontal);
			background-color: var(--primary-background-color);
			border: 2px solid #FFFFFF;
			border-radius: 6px;
			color: #FFFFFF;
			cursor: pointer;
			font-size: 1vw;
			font-weight: 500;
			margin: 0.5vw 1vw 0 0;
			padding: 0.8vw 1.1vw;
			position: relative;
			text-transform: uppercase;
			z-index: 5;
		}
		[data-stat] .circle {
			width: 1.3vw;
			height: 1.3vw;
			border-radius: 50%;
			border: 3px #FFFFFF solid;
			z-index: 2;
		}
		[data-stat] .type {
			padding-left: 10px;
		}
		[data-toggle="on"][data-stat="stress"] .circle {
			background-color: #F7A017;
			border-color: #F7A017;
			-webkit-box-shadow: 0px 0px 20px 0px #F7A017;
			-moz-box-shadow: 0px 0px 20px 0px #F7A017;
			box-shadow: 0px 0px 20px 0px #F7A017;
		}
		[data-toggle="on"][data-stat="distance"] .circle {
			background-color: #FFFFFF;
			border-color: #FFFFFF;
			box-shadow: 0px 0px 20px 0px #FFFFFF;
		}
		[data-toggle="on"][data-stat="zones"] .circle {
			background-color: #fce9d2;
			border-color: #fce9d2;
			-webkit-box-shadow: 0px 0px 20px 0px #5ea7a1;
			-moz-box-shadow: 0px 0px 20px 0px #5ea7a1;
			box-shadow: 0px 0px 20px 0px #5ea7a1;
		}
	</style>
	<template>
		<h1 class="header">Manage Training Load</h1>
		<div class="layout vertical holder active" data-holder="stress">
			<svg id="stress"></svg>
			<div class="layout horizontal title">
				<div class="layout horizontal flex">
					<h1>Last <span>{{timeRange}}</span> weeks</h1>
					<paper-slider id="dateSelection" pin="" max="24" step="1" value="10"></paper-slider>
				</div>
				<div class="flex layout horizontal end-justified">
					<div data-stat="stress" data-toggle="on">
						<div class="circle"></div>
						<div class="type">Stress</div>
					</div>
					<div data-stat="distance" data-toggle="off" >
						<div class="circle"></div>
						<div class="type">Distance</div>
					</div>
					<div data-stat="zones" data-toggle="off">
						<div class="circle"></div>
						<div class="type">Time in Zones</div>
					</div>
				</div>
			</div>
		</div>
		<!-- <div class="layout vertical holder" data-holder="management">
			<div class="layout horizontal title">
				<div class="flex">
					<h1 class="header">Performance Management</h1>
				</div>
			</div>
			<div id="management"></div>
		</div> -->
	</template>
	<script>
	Polymer({
		is: 'performance-management',
		ready: function () {
			this.width = 860;
			this.height = 400;

			this.zBars = 0;
			this.gMode = 0;
			this.gCmd = false;
			this.max = 0;

			this.weekDays = ['Mon', 'Tues', 'Wed', 'Thur', 'Fri', 'Sat', 'Sun'];
			this.weekIDS = [];
			this.weekNames = [];
			this.ids = [];

			this.state = 'stress';

			this.timeRange = 10;

			this.$.dateSelection.addEventListener('change', (e) => {
				this.timeRange = e.target.value;
				if (this.state === 'tiz') {
					this.zillBars('weeks');
				} else {
					this.fillBars('weeks');
				}
			});
		},
		getDayName: function (idx) {
			return this.weekDays[idx % 7];
		},
		getWeekName: function (idx) {
			return this.weekNames[idx];
		},
		getID: function (idx) {
			return this.weekIDS[idx];
		},
		attached: function () {
			this.grabData();
		},
		grabData: function () {
			this.processData(calendarManager.getPMActivities());
			window.addEventListener('gotActivities', () => {
				this.processData(calendarManager.getPMActivities());
			});
			//this.processOverlayData();
		},
		processData: function (activities) {
			this.days = {};
			this.doStress = false;
			for (var activity of activities) {
				var hash = moment(activity.timestamp * 1000).format('YYYYMMDD');
				if (!this.doStress && activity.stress > 0) {
					this.doStress = true;
				}
				this.days[hash] = activity;
			}
			this.fillInit();
		},
		resize: function () {
			//this.updateScales();
			var width = window.innerWidth - 40;
			this.x.rangeBands([0, width], 0.04);
			//this.updateAxes();
			d3.select('.x.axis').call(this.xAxis);
			//this.updateBars();
			var u = d3.selectAll('rect')
				.data(this.data);
			u.enter().append('rect');
			u.exit().remove();
			/* unused: d */
			u.attr('x', (d, i) => {
				return this.xScale(i);
			})
			.attr('width', this.xScale.rangeBand())
			.attr('y', (d) => {
				return this.yScale(d);
			})
			.attr('height', (d) => {
				return this.yScale(0) - this.yScale(d);
			});
		},
		fillInit: function () {
			this.graph = d3.select('#stress')
				.attr('width', this.width + 100)
				.attr('height', this.height + 100);

			this.graph.append('svg:g')
				.attr('id', 'barchart')
				.attr('transform', 'translate(50, 50)');

			d3.selectAll('[data-stat]')
				.on('click', this.callFun.bind(this));

			// if (!this.doStress) {
			// 	this.state = 'distance';
			// 	this.querySelector('[data-toggle="on"]').dataset.toggle = 'off';
			// 	this.querySelector('[data-stat="distance"]').dataset.toggle = 'on';
			// }
			// d3.select(window).on('resize', this.resize.bind(this));

			this.fillBars('weeks');
		},
		fillBars: function (time, idx) {
			d3.select('#barchart')
				.selectAll('*')
				.remove();

			this.data = [];
			var mColor = '';
			var msg2 = '';
			if (this.state === 'stress') {
				this.data = this.getTimeType('stress', time, idx);
				mColor = '#f7a017';
				msg2 = 'Running Stress Score';
				this.max = d3.max(this.data) + 10;
			} else if (this.state === 'distance') {
				this.data = this.getTimeType('distance', time, idx);
				mColor = '#FFFFFF';
				msg2 = 'Distance (km)';
				this.max = d3.max(this.data) + 1;
			}

			this.x = d3.scale.ordinal()
				.domain(d3.range(this.data.length))
				.range([0, this.width])
				.rangeBands([0, this.width], 0.3);

			this.y = d3.scale.linear()
				.domain([0, this.max])
				.range([this.height, 0]);

			this.xAxis = d3.svg.axis()
				.scale(this.x)
				.tickSize(1)
				.tickPadding(10)
				.orient('bottom')
				.innerTickSize(-this.height)
				.outerTickSize(0);

			if (time === 'weeks') {
				this.xAxis.tickFormat(this.getWeekName.bind(this));
			} else {
				this.xAxis.tickFormat(this.getDayName.bind(this));
			}

			this.yAxis = d3.svg.axis()
				.scale(this.y)
				.tickSize(1)
				.tickPadding(10)
				.tickFormat(d3.format('.0f'))
				.orient('left')
				.innerTickSize(-this.width)
				.outerTickSize(0);

			d3.selectAll('.d3-tip')
				.remove();
			
			var tip = d3.tip()
				.attr('class', 'd3-tip')
				.offset([-10, 0])
				.html((d) => {
					d = parseInt(d);
					var msg = '';
					if (this.state === 'stress') {
						msg = `<div class="float-tag">Stress</div><div class="float-value">${d} RSS</div>`;
					} else if (this.state === 'distance') {
						msg = `<div class="float-tag">Distance</div><div class="float-value">${d} KM</div>`;
					}
					if (time === 'weeks') {
						return `${msg}<div class="float-action">TAP FOR WEEK</div>`;
					} else {
						return `${msg}<div class="float-action">TAP FOR RUN</div>`;
					}
				});

			var vis = d3.select('#barchart');
			vis.call(tip);

			d3.selectAll('.axis').remove();

			var xAxisText = vis.insert('g', ':first-child')
				.attr('class', 'x axis')
				.attr('transform', `translate(0, ${this.height})`)
				.call(this.xAxis)
				.attr('opacity', 1)
				.attr('fill', '#2d2d2d')
				.attr('stroke', '#2d2d2d')
				.attr('stroke-width', 0)
				.selectAll('text')
					.attr('opacity', 1)
					.attr('fill', '#FFFFFF')
					.attr('stroke-width',0)
					.attr('transform', 'rotate(0)')
					.style('text-anchor', 'middle');

			if (this.timeRange > 10) {
				xAxisText.style('transform', 'translate(-20px, 15px) rotate(-45deg)');
			}

			vis.insert('g', ':first-child')
				.attr('class', 'y axis')
				.call(this.yAxis)
				.attr('stroke-width', 1)
				.attr('stroke', '#2d2d2d')
				.attr('fill', '#2d2d2d')
				.attr('opacity', 1)
				.append('text')
					.attr('y', -10)
					.text(msg2)
					.attr('stroke-width', 1)
					.attr('color', '#FFFFFF')
					.attr('stroke', '#FFFFFF')
					.attr('fill', '#FFFFFF');

			vis.select('.y.axis').selectAll('text')
				.attr('stroke', '#FFFFFF')
				.attr('fill', '#FFFFFF')
				.attr('color', '#FFFFFF');

			var bars = vis.selectAll('.bar')
				.data(this.data);

			//update
			bars.attr('fill', mColor)
				.attr('stroke', '#050');

			bars.enter()
				.append('svg:rect')
				.attr('class', 'bar')
				.attr('fill', mColor)
				.attr('opacity', 0.8);

			bars.exit()
				.attr('fill', mColor)
				.transition()
				.duration(300)
				.ease('square')
				.attr('transform', () => {
					return 'translate(100, 0)';
				})
				.remove();

			bars.transition()
				.duration(300)
				.ease('square')
				.attr('width', this.x.rangeBand())
				.attr('height', (d) => {
					return this.height - this.y(d);
				})
				/* unused: d */
				.attr('x', (d, i) => {
					return 2*(this.x(i) - this.x(3));
				})
				.attr('y', (d) => {
					return this.y(d);
				})
				/* unused:  d */
				.attr('transform', (d, i) => {
					var first = -this.x(i)+2*this.x(3);
					return `translate(${first}, 0)`;
				});

			if (time === 'weeks') {
				/* unused: d */
				bars.on('click', (d, i) => {
					this.gCmd = true;
					this.fillBars('days', i);
				})
				.on('mouseover', tip.show)
				.on('mouseout', tip.hide);
			} else {
				/* unused: d */
				bars.on('click', (d, i) => {
					page.redirect(`/powercenter/run/${this.ids[i]}`);
				})
				.on('mouseover', tip.show)
				.on('mouseout', tip.hide);
			}
		},
		zillBars: function (time, idx) {
			d3.select('#barchart')
				.selectAll('*')
				.remove();

			if (time === 'days') {
				this.data = this.getZoneDayType(idx);
			} else {
				this.data = this.getZoneWeekType();
			}

			var msg2 = 'Time (hr)';

			this.max = 0;
			for (var i = 0; i < this.data.length; i++) {
				var row = this.data[i];
				var result = 0;
				for (var o = 0; o < row.length; o++) {
					result += row[o];
				}
				if (result > this.max) {
					this.max = result;
				}
			}

			var xData = [0, 1, 2, 3, 4];
			
			this.x = d3.scale.ordinal()
				.domain(d3.range(this.data.length))
				.range([0, this.width])
				.rangeBands([0, this.width], 0.3);

			this.y = d3.scale.linear()
				.domain([0, this.max])
				.range([this.height, 0]);

			var mColors = ['#fce9d2', '#fad3a5', '#f8be78', '#f6a84b', '#f4931f'];

			this.xAxis = d3.svg.axis()
				.scale(this.x)
				.tickSize(0)
				.orient('bottom')
				.innerTickSize(0)
				.outerTickSize(0);

			if (time === 'weeks') {
				this.xAxis.tickFormat(this.getWeekName.bind(this));
			} else {
				this.xAxis.tickFormat(this.getDayName.bind(this));
			}

			this.yAxis = d3.svg.axis()
				.scale(this.y)
				.tickSize(1)
				.ticks(this.max+1)
				.tickPadding(10)
				.tickFormat(d3.format('.0f'))
				.orient('left')
				.innerTickSize(-this.width)
				.outerTickSize(0);

			d3.selectAll('.d3-tip')
				.remove();

			var tooltip = d3.tip()
				.attr('class', 'd3-tip')
				.offset([-10, 0])
				/* unused: i */
				.html((d, i, a) => {
					var time;
					if (d.y < 1) {
						time = parseInt(d.y * 60) + ' minutes';
					} else {
						time = parseInt(d.y) + ' hours';
					}
					var zone = a+1;
					var msg = `<div class="float-tag">Zone ${zone} </div><div class="float-value">for ${time}</div>`;
					if (time === 'days') {
						var id = this.getID(d.x);
						return `${msg}<br><a href="/powercenter/run/${id}"><span style="color:rgb(236,176,31)">Click for run</span>`;
					} else {
						return msg;
					}
				});

			var vis = d3.select('#barchart');

			vis.call(tooltip);

			d3.selectAll('.axis').remove();

			var xAxisText = vis.insert('g', ':first-child')
				.attr('class', 'x axis')
				.attr('transform', `translate(0, ${this.height})`)
				.call(this.xAxis)
				.attr('opacity', 1)
				.attr('fill', '#2d2d2d')
				.attr('stroke', '#2d2d2d')
				.attr('stroke-width', 0)
				.selectAll('text')
					.attr('opacity', 1)
					.attr('fill', '#FFFFFF')
					.attr('stroke-width',0)
					.attr('transform', 'rotate(0)')
					.style('text-anchor', 'middle');

			if (this.timeRange > 10) {
				xAxisText.style('transform', 'translate(-20px, 15px) rotate(-45deg)');
			}

			vis.insert('g', ':first-child')
				.attr('class', 'y axis')
				.call(this.yAxis)
				.attr('stroke-width', 1)
				.attr('stroke', '#2d2d2d')
				.attr('fill', '#2d2d2d')
				.attr('opacity', 1)
				.append('text')
					.attr('y', -10)
					.text(msg2)
					.attr('stroke-width', 1)
					.attr('stroke', '#FFFFFF')
					.attr('fill', '#FFFFFF');

			vis.select('.y.axis').selectAll('text')
				.attr('stroke', '#FFFFFF')
				.attr('fill', '#FFFFFF');

			var dataIntermediate = xData.map((c) => {
				/* unused: d */
				return this.data.map((d, i) => {
					return {
						x: i,
						y: d[c]
					};
				});
			});

			var dataStackLayout = d3.layout.stack()(dataIntermediate);

			this.x.domain(dataStackLayout[0].map((d) => {
				return d.x;
			}));

			var layer = vis.selectAll('.stack')
				.data(dataStackLayout)
				.enter().append('g')
				.attr('class', 'stack')
				/* unused: d */
				.style('fill', function (d, i) {
					return mColors[i];
				});

			var bars = layer.selectAll('rect')
				.data((d) => {
					return d;
				});

			bars.enter()
				.append('rect')
				.attr('x', (d) => {
					return this.x(d.x);
				})
				.attr('y', (d) => {
					return this.y(d.y + d.y0);
				})
				.attr('height', (d) => {
					return this.y(d.y0) - this.y(d.y + d.y0);
				})
				.attr('width', this.x.rangeBand())
				.on('mouseover', tooltip.show)
				.on('mouseout', tooltip.hide);

			if (time === 'weeks') {
				/* unused: d */
				bars.on('click', (d, i) => {
					this.zillBars('days', i);
				});
			} else {
				/* unused: d */
				bars.on('click', (d, i) => {
					page.redirect(`/powercenter/run/${this.ids[i]}`);
				});
			}

			bars.transition()
				.duration(300)
				.attr('transform', 'translate(0, 0)');
		},
		/* unused: a */
		callFun: function (a, e) {
			var vis = d3.select('#barchart');
			vis.selectAll('.stack').remove();
			this.querySelector('[data-toggle="on"]').dataset.toggle = 'off';

			if (e === 3) {
				this.state = 'distance';
				this.fillBars('weeks');
				this.querySelector('[data-stat="distance"]').dataset.toggle = 'on';
			} else if (e === 2) {
				this.state = 'stress';
				this.fillBars('weeks');
				this.querySelector('[data-stat="stress"]').dataset.toggle = 'on';
			} else if (e === 4) {
				this.state = 'tiz';
				this.zillBars('weeks');
				this.zBars = 0;
				this.querySelector('[data-stat="zones"]').dataset.toggle = 'on';
			}
		},
		getTimeType: function (dataType, timeType, idx) {
			if (timeType === 'days') {
				return this.getDayType(dataType, idx);
			} else if (timeType === 'weeks') {
				return this.getWeekType(dataType);
			}
		},
		wayBack: function (weeks) {
			var wayBack = moment().subtract(weeks, 'weeks');
			return wayBack.subtract(
				parseInt(wayBack.format('d'))-1,
				'days'
			);
		},
		getDaysRange: function (weeks) {
			var movingDay = this.wayBack(weeks);

			var result = [];
			for (var i = 0; i < weeks; i++) {
				var subResult = 0;
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (hash in this.days) {
						subResult = this.getData(hash, null);
						subResult.empty = false;
					} else {
						subResult = {
							stress: 0,
							empty: true,
							timestamp: movingDay.toDate().getTime()/1000
						};
					}
					movingDay.add(1, 'day');
					result.push(subResult);
				}
			}
			return result;
		},
		getDayType: function (dataType, idx) {
			var movingDay = this.wayBack(this.timeRange);
			var result = [];
			this.ids = [];
			for (var i = 0; i <= this.timeRange; i++) {
				var subResult = [];
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (hash in this.days) {
						subResult.push(this.getData(hash, dataType));
						if (idx === i) {
							this.ids.push(this.getData(hash, 'id'));
						}
					} else {
						subResult.push(0);
						if (idx === i) {
							this.ids.push(0);
						}
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			return result[idx];
		},
		getWeekType: function (dataType) {
			var movingDay = this.wayBack(this.timeRange);
			var result = [];
			this.weekNames = [];
			for (var i = 0; i <= this.timeRange; i++) {
				var subResult = 0;
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (o === 0) {
						this.weekNames.push(movingDay.format('MMM Do'));
					}
					if (hash in this.days) {
						subResult += this.getData(hash, dataType);
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			return result;
		},
		getZoneDayType: function (idx) {
			var movingDay = this.wayBack(this.timeRange);
			var result = [];
			for (var i = 0; i <= this.timeRange; i++) {
				var subResult = [];
				this.ids = [];
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (hash in this.days) {
						var dup = [0, 0, 0, 0, 0];
						var tiz = this.getData(hash, 'zones');
						for (var p = 0; p < 5; p++) {
							dup[p] = tiz[p]/3600;
						}
						subResult.push(dup);
						if (idx === i) {
							this.ids.push(this.getData(hash, 'id'));
						}
					} else {
						subResult.push([0, 0, 0, 0, 0]);
						if (idx === i) {
							this.ids.push(0);
						}
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			return result[idx];
		},
		getZoneWeekType: function () {
			var movingDay = this.wayBack(this.timeRange);
			var result = [];
			for (var i = 0; i <= this.timeRange; i++) {
				var subResult = [0, 0, 0, 0, 0];
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (o === 0) {
						this.weekNames.push(movingDay.format('MMM Do'));
					}
					if (hash in this.days) {
						var tiz = this.getData(hash, 'zones');
						for (var p = 0; p < 5; p++) {
							subResult[p] = subResult[p] + tiz[p]/3600;
						}
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			return result;
		},
		getData: function (hash, dataType) {
			if (dataType === 'zones') {
				dataType = 'seconds_in_zones';
			}
			if (dataType === null) {
				return this.days[hash];
			}
			var value = this.days[hash][dataType];
			if (dataType === 'stress') {
				if (value === null) {
					return 0;
				}
				return value;
			} else if (dataType === 'distance') {
				return value / 1000; //km
			} else if (dataType === 'elapsed_time') {
				return value / 3600;
			} else if (dataType === 'seconds_in_zones') {
				if (value === null) {
					return [0, 0, 0, 0, 0];
				}
				return value;
			} else if (dataType === 'id') {
				return value;
			}
		},
		processOverlayData2: function () {
			this.overlayData2 = [];
			var atl = 0;
			var ctl = 0;
			var activities = this.getDaysRange(this.timeRange);
			var dayNum = 1;
			for (var activity of activities) {
				var runData = {};
				atl = atl + ((activity.stress - atl)/7);
				ctl = ctl + ((activity.stress - ctl)/42);
				runData.atl = atl;
				runData.ctl = ctl;
				runData.day = dayNum;
				runData.time = moment(activity.timestamp*1000).toDate();
				runData.id = activity.id;
				if (atl !== 0) {
					this.overlayData2.push(runData);
				}
				dayNum += 1;
			}
		},
		processOverlayData: function () {
			this.processOverlayData2();
			this.overlayData = [];

			var activities = this.getDaysRange(this.timeRange);

			var wayBack = moment().subtract(this.timeRange, 'weeks');
			var startDate = wayBack.subtract(
				parseInt(wayBack.format('d')),
				'days'
			);

			var runNum = 1;
			for (var activity of activities) {
				if (activity.empty) {
					continue;
				}
				var stress = activity.stress;
				var dayNum = -startDate.diff(
					moment(activity.timestamp*1000),
					'days'
				);
				var timeNum = moment(activity.timestamp*1000);
				var countNum = 1;
				while (stress > 1) {
					var runData = {};
					runData.run = runNum;
					runData.day = dayNum;
					runData.id = activity.id;
					runData.time = moment(timeNum).toDate();
					if (stress < 0) {
						stress = 0;
					}
					if (countNum === 1) {
						runData.run_stress = 0;
					} else {
						runData.run_stress = stress;
						stress = Math.pow(stress, (42-countNum)/42);
					}
					if (dayNum < 80) {
						this.overlayData.push(runData);
					}
					countNum += 1;
					dayNum += 1;
					timeNum = timeNum.add(1, 'days');
				}
				runNum += 1;
			}
			this.fillOverlay();
		},
		fillOverlay: function () {
			this.bisectDate = d3.bisector((d) => {
				return d.time;
			}).left;

			this.overlayTip = d3.select('#management')
				.append('div')
				.attr('class', 'tooltip')
				.style('opacity', 0);

			this.xTimer = d3.time.scale()
				.range([0, this.width])
				.domain(
					d3.extent(this.overlayData, (d) => {
						return d.time;
					})
				);

			this.yLinear = d3.scale.linear()
				.range([this.height, 0])
				.domain([
					0,
					d3.max(this.overlayData, (d) => {
						return Math.max(d.run_stress);
					})
				]);

			this.y1Linear = d3.scale.linear()
				.range([this.height, 0])
				.domain([
					0,
					d3.max(this.overlayData2, (d) => {
						return Math.max(d.ctl);
					})
				]);

			this.runStressLine = d3.svg.line()
				.x((d) => {
					return this.xTimer(d.time);
				})
				.y((d) => {
					return this.yLinear(d.run_stress);
				});

			this.totalStressLine = d3.svg.line()
				.x((d) => {
					return this.xTimer(d.time);
				})
				.y((d) => {
					return this.y1Linear(d.ctl);
				});

			this.overlaySVG = d3.select('#management')
				.append('svg')
					.attr('width', this.width + 100)
					.attr('height', this.height + 100)
					.append('g')
						.attr('transform', 'translate(50, 50)');

			this.overlayFocus = this.overlaySVG
				.append('g')
				.style('display', 'none');

			this.dataNest = d3.nest()
				.key((d) => {
					return d.run;
				})
				.entries(this.overlayData);

			this.overlaySVG.append('path')
				.data([this.overlayData2])
				.style('stroke', 'red')
				.style('fill', 'none')
				.attr('d', this.totalStressLine);

			this.dataNest.forEach((d) => {
				this.overlaySVG.append('path')
					.style('fill', '#CC8719')
					.style('stroke', 'black')
					.style('opacity', 0.2)
					.attr('id', `tag${d.key}`)
					.attr('d', this.runStressLine(d.values));
			});

			// x grid lines
			this.overlaySVG.append('g')
				.attr('fill', 'none')
				.attr('transform', `translate(0, ${this.height})`)
				.call(
					d3.svg.axis()
						.orient('bottom')
						.ticks(4)
						.tickSize(-this.height)
						.tickFormat('')
				)
				.attr('stroke-width', 0);

			// y grid lines
			this.overlaySVG.append('g')
				.attr('class', 'grid')
				.call(
					d3.svg.axis()
						.orient('left')
						.ticks(4)
						.tickSize(-this.width)
						.tickFormat('')
				);

			this.overlayXAxis = d3.svg.axis()
				.scale(this.xTimer)
				.orient('bottom')
				.tickSize(1)
				.tickPadding(10)
				.innerTickSize(-this.width);

			// x axis
			this.overlaySVG.append('g')
				.attr('transform', `translate(0, ${this.height})`)
				.call(this.overlayXAxis)
				.attr('opacity', 1)
				.attr('stroke-width', 1)
				.selectAll('text')
					.attr('opacity', 1)
					.attr('fill', '#FFFFFF')
					.attr('stroke-width',0)
					.attr('transform', 'rotate(0)')
					.style('text-anchor', 'middle');

			// y axis
			var ynode = this.overlaySVG.append('g')
				.call(
					d3.svg.axis()
						.scale(this.yLinear)
						.orient('left')
				)
				.attr('opacity', 1)
				.attr('fill', '#2d2d2d')
				.attr('stroke', '#CC8719')
				.attr('stroke-width', 1);
			ynode.append('text')
					.attr('y', -10)
					.attr('x', -10)
					.text('Daily Stress');
			ynode.selectAll('text')
					.attr('opacity', 1)
					.style('fill', '#CC8719')
					.attr('stroke-width', 0)
					.style('transform', 'translate(-20px, 0)')
					.style('text-anchor', 'middle');

			// y1 axis
			var y1node = this.overlaySVG.append('g')
				.attr('transform', `translate(${this.width}, 0)`)
				.call(
					d3.svg.axis()
						.scale(this.y1Linear)
						.orient('right')
				)
				.attr('fill', '#2d2d2d')
				.attr('stroke', 'red');
			y1node.append('text')
					.attr('y', -10)
					.text('CTL');
			y1node.selectAll('text')
					.attr('opacity', 1)
					.style('fill', 'red')
					.attr('stroke-width', 0)
					.attr('transform', 'rotate(0)')
					.style('transform', 'translate(10px, 0)')
					.style('text-anchor', 'middle');

			this.overlayFocus.append('circle')
				.attr('class', 'y')
				.style('fill', 'none')
				.style('stroke', 'blue')
				.attr('r', 4);

			this.overlaySVG.append('rect')
				.attr('width', this.width)
				.attr('height', this.height)
				.style('fill', 'none')
				.style('pointer-events', 'all')
				.on('mousemove', () => {
					this.overlayFocus.style('display', 'none');
				})
				.on('mouseout', () => {
					this.overlayFocus.style('display', 'none');
				})
				.on('mousemove', () => {
					var x0 = this.xTimer.invert(d3.mouse(this)[0]);
					var i = this.bisectDate(this.overlayData, x0, 1);
					var d0 = this.overlayData[i - 1];
					var d1 = this.overlayData[i];
					var d = x0 - d0.time > d1.time - x0 ? d1 : d0;

					var i2 = this.bisectDate(this.overlayData2, x0, 1);
					var d20 = this.overlayData2[i2 - 1];
					var d21 = this.overlayData2[i2];
					var d2 = x0 - d20.time > d21.time - x0 ? d21 : d20;

					// d3.selectAll('path', '')
					// 	.transition()
					// 	.duration(10) 
					// 	.style('opacity', 1);

					// d3.select(`#tag${d.run}`, '')
					// 	.transition()
					// 	.duration(50) 
					// 	.style('opacity', 1);

					this.overlayFocus.select('circle.y')
						.attr(
							'transform',
							`translate(${this.xTimer(d.time)}, ${this.y1Linear(d.total_stress)})`
						);

					this.overlayTip.transition()
						.duration(100)
						.style('opacity', 0.9);

					var dayOfRun = moment(d.time).format('MMMM Do');
					this.overlayTip.html(
						`<a href="/powercenter/run/${d.id}">${dayOfRun}</a><br/><p>Positive Training: ${d2.ctl}</p>`
					)
					.style('left', `${d3.event.layerX - 50}px`);
				});
		}
		// router: function (e) {
		// 	var target = e.target;
		// 	while (target.dataset.view === undefined) {
		// 		target = target.parentElement;
		// 	}
		// 	this.querySelector('[data-view].active').classList.remove('active');
		// 	target.classList.add('active');

		// 	this.querySelector('[data-holder].active').classList.remove('active');
		// 	this.querySelector(`[data-holder="${target.dataset.view}"]`).classList.add('active');
		// }
	});
	</script>
</dom-module