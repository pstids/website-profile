<dom-module id="performance-management">
	<style>
		:host {
			@apply(--layout-vertical);
			font-family: "Stryd", sans-serif;
			background-color: #222222;
		}
		h1.header {
			@apply(--header);
		}
		.title {
			padding: 20px;
			@apply(--layout-end);
		}
		.bar:hover {
			opacity: 0.66;
		}
		.grid .tick {
			stroke: lightgrey;
			opacity: 0.7;
		}
		.grid path {
			stroke-width: 0;
		}
		.d3-tip {
			line-height: 1;
			font-weight: bold;
			padding: 12px;
			background: rgba(120, 120, 120, 0.8);
			color: #fff;
			border-radius: 2px;
		}
		.d3-tip:after {
			box-sizing: border-box;
			display: inline;
			font-size: 10px;
			width: 100%;
			line-height: 1;
			color: rgba(120, 120, 120, 0.8);
			content: '\25BC';
			position: absolute;
			text-align: center;
		}
		.d3-tip.n:after {
			margin: -1px 0 0 0;
			top: 100%;
			left: 0;
		}
		#svg {
			width: 940px;
			margin: 0 auto;
		}

		.stat-toggle {
			@apply(--layout-center);
			@apply(--layout-justified);
			@apply(--layout-horizontal);
			background-color: var(--primary-background-color);
			border: 2px solid #FFFFFF;
			border-radius: 6px;
			color: #FFFFFF;
			cursor: pointer;
			font-size: 1vw;
			font-weight: 500;
			margin: 0.5vw 1vw 0 0;
			padding: 0.8vw 1.1vw;
			position: relative;
			text-transform: uppercase;
			z-index: 5;
		}
		.stat-toggle .circle {
			width: 1.3vw;
			height: 1.3vw;
			border-radius: 50%;
			border: 3px #FFFFFF solid;
			z-index: 2;
		}
		.stat-toggle .type {
			padding-left: 10px;
		}
		[data-toggle="on"][data-stat="stress"] .circle {
			background-color: #F7A017;
			border-color: #F7A017;
			-webkit-box-shadow: 0px 0px 20px 0px #F7A017;
			-moz-box-shadow: 0px 0px 20px 0px #F7A017;
			box-shadow: 0px 0px 20px 0px #F7A017;
		}
		[data-toggle="on"][data-stat="distance"] .circle {
			background-color: #084784;
			border-color: #084784;
			-webkit-box-shadow: 0px 0px 20px 0px #084784;
			-moz-box-shadow: 0px 0px 20px 0px #084784;
			box-shadow: 0px 0px 20px 0px #084784;
		}
		[data-toggle="on"][data-stat="zones"] .circle {
			background-color: #5ea7a1;
			border-color: #5ea7a1;
			-webkit-box-shadow: 0px 0px 20px 0px #5ea7a1;
			-moz-box-shadow: 0px 0px 20px 0px #5ea7a1;
			box-shadow: 0px 0px 20px 0px #5ea7a1;
		}
	</style>
	<template>
		<div id="demo">
			<div class="layout horizontal title">
				<div class="flex">
					<h1 class="header">Stryd Stress Analysis</h1>
				</div>
				<div class="flex layout horizontal end-justified">
					<div class="stat-toggle"
					data-toggle="on"
					data-stat="stress"
					id="view_stress">
						<div class="circle"></div>
						<div class="type">Stress</div>
					</div>
					<div class="stat-toggle"
					data-toggle="off"
					data-stat="distance"
					id="view_dist">
						<div class="circle"></div>
						<div class="type">Distance</div>
					</div>
					<div class="stat-toggle hidden"
					data-toggle="off"
					data-stat="time"
					id="view_time">
						<div class="circle"></div>
						<div class="type">Time</div>
					</div>
					<div class="stat-toggle"
					data-toggle="off"
					data-stat="zones"
					id="view_zones">
						<div class="circle"></div>
						<div class="type">Time in Zones</div>
					</div>
				</div>
			</div>
			<svg id="stress"></svg>
			<svg id="management"></svg>
		</div>
	</template>
	<script>
	Polymer({
		is: 'performance-management',
		ready: function () {
			this.width = 860;
			this.height = 400;

			this.zBars = 0;
			this.gMode = 0;
			this.gCmd = 0;
			this.max = 0;

			this.weekDays = ['Mon', 'Tues', 'Wed', 'Thur', 'Fri', 'Sat', 'Sun'];
			this.weekNames = ['09/25', '10/02', '10/09', '10/16', '10/23', '10/30', '11/06', '11/13', '11/20', '11/27', '12/04'];

			this.grabData();
		},
		getDayName: function (idx) {
			return this.weekDays[idx % 7];
		},
		getWeekName: function (idx) {
			return this.weekNames[idx];
		},
		fillInit: function () {
			this.graph = d3.select('#stress')
				.attr('width', this.width + 100)
				.attr('height', this.height + 100);

			this.graph.append('svg:g')
				.attr('id', 'barchart')
				.attr('transform', 'translate(50, 50)');

			d3.select('#weekly-stress')
				.on('click', () => {
					if (this.zBars) {
						d3.select('#barchart')
							.selectAll('*')
							.remove();
						this.zBars = 0;
					}
					this.fillBars(this.gMode, 'weeks');
					this.gCmd = 0;
					if (this.gMode === 2) {
						d3.select('#zone-break')
							.style('opacity', 1);
						d3.select('#zone-break')
							.on('click', this.zFun.bind(this));
					}
				});

			d3.select('#view_stress')
				.on('click', this.sFun.bind(this));

			d3.select('#view_dist')
				.on('click', this.dFun.bind(this));

			d3.select('#view_time')
				.on('click', this.tFun.bind(this));

			d3.select('#view_zones')
				.on('click', this.zFun.bind(this));

			this.fillBars(0, 'weeks');
		},
		fillBars: function (key, time) {
			var cmd;
			if (time === 'weeks') {
				cmd = 1;
			} else {
				cmd = 0;
			}

			var data = [];
			var mColor = '';
			var msg2 = '';
			if (key === 0) {
				data = this.getTimeType('stress', time);
				mColor = '#f7a017';
				msg2 = 'Stress';
				this.max = d3.max(data) + 10;
			} else if (key === 1) {
				data = this.getTimeType('distance', time);
				mColor = '#084784';
				msg2 = 'Distance (km)';
				this.max = d3.max(data) + 1;
			} else if (key === 2) {
				data = this.getTimeType('elapsed_time', time);
				mColor = '#5ea7a1';
				msg2 = 'Time (hr)';
				this.max = d3.max(data) + 0.25;
			}

			var x = d3.scale.ordinal()
				.domain(d3.range(data.length))
				.range([0, this.width])
				.rangeBands([0, this.width], 0.3);

			var y = d3.scale.linear()
				.domain([0, this.max])
				.range([this.height, 0]);

			var xAxis = d3.svg.axis()
				.scale(x)
				.tickSize(1)
				.tickPadding(10)
				.orient('bottom')
				.innerTickSize(-this.height)
				.outerTickSize(0);

			if (cmd) {
				xAxis.tickFormat(this.getWeekName.bind(this));
			} else {
				xAxis.tickFormat(this.getDayName.bind(this));
				d3.select('#weekly-stress')
					.style('opacity', 1);
			}

			var yAxis = d3.svg.axis()
				.scale(y)
				.tickSize(1)
				.tickPadding(10)
				.tickFormat(d3.format('.0f'))
				.orient('left')
				.innerTickSize(-this.width)
				.outerTickSize(0);

			d3.selectAll('.d3-tip')
				.remove();
			
			var tip = d3.tip()
				.attr('class', 'd3-tip')
				.offset([-10, 0])
				.html((d) => {
					d = parseInt(d);
					var msg = '';
					if (key === 0) {
						msg = `<div class="float-tag">Stress</div><div class="float-value">${d} RSS</div>`;
					} else if (key === 1) {
						msg = `<div class="float-tag">Distance</div><div class="float-value">${d} KM</div>`;
					} else if (key === 2) {
						msg = `<div class="float-tag">Time</div><div class="float-value">${d} HR</div>`;
					}
					if (!cmd) {
						var id = '1';
						return `${msg}<a href="https://www.stryd.com/powercenter/run/${id}" target="_blank"><span style="color:rgb(236,176,31)">Click for run</span>`;
					} else {
						return msg;
					}
				});

			var vis = d3.select('#barchart');
			vis.call(tip);

			d3.selectAll('.axis').remove();

			vis.insert('g', ':first-child')
				.attr('class', 'x axis')
				.attr('transform', `translate(0, ${this.height})`)
				.call(xAxis)
				.attr('opacity', 1)
				.attr('fill', '#2d2d2d')
				.attr('stroke', '#2d2d2d')
				.attr('stroke-width', 0)
				.selectAll('text')
					.attr('opacity', 1)
					.attr('fill', '#727272')
					.attr('stroke-width',0)
					.attr('transform', 'rotate(0)')
					.style('text-anchor', 'middle');

			vis.insert('g', ':first-child')
				.attr('class', 'y axis')
				.call(yAxis)
				.attr('stroke-width', 1)
				.attr('stroke', '#2d2d2d')
				.attr('fill', '#2d2d2d')
				.attr('opacity', 1)
				.append('text')
					.attr('y', -10)
					.text(msg2)
					.attr('stroke-width', 1)
					.attr('color', '#727272')
					.attr('stroke', '#727272')
					.attr('fill', '#727272');

			vis.select('.y.axis').selectAll('text')
				.attr('stroke', '#727272')
				.attr('fill', '#727272')
				.attr('color', '#727272');

			var bars = vis.selectAll('.bar')
				.data(data);

			//update
			bars.attr('fill', mColor)
				.attr('stroke', '#050');

			bars.enter()
				.append('svg:rect')
				.attr('class', 'bar')
				.attr('fill', mColor)
				.attr('opacity', 0.8);

			bars.exit()
				.attr('fill', mColor)
				.transition()
				.duration(300)
				.ease('square')
				.attr('transform', () => {
					return 'translate(100, 0)';
				})
				.remove();

			bars.transition()
				.duration(300)
				.ease('square')
				.attr('width', x.rangeBand())
				.attr('height', (d) => {
					return this.height - y(d);
				})
				/* unused: d */
				.attr('x', (d, i) => {
					return 2*(x(i) - x(3));
				})
				.attr('y', (d) => {
					return y(d);
				})
				/* unused: d */
				.attr('transform', (d, i) => {
					var first = -x(i)+2*x(3);
					return `translate(${first}, 0)`;
				});

			if (cmd) {
				console.log('CMD = 1');
				bars.on('click', (d, i) => {
					console.log(d, i);
					this.gCmd = 1;
					this.fillBars(this.gMode, 'days');
				})
				.on('mouseover', tip.show)
				.on('mouseout', tip.hide);
			} else {
				this.gCmd = 1;
				console.log('CMD = 0');
				bars.on('click', () => {
					console.log('clicked');
				}).on('mouseover', tip.show);
			}
		},
		sFun: function () {
			var vis = d3.select('#barchart');
			vis.selectAll('.stack').remove();
			if (this.gCmd) {
				this.fillBars(0, 'days');
			} else {
				d3.select('#zone-break')
					.style('opacity', 1);
				this.fillBars(0, 'weeks');
			}
			document.querySelector('[data-toggle="on"]').dataset.toggle = 'off';
			d3.select('#view_stress')
				.on('click', null)
				.attr('data-toggle', 'on');
			d3.select('#view_dist')
				.on('click', this.dFun.bind(this));
			d3.select('#view_time')
				.on('click', this.tFun.bind(this));
			d3.select('#view_zones')
				.on('click', this.zFun.bind(this));
		},
		tFun: function () {
			var vis = d3.select('#barchart');
			vis.selectAll('.stack').remove();
			if (this.gCmd) {
				this.fillBars(2, 'days');
			} else {
				this.fillBars(2, 'weeks');
			}
			document.querySelector('[data-toggle="on"]').dataset.toggle = 'off';
			d3.select('#view_stress')
				.on('click', this.sFun.bind(this));
			d3.select('#view_dist')
				.on('click', this.dFun.bind(this));
			d3.select('#view_time')
				.on('click', null)
				.attr('data-toggle', 'on');
			d3.select('#view_zones')
				.on('click', this.zFun.bind(this));
		},
		dFun: function () {
			var vis = d3.select('#barchart');
			vis.selectAll('.stack').remove();
			if (this.gCmd) {
				this.fillBars(1, 'days');
			} else {
				d3.select('#zone-break')
					.style('opacity', 1);
				this.fillBars(1, 'weeks');
			}
			document.querySelector('[data-toggle="on"]').dataset.toggle = 'off';
			d3.select('#view_stress')
				.on('click', this.sFun.bind(this));
			d3.select('#view_dist')
				.on('click', null)
				.attr('data-toggle', 'on');
			d3.select('#view_time')
				.on('click', this.tFun.bind(this));
			d3.select('#view_zones')
				.on('click', this.zFun.bind(this));
		},
		zFun: function () {
			var vis = d3.select('#barchart');
			vis.selectAll('.bar').attr('opacity',1);
			vis.selectAll('.stack').remove();

			if (!this.gCmd) {
				this.zillBars('weeks');
				//console.log('zillBars');
				this.zBars = 0;
			} else {
				//this.fillBars(2, 'days');
				this.zillBars('days');
				console.log('zillBars');
				this.zBars = 1;
			}

			document.querySelector('[data-toggle="on"]').dataset.toggle = 'off';
			d3.select('#view_stress')
				.on('click', this.sFun.bind(this));
			d3.select('#view_dist')
				.on('click', this.dFun.bind(this));
			d3.select('#view_zones')
				.on('click', this.zFun.bind(this))
				.attr('data-toggle', 'on');
		},
		grabData: function () {
			var srtDate = '09-01-2016';
			var endDate = '12-30-2016';
			var activityEndPoint = `/b/api/v1/activities/calendar?srtDate=${srtDate}&endDate=${endDate}&sortBy=StartDate`;

			superagent
				.get(activityEndPoint)
				.send()
				.set('Accept', 'application/json')
				.set('Authorization', `Bearer: ${jwt.token}`)
				.end((err, res) => {
					if (res.ok) {
						this.processData(res.body.activities);
					} else {
						console.log('Error: failure on grabData', err, res);
					}
				});
		},
		processData: function (activities) {
			this.days = {};
			for (var activity of activities) {
				var hash = moment(activity.timestamp * 1000).format('YYYYMMDD');
				this.days[hash] = activity;
			}
			this.fillInit();
		},
		getTimeType: function (dataType, timeType, idx) {
			if (timeType === 'days') {
				return this.getDayType(dataType, idx);
			} else if (timeType === 'weeks') {
				return this.getWeekType(dataType);
			}
		},
		getDayType: function (dataType, idx) {
			this.timeRange = 10;
			var movingDay = moment().subtract(10, 'weeks');
			var result = [];
			for (var i = 0; i < this.timeRange; i++) {
				var subResult = [];
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (hash in this.days) {
						subResult.push(this.getData(hash, dataType));
					} else {
						subResult.push(0);
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			idx = 1;
			console.log('days', result, idx);
			return result[idx];
		},
		getWeekType: function (dataType) {
			this.timeRange = 10;
			var movingDay = moment().subtract(10, 'weeks');
			var result = [];
			for (var i = 0; i < this.timeRange; i++) {
				var subResult = 0;
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (hash in this.days) {
						subResult += this.getData(hash, dataType);
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			return result;
		},
		getZoneDayType: function (idx) {
			this.timeRange = 10;
			var movingDay = moment().subtract(10, 'weeks');
			var result = [];
			for (var i = 0; i < this.timeRange; i++) {
				var subResult = 0;
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (hash in this.days) {
						subResult.push(this.getData(hash, 'zones'));
					} else {
						subResult.push([0, 0, 0, 0, 0]);
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			console.log('zoneDays', result, idx);
			return result[idx];
		},
		getZoneWeekType: function () {
			this.timeRange = 10;
			var movingDay = moment().subtract(10, 'weeks');
			var result = [];
			for (var i = 0; i < this.timeRange; i++) {
				var subResult = [0, 0, 0, 0, 0];
				for (var o = 0; o < 7; o++) {
					var hash = movingDay.format('YYYYMMDD');
					if (hash in this.days) {
						var tiz = this.getData(hash, 'zones');
						for (var p = 0; p < 5; p++) {
							subResult[p] += tiz[p]/3600;
						}
					}
					movingDay.add(1, 'day');
				}
				result.push(subResult);
			}
			return result;
		},
		getData: function (hash, dataType) {
			if (dataType === 'zones') {
				dataType = 'seconds_in_zones';
			}
			var value = this.days[hash][dataType];
			if (dataType === 'stress') {
				return value;
			} else if (dataType === 'distance') {
				return value / 1000; //km
			} else if (dataType === 'elapsed_time') {
				return value / 3600;
			} else if (dataType === 'seconds_in_zones') {
				if (value === null) {
					return [0, 0, 0, 0, 0];
				}
				return value;
			}
		},
		zillBars: function (time) {
			d3.select('#barchart')
				.selectAll('*')
				.remove();

			var data;
			if (time === 'days') {
				data = this.getZoneDayType(1);
			} else {
				data = this.getZoneWeekType();
			}

			var msg2 = 'Time (hr)';
			this.max = 7.25;

			var xData = [0, 1, 2, 3, 4];
			
			var x = d3.scale.ordinal()
				.domain(d3.range(data.length))
				.range([0, this.width])
				.rangeBands([0, this.width], 0.3);

			var y = d3.scale.linear()
				.domain([0, this.max])
				.range([this.height, 0]);

			var mColors = ['#fce9d2', '#fad3a5', '#f8be78', '#f6a84b', '#f4931f'];

			var xAxis = d3.svg.axis()
				.scale(x)
				.tickSize(0)
				.orient('bottom')
				.innerTickSize(0)
				.outerTickSize(0);

			var yAxis = d3.svg.axis()
				.scale(y)
				.tickSize(1)
				.tickPadding(10)
				.tickFormat(d3.format('.0f'))
				.orient('left')
				.innerTickSize(-this.width)
				.outerTickSize(0);

			d3.selectAll('.d3-tip')
				.remove();

			var tooltip = d3.tip()
				.attr('class', 'd3-tip')
				.offset([-10, 0])
				.html((d) => {
					d = parseInt(d);
					var msg = `<div class="float-tag">Stress</div><div class="float-value">${d} RSS</div>`;
					if (false) {
						var id = '1';
						return `${msg}<a href="https://www.stryd.com/powercenter/run/${id}" target="_blank"><span style="color:rgb(236,176,31)">Click for run</span>`;
					} else {
						return msg;
					}
				});

			var vis = d3.select('#barchart');

			vis.call(tooltip);

			d3.selectAll('.axis').remove();

			vis.insert('g', ':first-child')
				.attr('class', 'x axis')
				.attr('transform', `translate(0, ${this.height})`)
				.call(xAxis)
				.attr('opacity', 1)
				.attr('fill', '#2d2d2d')
				.attr('stroke', '#2d2d2d')
				.attr('stroke-width', 0)
				.selectAll('text')
					.attr('opacity', 1)
					.attr('fill', '#727272')
					.attr('stroke-width',0)
					.attr('transform', 'rotate(0)')
					.style('text-anchor', 'middle');

			vis.insert('g', ':first-child')
				.attr('class', 'y axis')
				.call(yAxis)
				.attr('stroke-width', 1)
				.attr('stroke', '#2d2d2d')
				.attr('fill', '#2d2d2d')
				.attr('opacity', 1)
				.append('text')
					.attr('y', -10)
					.text(msg2)
					.attr('stroke-width', 1)
					.attr('color', '#727272')
					.attr('stroke', '#727272')
					.attr('fill', '#727272');

			vis.select('.y.axis').selectAll('text')
				.attr('stroke', '#727272')
				.attr('fill', '#727272')
				.attr('color', '#727272');

			var iy = 0;
			var dataIntermediate = xData.map(() => {
				return data.map((d) => {
					iy++;
					iy = iy % 10;
					var val = d[iy];
					if (val === undefined) {
						val = 0;
					}
					return {
						x: iy,
						y: val
					};
				});
			});

			var dataStackLayout = d3.layout.stack()(dataIntermediate);

			x.domain(dataStackLayout[0].map((d) => {
				return d.x;
			}));

			var layer = vis.selectAll('.stack')
				.data(dataStackLayout)
				.enter().append('g')
				.attr('class', 'stack')
				/* unused: d */
				.style('fill', function (d, i) {
					return mColors[i];
				});

			var bars = layer.selectAll('rect')
				.data((d) => {
					return d;
				});

			bars.enter()
				.append('rect')
				.attr('x', (d) => {
					return x(d.x);
				})
				.attr('y', (d) => {
					return y(d.y + d.y0);
				})
				.attr('height', (d) => {
					return y(d.y0) - y(d.y + d.y0);
				})
				.attr('width', x.rangeBand())
				.on('mouseover', tooltip.show)
				.on('mouseout', tooltip.hide)
				.on('click', (d, i) => {
					console.log(d, i);
				});

			bars.transition()
				.duration(300)
				.attr('transform', 'translate(0, 0)');
		}
	});
	</script>
</dom-module